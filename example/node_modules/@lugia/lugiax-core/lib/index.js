"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_immutable=require("immutable"),_effects=require("redux-saga/effects"),_redux=require("redux"),_combineReducers2=_interopRequireDefault(require("./combineReducers")),_reduxSaga=_interopRequireDefault(require("redux-saga")),_typeUtils=require("@lugia/type-utils"),_lugiaxCommon=require("@lugia/lugiax-common"),_render=_interopRequireDefault(require("./render"));function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){(0,_defineProperty2.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var ReloadAction="@lugiax/reload",All="@lugia/msg/All",ChangeModel="@lugiax/changeModel",DestroyModel="@lugiax/destroyModel",Loading="@lugiax/Loading",LoadFinished="@lugiax/LoadFinished",RegisterTopic="register",LugiaxImpl=function(){function e(){var t=this;(0,_classCallCheck2.default)(this,e),this.modelName2Mutations=void 0,this.mutationId2Mutaions=void 0,this.mutationId2MutationInfo=void 0,this.existModel=void 0,this.listeners=void 0,this.store=void 0,this.sagaMiddleware=void 0,this.storeEvent=void 0,this.lugiaxEvent=void 0,this.generateAddMutation=function(e,r){return function(n,a){t.checkMutationName(e,n,r);var i=(0,_defineProperty2.default)({},n,a),o=t.generateMutation((0,_defineProperty2.default)({},r,i),e,r);Object.assign(t.modelName2Mutations[e],o)}},this._microfe_=void 0,this.subscribeId=void 0,this.reducerMap=void 0,this.clear(),this.lugiaxEvent=new _lugiaxCommon.Subscribe}return(0,_createClass2.default)(e,[{key:"trigger",value:function(e,t,r){this.storeEvent.trigger(e,t,r),this.storeEvent.trigger(All,t,r)}},{key:"register",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{force:!1};if(e){var n=e.model,a=r.force,i=this.existModel,o=!!i[n];!a&&o&&console.error("".concat(n," is exist!")),this.warnParam(e),e.state||(e=_objectSpread({},e,{state:{}}));var u=e.state;if(o){var s=this._getState_().get(n),d=(0,_immutable.fromJS)(u);this.store.dispatch({type:ReloadAction,newState:d,model:n}),_render.default.trigger((0,_defineProperty2.default)({},n,n)),this.trigger(n,d,s)}i[n]=e,this.replaceReducers(i),this.store.dispatch({type:LoadFinished,model:n});var c=e.mutations,l={addMutation:this.generateAddMutation(n,"sync"),addAsyncMutation:this.generateAddMutation(n,"async")},f=function(){return t._getState_().get(n)};this.emitEvent(RegisterTopic,{model:n,isExist:o,state:u});var h=function(e){return function(){var r=e.model;delete e.model;var n=e.mutations;n&&Object.keys(n).forEach(function(e){n[e]=function(){}}),delete e.mutations,delete e.addMutation,delete e.addAsyncMutation,delete e.getState,delete e.destroy,e.isDestroy=!0,t.store.dispatch({type:DestroyModel,model:r}),delete i[r],t.replaceReducers(i)}};if(this.modelName2Mutations[n]={},!c)return _(this.modelName2Mutations[n]);var m=this.generateMutation(c,n,"sync"),g=this.generateMutation(c,n,"async");return this.modelName2Mutations[n]=Object.assign({},m,g),_(this.modelName2Mutations[n])}function _(e){var t=_objectSpread({mutations:e,model:n},l,{getState:f});return t.destroy=h(t),t}console.error("lugiax.register param must be not undefined!")}},{key:"replaceReducers",value:function(e){var t={lugia:this.lugia.bind(this)};Object.keys(e).forEach(function(r){var n;t[r]=(n=r,function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_immutable.fromJS)(e[n].state),r=arguments.length>1?arguments[1]:void 0;switch(r.type){case ChangeModel:case ReloadAction:var a=r.model,i=r.newState;return a===n?i:t;case DestroyModel:return;default:return t}})}),this.store.replaceReducer(this.combineReducers(t))}},{key:"checkMutationName",value:function(e,t,r){var n=this.modelName2Mutations[e],a="sync"===r?t:this.addAsyncPrefix(t);if(n&&n[a])throw new Error("The ".concat(r," [").concat(e,".").concat(t,"] is exist model!"))}},{key:"warnParam",value:function(e){("mutation"in e||"mutatons"in e)&&console.warn("You may be set mutaions and not muation!"),e.state||console.warn("You may be set state!")}},{key:"generateMutation",value:function(e,t,r){var n=this,a={},i=e[r];return i&&Object.keys(i).forEach(function(e){var o="@lugiax/".concat(t,"/").concat(r,"/").concat(e),u={name:o};n.mutationId2MutationInfo[u.name]={body:i[e],model:t,mutationId:o,type:r};var s="async"===r,d=s?n.addAsyncPrefix(e):e,c=s?function(e){return _regenerator.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_regenerator.default.awrap(n.doAsyncMutation(u,e));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}})}:function(e){return n.doSyncMutation(u,e)};c.mutationType=r,c.mutationId=o,c.model=t,n.mutationId2Mutaions[r][o]=c,a[d]=c}),a}},{key:"addAsyncPrefix",value:function(e){return"async".concat(e.substr(0,1).toUpperCase()).concat(e.substr(1))}},{key:"doAsyncMutation",value:function(e,t){var r,n,a,i,o,u,s,d=this;return _regenerator.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:if(r=e.name,n=this.mutationId2MutationInfo[r],a=n.body,i=n.model,o=n.mutationId,_render.default.beginCall(i),u=this.getModelData(i),!a){c.next=10;break}return this.store.dispatch({type:Loading,model:i}),c.next=8,_regenerator.default.awrap(a(u,t,{mutations:this.modelName2Mutations[i],wait:function(e){return _regenerator.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",d.wait(e));case 1:case"end":return t.stop()}})},getState:function(){return d.getModelData(i)}}));case 8:return s=c.sent,c.abrupt("return",this.updateModel(i,s,o,t,"async"));case 10:return _render.default.endCall(),c.abrupt("return",u);case 12:case"end":return c.stop()}},null,this)}},{key:"wait",value:function(e){var t=this;return new Promise(function(r){t.sagaMiddleware.run(_regenerator.default.mark(function t(){var n,a,i;return _regenerator.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.mutationId,t.next=3,(0,_effects.take)(n);case 3:a=t.sent,i=a.param,r(i);case 6:case"end":return t.stop()}},t)}))})}},{key:"doSyncMutation",value:function(e,t){var r=this,n=e.name,a=this.mutationId2MutationInfo[n],i=a.body,o=a.model,u=a.mutationId;_render.default.beginCall(o);var s=this.getModelData(o);if(i){this.store.dispatch({type:Loading,model:o});var d=i(s,t,{mutations:this.modelName2Mutations[o],getState:function(){return r.getModelData(o)}});if(_typeUtils.ObjectUtils.isPromise(d))throw new Error("state can not be a Promise Object ! ");return this.updateModel(o,d,u,t,"sync")}return _render.default.endCall(),s}},{key:"getModelData",value:function(e){return this._getState_().get(e)}},{key:"updateModel",value:function(e,t,r,n,a){if(!this.existModel[e])throw new Error("$model ( name: {model} )  is not exist!");this.store.dispatch({type:LoadFinished,model:e});var i=this._getState_().get(e);if(t){var o=(0,_immutable.fromJS)(t);this.store.dispatch({type:ChangeModel,model:e,newState:o}),this.trigger(e,o,i),i=this._getState_().get(e)}return this.store.dispatch({type:r,mutationType:a,param:n}),_render.default.endCall(),i}},{key:"getState",value:function(){return this._microfe_&&console.warn("Currently in micro-front-end mode, not recommended!"),this._getState_()}},{key:"_getState_",value:function(){return this.store.getState()}},{key:"subscribe",value:function(e,t){return this.storeEvent.subscribe(e,t)}},{key:"onRender",value:function(e,t){return _render.default.onRender(e,t)}},{key:"resetStore",value:function(e,t){this.createStore(e,t),this.replaceReducers(this.existModel)}},{key:"createStore",value:function(e,t){this.reducerMap=t;var r,n=this.combineReducers({lugia:this.lugia.bind(this)});this.sagaMiddleware=(0,_reduxSaga.default)({}),r=e?(0,_redux.applyMiddleware)(e,this.sagaMiddleware):(0,_redux.applyMiddleware)(this.sagaMiddleware);var a={};"undefined"!=typeof window&&(window.__PRELOADED_STATE__&&(a=window.__PRELOADED_STATE__,delete window.__PRELOADED_STATE__),window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__()&&(r=("object"===("undefined"==typeof window?"undefined":(0,_typeof2.default)(window))&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({shouldHotReload:!1}):_redux.compose)(r)));this.store=(0,_redux.createStore)(n,(0,_immutable.fromJS)(a),r)}},{key:"clear",value:function(){this.storeEvent=new _lugiaxCommon.Subscribe,this.existModel={},this.modelName2Mutations={},this.mutationId2Mutaions={async:{},sync:{}},this.mutationId2MutationInfo={},this.createStore(),_render.default.clear()}},{key:"combineReducers",value:function(e){var t=this.reducerMap;return t?t((0,_combineReducers2.default)(e)):(0,_combineReducers2.default)(e)}},{key:"lugia",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_immutable.fromJS)({loading:{}}),t=arguments.length>1?arguments[1]:void 0,r=t.type,n=t.model;switch(r){case LoadFinished:case Loading:var a=e.get("loading");return a=a.set(n,r===Loading),e=e.set("loading",a);default:return e}}},{key:"subscribeAll",value:function(e){return this.storeEvent.subscribe(All,e)}},{key:"on",value:function(e){var t,r=this;return this.takeEveryAction((t=this,function(n){var a,i,o,u,s;return _regenerator.default.async(function(d){for(;;)switch(d.prev=d.next){case 0:a=n.param,i=n.type,(o=n.mutationType)&&(u=r.mutationId2Mutaions[o][i])&&(s=u.model,e(u,a,{wait:function(e){return _regenerator.default.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",t.wait(e));case 1:case"end":return r.stop()}})},mutations:r.modelName2Mutations[s]}));case 2:case"end":return d.stop()}})}))}},{key:"takeEveryAction",value:function(e){var t;return this.sagaMiddleware.run(_regenerator.default.mark(function r(){var n;return _regenerator.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,(0,_effects.takeEvery)("*",_regenerator.default.mark(function t(r){return _regenerator.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e(r);case 2:case"end":return t.stop()}},t)}));case 2:n=r.sent,t=function(){return n.cancel()};case 4:case"end":return r.stop()}},r)})),{unSubscribe:function(){t&&t()}}}},{key:"emitEvent",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];(t=this.lugiaxEvent).trigger.apply(t,[e].concat(n))}},{key:"onEvent",value:function(e,t){return this.lugiaxEvent.subscribe(e,t)}},{key:"onceEvent",value:function(e,t){var r,n=this.onEvent(e,function(){r&&r(),t&&t.apply(void 0,arguments)});return r=n.unSubscribe,n}},{key:"removeAllEvent",value:function(){this.lugiaxEvent.clear()}},{key:"getStore",value:function(){return this.store}}]),e}(),_default=new LugiaxImpl;exports.default=_default,module.exports=exports.default;