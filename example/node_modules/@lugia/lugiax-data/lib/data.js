"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=_default,exports.createDataOnChange=createDataOnChange,exports.Delete=exports.Change=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_isPlainObject=_interopRequireDefault(require("is-plain-object")),_lugiaxCommon=require("@lugia/lugiax-common"),Change="change";exports.Change=Change;var Delete="delete";exports.Delete=Delete;var arrayFunctionNames=["push","pop","shift","unshift","splice","sort","reverse"];function defineArray(e,r,t){arrayFunctionNames.forEach(function(n){Object.defineProperty(e,n,{get:function(){return function(){for(var a,i=arguments.length,o=new Array(i),l=0;l<i;l++)o[l]=arguments[l];var u=(a=Array.prototype[n]).call.apply(a,[e].concat(o));if("pop"!==n&&"shift"!==n&&"splice"!==n||(u=clone(u)),"push"===n){var f=e.length-1,c=e[f];(0,_isPlainObject.default)(c)&&defineAllKeysProperty(c,[].concat((0,_toConsumableArray2.default)(r),[f]),t),Array.isArray(c)&&defineOneProperty(e,f,r,t)}if("shift"===n||"unshift"===n||"sort"===n||"reverse"===n||"splice"===n)for(var s=0;s<e.length;s++){var y=e[s];(0,_isPlainObject.default)(y)&&defineAllKeysProperty(y,[].concat((0,_toConsumableArray2.default)(r),[s]),t)}return t({path:r,type:Change,params:o?o.map(function(e){return clone(e)}):o,isArray:!0,operator:n}),u}}})})}function defineDelete(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=arguments.length>2?arguments[2]:void 0;Object.defineProperty(e,"$delete",{configurable:!0,get:function(){return function(n){var a=Array.isArray(e);a&&"number"==typeof n?e.splice(n,1):(delete e[n],t({type:Delete,isArray:a,path:[].concat((0,_toConsumableArray2.default)(r),[null==n?String(n):n])}))}}})}function defineSet(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=arguments.length>2?arguments[2]:void 0;Object.defineProperty(e,"$set",{configurable:!0,get:function(){return function(n,a){var i=null==n,o="number"==typeof n,l=(0,_isPlainObject.default)(e);(i||l&&o)&&(n=String(n));var u=n in e;e[n]=a;var f=[].concat((0,_toConsumableArray2.default)(r),[n]);if(Array.isArray(a))for(var c=0;c<a.length;c++){var s=a[c];(0,_isPlainObject.default)(s)&&defineAllKeysProperty(s,[].concat((0,_toConsumableArray2.default)(f),[c]),t)}defineOneProperty(e,n,r,t);var y=Array.isArray(e);(!u||y||o)&&t({path:f,value:clone(a),isArray:y,type:Change})}}})}function defineAllKeysProperty(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=arguments.length>2?arguments[2]:void 0;defineSet(e,r,t),defineDelete(e,r,t),Object.keys(e).forEach(function(n){defineOneProperty(e,n,r,t)})}function defineOneProperty(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3?arguments[3]:void 0,a=Array.isArray(e);if((0,_isPlainObject.default)(e)||a){var i=e[r],o=[].concat((0,_toConsumableArray2.default)(t),[r]);(0,_isPlainObject.default)(i)?defineAllKeysProperty(i,o,n):Array.isArray(i)&&(defineSet(i,o,n),defineDelete(i,o,n),defineArray(i,o,n)),Object.defineProperty(e,r,{get:function(){return i},set:function(e){i=e,n({path:o,value:clone(e),type:Change,isArray:a})}})}}function clone(e){return(0,_isPlainObject.default)(e)||Array.isArray(e)?JSON.parse(JSON.stringify(e)):e}function _default(e){var r=new _lugiaxCommon.Subscribe;return{state:createDataOnChange(e,function(e){var t=e.type;r.trigger(t,e)}),subscribe:r.subscribe.bind(r)}}function createDataOnChange(e,r){return defineAllKeysProperty(e,[],r),e}