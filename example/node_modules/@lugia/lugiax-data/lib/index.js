"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.computeState=computeState,exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_shortid=_interopRequireDefault(require("shortid")),_immutable=require("immutable"),_data=_interopRequireWildcard(require("./data")),_lugiaxCore=_interopRequireDefault(require("@lugia/lugiax-core"));function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,a)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){(0,_defineProperty2.default)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function computeState(e,t){if(!t)return e;var r=t.type,a=t.path,u=t.value,n=t.operator;if(t.isArray&&n){var i,o=e.getIn(a),l=t.params;return o=(i=o)[n].apply(i,(0,_toConsumableArray2.default)(l)),e.setIn(a,o)}switch(r){case _data.Change:return e.setIn(a,(0,_immutable.fromJS)(u));case _data.Delete:return e.deleteIn(a)}return e}var _default={createData:function(e){e.model;var t=e.state,r=void 0===t?{}:t,a=!1,u=_lugiaxCore.default.register({model:_shortid.default.generate(),state:r,mutations:{sync:{__change__:function(e,t){return a?e:computeState(e,t)}}}}),n=(0,_data.default)(r),i=n.state,o=n.subscribe;u.addDataMutation=function(e,t){u.addMutation(e,function(e,r){return t(e,_objectSpread({},r,{__cb2Data__:function(e){var t=e.newValue,r=e.path;if(null==r)return!1;a=!0;for(var u=i,n=r.split("."),o=n.length,l=0;l<o;l++){var c=n[l];if(c in u||u.$set(c,{}),l===o-1){u.$set(c,t);break}u=u[c]}return a=!1,!0}}))})};var l=u.mutations.__change__,c=function(e){return l(e)},s=o(_data.Change,c).unSubscribe,p=o(_data.Delete,c).unSubscribe;return{model:u,data:i,unSubscribe:function(){s(),p()}}}};exports.default=_default;