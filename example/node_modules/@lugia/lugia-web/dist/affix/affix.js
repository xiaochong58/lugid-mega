"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function i(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,o){return e&&i(t.prototype,e),o&&i(t,o),t}}();exports.getScrollTop=getScrollTop;var _react=require("react"),React=_interopRequireWildcard(_react),_affix=require("../css/affix"),_utils=require("../utils");function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e.default=t,e}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function getScrollTop(){var t=void 0;return window.pageYOffset?t=window.pageYOffset:document.compatMode&&"BackCompat"!=document.compatMode?t=document.documentElement&&document.documentElement.scrollTop:document.body&&(t=document.body.scrollTop),t||0}var OffsetBottom="offsetBottom",OffsetTop="offsetTop",_class=function(){function t(){_classCallCheck(this,t);var d=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return d.addWindowListener=function(){var t=d.props,e=t.offsetTop,o=void 0===e?0:e,i=t.offsetBottom,f=void 0===i?0:i,n=window.innerHeight,r=getScrollTop(),s=d.affix&&(0,_utils.getElementPosition)(d.affix).y,a=d.defaultAffixOffsetTop;d.setFixedForWin({offsetTop:o,offsetBottom:f,winHeight:n,scrollTop:r,affixTop:s,defaultTop:a})},d.addTargetListener=function(){var t=d.props,e=t.offsetTop,o=void 0===e?0:e,i=t.offsetBottom,f=void 0===i?0:i,n=t.target,r=void 0===n?function(){return{}}:n,s=d.affix&&(0,_utils.getElementPosition)(d.affix).y,a=window.innerHeight,l=d.affix&&(0,_utils.getElementPosition)(r()).y,c=r().scrollTop,u=r().getBoundingClientRect(),p=r().offsetHeight;d.setFixedForTarget({affixTop:s,targetTop:l,targetScroll:c,offsetTop:o,winHeight:a,offsetBottom:f,targetRect:u,targetHeight:p})},d.setFixedForWin=function(t){var e=t.offsetTop,o=t.offsetBottom,i=t.winHeight,f=t.scrollTop,n=t.affixTop,r=t.defaultTop;switch(d.getOffsetType()){case OffsetTop:n-f<=e&&d.setState({fixed:!0,offset:e}),e<r-f&&d.setState({fixed:!1});break;case OffsetBottom:var s=d.affix&&(0,_utils.getElementPosition)(d.affix).y,a=d.affix&&d.affix.offsetHeight;i+f-s-a<=o&&d.setState({fixed:!0,offset:o}),r+a<=f+i-o&&d.setState({fixed:!1})}},d.getOffsetType=function(){var t=OffsetTop;return d.isInProps(OffsetTop)||d.isInProps(OffsetBottom)&&(t=OffsetBottom),t},d.getOffsetType=function(){var t=OffsetTop;return d.isInProps(OffsetTop)?OffsetTop:(d.isInProps(OffsetBottom)&&(t=OffsetBottom),t)},d.state={fixed:!1},d}return _inherits(t,React.Component),_createClass(t,[{key:"componentDidMount",value:function(){var t=this,e=this.props.target;this.contentWidth=this.affix&&this.affix.offsetWidth,this.contentHeight=this.affix&&this.affix.offsetHeight,this.defaultAffixOffsetTop=this.affix&&(0,_utils.getElementPosition)(this.affix).y,setTimeout(function(){if(e&&"function"==typeof e)return t.targetDefaultOffsetTop=e()&&(0,_utils.getElementPosition)(e()).y,void e().addEventListener("scroll",t.addTargetListener);t.addWindowListener(),window.addEventListener("scroll",t.addWindowListener)},0)}},{key:"setFixedForTarget",value:function(t){var e=t.affixTop,o=t.targetTop,i=t.targetScroll,f=t.offsetTop,n=t.winHeight,r=t.offsetBottom,s=t.targetRect,a=t.targetHeight,l=this.getOffsetType(),c=this.defaultAffixOffsetTop-this.targetDefaultOffsetTop;switch(l){case OffsetTop:var u=f+i;if(u<=c){this.setState({fixed:!1});break}if(e-o<u){this.setState({fixed:!0,offset:f+s.top});break}break;case OffsetBottom:var p=getScrollTop(),d=this.affix&&this.affix.offsetHeight;(this.state.fixed?e+p:e)+d-(o+a)<=r+i&&this.setState({fixed:!0,offset:n-s.bottom+r}),this.affix.offsetTop-s.top>=c-i&&this.setState({fixed:!1})}}},{key:"getOffsetValue",value:function(){var t=this.state.offset;return _defineProperty({},this.getOffsetType(),t)}},{key:"shouldComponentUpdate",value:function(t,e){var o=this.props.onChange;return e.fixed!==this.state.fixed&&o&&o(e.fixed),!0}},{key:"componentWillUnmount",value:function(){var t=this.props.target;window.removeEventListener("scroll",this.addWindowListener),t&&"function"==typeof t&&t()&&t().removeEventListener("scroll",this.addTargetListener)}},{key:"render",value:function(){var e=this,t=this.props.children,o=this.state.fixed,i=this.contentWidth,f=this.contentHeight;return React.createElement("div",{style:o?{width:i,height:f}:null},React.createElement(_affix.Affix,Object.assign({ref:function(t){return e.affix=t},fixed:o},this.getOffsetValue()),t))}},{key:"isInProps",value:function(t){return t in this.props}}]),t}();exports.default=_class;