"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getHashMark=exports.getPercentValue=exports.isIdInArray=exports.isEmptyObject=exports.isKeyInArray=exports.getIndexInArray=void 0;var _createClass=function(){function r(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}(),_templateObject=_taggedTemplateLiteral(["\n    position: relative;\n    display: inline-block;\n  "],["\n    position: relative;\n    display: inline-block;\n  "]),_react=require("react"),_react2=_interopRequireDefault(_react),_getelement=require("./getelement"),_getelement2=_interopRequireDefault(_getelement),_request=require("./request"),_request2=_interopRequireDefault(_request),_CSSProvider=require("../theme/CSSProvider"),_CSSProvider2=_interopRequireDefault(_CSSProvider);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _taggedTemplateLiteral(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var Container=(0,_CSSProvider2.default)({tag:"div",className:"upload_Container",css:(0,_CSSProvider.css)(_templateObject)}),getIndexInArray=exports.getIndexInArray=function(e,t){return t?e.indexOf(t):-1},isKeyInArray=exports.isKeyInArray=function(e,t){return-1!==getIndexInArray(e,t)},isEmptyObject=exports.isEmptyObject=function(e){return!!e&&0===Object.keys(e).length},isIdInArray=exports.isIdInArray=function(t,e){return!!e.length&&e.some(function(e){return e.hashMark===t})},getPercentValue=exports.getPercentValue=function(e,t){return e&&t?e/t<0?0:1<e/t?100:Math.floor(e/t*100):0},getHashMark=exports.getHashMark=function(){return"lugia"+(new Date).getTime()+Math.round(1e5*Math.random()+1e3)},loop=function(){return!0},Upload=function(){function n(){var e,t,C;_classCallCheck(this,n);for(var a=arguments.length,r=Array(a),o=0;o<a;o++)r[o]=arguments[o];return(t=C=_possibleConstructorReturn(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(r)))).setChoosedFile=function(e){var t=e;C.props.multiple||(t=[e[0]]),C.setStateValue({choosedFile:t},function(){C.startUpload()});var a=C.props.onChange;a&&a(t)},C.getChangeUploadState=function(e,t,a){var r=void 0,o=C.state.fileListDone;if(isIdInArray(a,o))r=C.updateFieldList(o,a,[{target:"status",value:"loading"}]);else{var n=C.props.areaType;r=C.appendFileList(o,{hashMark:a,name:t,areaType:n,status:e,percent:0})}return{classNameStatus:e,fileListDone:r,defaultText:t}},C.startUpload=function(){var e=C.state.choosedFile,t=void 0===e?[]:e,a=t.length;if(!(a<=0)){for(var r=C.state.isAllowUpload,o=C.props,n=o.autoUpload,s=o.limit,i=void 0===s?1/0:s,l=0;l<a&&!(i<=l);l++){var u=void 0,p=t[l].name,d=t[l].hashMark||getHashMark();t[l].hashMark=d,u=n||!n&&r?C.getChangeUploadState("loading",p,d):C.getChangeUploadState("default",p,d),C.setStateValue(Object.assign({},u,{choosedFile:t}))}if(n||r)for(var c=C.props,f=c.url,h=c.withCredentials,g=c.data,v=c.headers,m=c.method,_=void 0===m?"post":m,y=c.dataType,S={url:f,withCredentials:h,data:g,headers:v,method:_,dataType:void 0===y?"json":y},b=0;b<a&&!(i<=b);b++)C.beforeUpload(S,t[b],t[b].hashMark),delete t[b].hashMark}},C.beforeUpload=function(r,e,o){var t=C.props.beforeUpload;t?t(e).then(function(e){if(e.status){var t=C.props.accessKey,a=e.file;t&&t.forEach(function(e){r.data[e]=a[e],delete a[e]}),C.startRequest(r,a,o)}}):C.startRequest(r,e,o)},C.startRequest=function(e,t,a){(0,_request2.default)(Object.assign({},e,{file:t,onSuccess:function(e){C.uploadSuccess(e,t,a)},onFail:function(e){C.uploadFail(e,a)},onProgress:function(e){C.uploadProgress(e,a)},onComplete:function(e){C.uploadComplete(e,a)}}))},C.getResponse=function(e){if(e){var s=[];return e.forEach(function(e){var t=e.areaType,a=e.name,r=e.percent,o=e.status,n=e.url;s.push({areaType:t,name:a,percent:r,status:o,url:n})}),s}},C.uploadSuccess=function(e,t,a){var r=C.state.fileListDone,o=C.updateFieldList(r,a,[{target:"status",value:"done"},{target:"url",value:e.data.url}]);C.setStateValue({classNameStatus:"done",fileListDone:o}),"picture"===C.props.areaType&&C.loadPreviewInfo(t),C.setStateValue({isAllowUpload:!1});var n=C.props.onSuccess;n&&n(e,C.getResponse(r))},C.uploadComplete=function(e,t){var a=C.props.onComplete;a&&a(e.currentTarget.response)},C.uploadProgress=function(e,t){var a=e.loaded,r=e.total,o=getPercentValue(a,r),n=C.state.fileListDone,s=C.updateFieldList(n,t,[{target:"percent",value:o},{target:"status",value:"loading"}]);C.setStateValue({classNameStatus:"loading",fileListDone:s});var i=C.props.onProgress;i&&i({loaded:a,total:r})},C.uploadFail=function(e,t){var a=C.state.fileListDone,r=C.updateFieldList(a,t,[{target:"status",value:"fail"}]);C.setStateValue({classNameStatus:"fail",fileListDone:r});var o=C.props.onFail;o&&o(e)},C.updateFieldList=function(e,a){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return e.forEach(function(t){t.hashMark===a&&r.forEach(function(e){t[e.target]=e.value})}),e},C.appendFileList=function(e,t){return isEmptyObject(t)||e.push(t),e},C.loadPreviewInfo=function(e){var t=new FileReader;t.readAsDataURL(e),t.onloadend=function(){C.setStateValue({previewUrl:t.result}),delete t.onloadend}},C.setDeleteList=function(e){var t=C.state.fileListDone;t.splice(e,1),C.setStateValue({fileListDone:t})},C.setAutoUploadState=function(e){C.state.choosedFile&&C.setStateValue({isAllowUpload:e},C.startUpload)},C.setStateValue=function(e,t){C.setState(Object.assign({},e),function(){t&&t()})},_possibleConstructorReturn(C,t)}return _inherits(n,_react2.default.Component),_createClass(n,[{key:"render",value:function(){var e=this.props.themeProps;return _react2.default.createElement(Container,{themeProps:e},_react2.default.createElement(_getelement2.default,Object.assign({},this.props,this.state,{setChoosedFile:this.setChoosedFile,setAutoUploadState:this.setAutoUploadState,setDeleteList:this.setDeleteList})))}}],[{key:"getDerivedStateFromProps",value:function(e,t){var a=e.defaultTips?e.defaultTips.uploadTips:"请将文件拖到此处";if(!t)return{classNameStatus:"default",defaultText:a,fileListDone:e.fileList||[],isAllowUpload:e.autoUpload};var r=t.classNameStatus,o=t.defaultText,n=t.fileListDone,s=t.isAllowUpload;return{classNameStatus:"classNameStatus"in t?r:"default",defaultText:"defaultText"in t?o:a,fileListDone:"fileListDone"in t?n:e.fileList,isAllowUpload:"isAllowUpload"in t?s:e.autoUpload}}}]),n}();Upload.defaultProps={disabled:!1,areaType:"default",multiple:!1,showFileList:!1,limit:1/0,withCredentials:!1,autoUpload:!0,method:"post",onProgress:loop,onSuccess:loop,onComplete:loop,onFail:loop,onChange:loop,defaultTips:{uploadText:"上传",uploadTips:"请将文件拖到此处",failTips:"文件上传失败请重试",loadingTips:"文件上传中..."}},exports.default=Upload;