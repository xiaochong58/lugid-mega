"use strict";var _class,_temp;Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_item=require("./item"),_item2=_interopRequireDefault(_item);require("../common/shirm");var _themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_react=require("react"),React=_interopRequireWildcard(_react),_objectUtils=require("@lugia/object-utils"),_menu=require("../css/menu"),_ThrottleScroller=require("../scroller/ThrottleScroller"),_ThrottleScroller2=_interopRequireDefault(_ThrottleScroller),_index=require("../consts/index"),_index2=_interopRequireDefault(_index),_empty=require("../empty"),_empty2=_interopRequireDefault(_empty),_trigger=require("../trigger"),_trigger2=_interopRequireDefault(_trigger),_reactDom=require("react-dom"),_addEventListener=require("rc-util/lib/Dom/addEventListener"),_addEventListener2=_interopRequireDefault(_addEventListener),_props7=require("../consts/props"),_contains=require("rc-util/lib/Dom/contains"),_contains2=_interopRequireDefault(_contains),_support=require("../scroller/support"),_utils=require("./utils");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Placeholder={},EmptyData=[],SubMenu=function(){return React.createElement("div",null)},Menu=function(){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return _initialiseProps.call(t),t.state={selectedKeys:(0,_utils.getSelectedKeys)(e,null),expandedPath:(0,_utils.getExpandedPath)(e,null),popupVisible:!1,childData:(0,_utils.getInitChildData)(e,null),expandedPathInProps:(0,_utils.getexpandedPathInProps)(e),indexOffsetY:0,start:0},t.treeData=(0,_utils.getTreeData)(e,"|"),t.updateIsSelect(t.state,t.props),t.updataExpandedData(t.state,t.props),t.allChildData=(0,_utils.getInitAllChildData)(e,t.state),t.level2MenuInstance={},t.SubMenu=React.createRef(),t}return _inherits(n,React.Component),_createClass(n,[{key:"shouldComponentUpdate",value:function(e,t){var n=this.props,a=this.state,r=n.data!==e.data||n.children!==e.children,i=a.selectedKeys!==t.selectedKeys,s=e.theme!==n.theme;(r||i)&&this.updateIsSelect(t,e);var u=t.expandedPath!==a.expandedPath;u&&(this.allChildData=(0,_utils.getInitAllChildData)(e,t),this.updataExpandedData(t,e));var l=t.popupVisible!==a.popupVisible||t.childData!==a.childData;return r||l||n.start!==e.start||n.svThemVersion!==e.svThemVersion||i||u||s}},{key:"render",value:function(){var t=this,e=this.props,n=this.getItems(e),a=e.data,r=void 0===a?[]:a,i=e.autoHeight,s=void 0!==i&&i,u=e.getPartOfThemeProps,l=e.itemHeight,o=e.defaultHeight,d=u("Container",{props:{length:r?r.length:0,itemHeight:l,autoHeight:s,defaultHeight:o}}),c=React.createElement(_menu.MenuContainer,{themeProps:d,level:this.props.level},n);if(!Array.isArray(this.state.childData)||0===this.state.childData.length)return c;var p=this.props,h=p.offsetX,f=p.offsetY,g=this.state.indexOffsetY,v=!(0!==h&&!h),m=(0,_utils.getTargetOrDefaultTarget)(v,h,4),_=!(0!==f&&!f),y=(0,_utils.getTargetOrDefaultTarget)(_,f,g*l),D=this.state,P=D.popupVisible,x=void 0!==P&&P,S=D.childData;return React.createElement(_trigger2.default,{themePass:!0,ref:function(e){return t.trigger=e},align:"rightTop",lazy:!1,offsetX:m,offsetY:y,createPortal:!0,popupVisible:x,popup:this.getPopupMenu(S)},c)}},{key:"getItems",value:function(e){var P=this,t=e.start,n=e.end,a=e.checkedCSS,x=void 0===a?"none":a,S=e.mutliple,r=e.data;if(t=Math.round(t),n=Math.round(n),r&&0<r.length)return this.computeItems(r,t,n,function(e,t){var n=P.props,a=n.valueField,r=n.displayField,i=n.divided,s=n.itemHeight,u=n.marginBottom,l=n.renderSuffixItems,o=e[a],d=e[r],c=e.disabled,p=e.icon,h=e.icons,f=e.divided;if(e===Placeholder)return React.createElement("li",null);var g=P.props,v=g.wrapItem,m=g.separator,_=P.state.expandedPath,y=0===_.length?[]:_[0].split(m),D=React.createElement(_item2.default,Object.assign({key:o,item:e,disabled:c,checkedCSS:x,mutliple:S,divided:f||i,menuItemHeight:s},P.props.getPartOfThemeHocProps("MenuItem"),{isFirst:t,value:d,icon:p,icons:h,marginBottom:u,renderSuffixItems:l,hoverState:-1!==y.indexOf(o)}));return v?v(D,{key:o,value:d}):D});var i=e.children;return i?this.computeItems(i,t,n,function(e){return e}):r&&0!==r.length?void 0:React.createElement(_empty2.default,{themeProps:this.props.getPartOfThemeProps("Container")})}},{key:"computeItems",value:function(e,t,n,a){if(!Array.isArray(e))return e;for(var r=[],i=!0,s=t;s<n;s++){var u=e[s],l=s-t;r.push(this.createMenuItemElement(a(u,i),this.isSelect,u,l)),i=!1}return r}},{key:"fetchExtendProps",value:function(e,t,n,a,r){var i=this.props.mutliple,s=this.onMenuItemEventHandler(e,n,a,r);return e&&t(e)?Object.assign({checked:!0,mutliple:i},s,{disabled:a}):Object.assign({mutliple:i},s,{checked:!1,disabled:a})}},{key:"updateIsSelect",value:function(e,t){this.isSelect=this.createIsSelectFunction(e,t)}},{key:"updataExpandedData",value:function(e,t){this.expandedData=this.createExpandedData(e,t)}},{key:"createExpandedData",value:function(e,t){var n=e.expandedPath;return(0,_utils.getExpandDataOrSelectData)(t,n)}},{key:"updateExpandedPath",value:function(e,t){var n=this.props,a=n.onExpandPathChange;a&&a(t);var r=n.action,i=n.checkedCSS,s=n.level;return!(r!==e||"none"!==i||"expandedPath"in n&&0===s)&&(this.getSetExpandedPath()(t),!0)}},{key:"mapTreeDataAndGetPath",value:function(t){var e=this.props.treeData,n=(void 0===e?[]:e).find(function(e){return t===e.value});if(!n)return[];var a=n.path;return this.getNewPath(a,t)}},{key:"getNewPath",value:function(e,t){var n=e.split("|");return n.push(t),n}},{key:"getSelectedKeysOrExpandedPath",value:function(e,t){return[this.getNewExpandedPathData(e).join(t)]}},{key:"getPopupMenu",value:function(e){var t=0<arguments.length&&void 0!==e?e:[],n=this.props,a=n.action,r=n.checkedCSS,i=n.offsetX,s=n.offsetY,u=n.separator,l=n.level,o=n.onClick,d=n.onMouseEnter,c=n.onExpandPathChange,p=n.onChange,h=n.popupVisible,f=n.displayField,g=n.valueField,v=n.mutliple,m=n.autoHeight,_=n.divided,y=n.renderSuffixItems,D=this.state,P=D.selectedKeys,x=D.expandedPath,S=0===i||i?i:4,M=0===s||s?s:null,b={Szf:{Szf:this.props.getPartOfThemeConfig("SubMenu")}};return React.createElement(SubMenu,{mutliple:v,divided:_,theme:b,viewClass:"Szf",autoHeight:m,displayField:f,valueField:g,popupVisible:h,checkedCSS:r,action:a,separator:u,selectedKeys:P,expandedPath:x,onClick:o,onMouseEnter:d,onChange:p,onExpandPathChange:c,ref:this.SubMenu,data:t,offsetX:S,offsetY:M,level:l+1,pushMenuInstance:this.getPushMenuInstance(),deleteMenuInstance:this.getDeleteMenuInstance(),mouseDownInMenus:this.getMouseDownInMenus(),allChildData:this.getAllChildData(),treeData:this.getTreeData(),setSelectedKeys:this.getSetSelectedKeys(),setExpandedPath:this.getSetExpandedPath(),expandedData:this.getExpandedData(),selectedKeysData:this.getSelectedKeysData(),expandedPathInProps:this.getExpandedPathInProps(),renderSuffixItems:y})}},{key:"getSubMenuTheme",value:function(){var e=this.props,t=e.getPartOfThemeConfig;e.level;return _defineProperty({},_index2.default.Menu,t("SubMenu"))}},{key:"isRoot",value:function(){return 0===this.props.level}},{key:"getTreeData",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.treeData,this.props.treeData)}},{key:"getExpandedData",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.expandedData,this.props.expandedData)}},{key:"getAllChildData",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.allChildData,this.props.allChildData)}},{key:"getSelectedKeysData",value:function(){var e=this.props,t=this.state.selectedKeys,n=void 0===t?[]:t;return(0,_utils.getTargetOrDefaultTargetLazy)(this.isRoot(),function(){return(0,_utils.getExpandDataOrSelectData)(e,n)},function(){return e.selectedKeysData})}},{key:"getMouseDownInMenus",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.mouseDownInMenus,this.props.mouseDownInMenus)}},{key:"getPushMenuInstance",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.pushMenuInstance,this.props.pushMenuInstance)}},{key:"getDeleteMenuInstance",value:function(){return(0,_utils.getTargetOrDefaultTarget)(this.isRoot(),this.deleteMenuInstance,this.props.deleteMenuInstance)}},{key:"forceAlign",value:function(){this.trigger&&this.trigger.getThemeTarget()&&this.trigger.getThemeTarget().forceAlign(),this.SubMenu&&this.SubMenu.current&&this.SubMenu.current.getThemeTarget()&&this.SubMenu.current.getThemeTarget().svtarget.getThemeTarget().scrollerTarget.current.forceAlign()}},{key:"componentDidUpdate",value:function(){0===this.props.level&&this.forceAlign()}},{key:"componentDidMount",value:function(){0===this.props.level&&this.forceAlign(),this.getPushMenuInstance()(this.props.level,this);var e=void 0;this.clickOutsideHandler||(e=document,this.clickOutsideHandler=(0,_addEventListener2.default)(e,"mousedown",this.onDocumentClick)),this.touchOutsideHandler||(e=e||document,this.touchOutsideHandler=(0,_addEventListener2.default)(e,"touchstart",this.onDocumentClick))}},{key:"clearOutsideHandler",value:function(){this.clickOutsideHandler&&(this.clickOutsideHandler.remove(),this.clickOutsideHandler=null),this.touchOutsideHandler&&(this.touchOutsideHandler.remove(),this.touchOutsideHandler=null)}},{key:"componentWillUnmount",value:function(){var e=this.getDeleteMenuInstance();e&&e(this.props.level),this.clearOutsideHandler()}}],[{key:"getDerivedStateFromProps",value:function(e,t){return t?{selectedKeys:(0,_utils.getSelectedKeys)(e,t),expandedPath:(0,_utils.getExpandedPath)(e,t),childData:(0,_utils.getInitChildData)(e,t),popupVisible:(0,_utils.getPopupVisible)(e,t)}:{}}}]),n}();Menu.defaultProps={mutliple:!1,start:0,level:0,displayField:_props7.DisplayField,valueField:_props7.ValueField,end:0,separator:"|",checkedCSS:"none",action:"click",divided:!1,getTheme:function(){return{}}},Menu.displayName=_index2.default.Menu;var _initialiseProps=function(){var h=this;this.createMenuItemElement=function(e,t,n,a){var r=e.key,i=e.props.disabled;return React.cloneElement(e,h.fetchExtendProps(r,t,n,i,a))},this.onMenuItemEventHandler=function(i,s,e,u){if(!i||e)return{};var t,n=h.props,l=n.mutliple,o=n.onClick,d=n.onChange,a=n.limitCount,c=void 0===a?999999:a,p=n.separator;return{onClick:(t=function(e){if(i){h.setState({indexOffsetY:u});var t,n=h.state.selectedKeys;t=n.indexOf(i);var a=h.fetchSelectedKeys({mutliple:l,key:i,separator:p,selectedKeys:n,index:t});if(l)if(a.length>c)return;if(!l)s.children?h.updateExpandedPath("click",a):h.clearExpandedPath();h.getSetSelectedKeys()(a);var r={selectedKeys:[].concat(_toConsumableArray(a))};o&&o(e,r,s),d&&d(r),e.preventDefault(),e.stopPropagation()}},r.toString=function(){return t.toString()},r),onMouseEnter:function(e){var t=h.props.onMouseEnter;if(!0!==l){h.setState({indexOffsetY:u});var n=h.getSelectedKeysOrExpandedPath(i,p);h.updateExpandedPath("hover",n),t&&t(e,s)}},getIndexOffsetY:function(){var e=h.props.getIndexOffsetY;e&&e(u)}};function r(e){return t.apply(this,arguments)}},this.clearExpandedPath=function(){(0,_utils.getTargetOrDefaultTarget)(h.isRoot(),h.state.expandedPathInProps,h.props.expandedPathInProps)||setTimeout(function(){h.updateExpandedPath("click",[]),h.updateExpandedPath("hover",[])},100)},this.fetchSelectedKeys=function(e){var t=e.mutliple,n=e.separator,a=e.key;if(a+="",!t)return h.getSelectedKeysOrExpandedPath(a,n);var r=e.selectedKeys,i=e.index,s=[].concat(_toConsumableArray(r));return-1===i?s.push(a):s.splice(i,1),s},this.getNewExpandedPathData=function(e){return h.isRoot()?[e]:h.mapTreeDataAndGetPath(e)},this.pushMenuInstance=function(e,t){h.level2MenuInstance[e+""]=t},this.deleteMenuInstance=function(e){delete h.level2MenuInstance[e+""]},this.mouseDownInMenus=function(n){var e=h.props.handleIsInMenu,t=Object.values(h.level2MenuInstance).some(function(e){var t=(0,_reactDom.findDOMNode)(e);return!!(t&&t.parentNode&&t.parentNode.parentNode)&&(0,_contains2.default)(t.parentNode.parentNode,n)});return t||setTimeout(function(){h.clearExpandedPath()},100),e&&e(t),t},this.setSelectedKeys=function(e){h.setState({selectedKeys:e})},this.setExpandedPath=function(e){h.setState({expandedPath:e})},this.getSetSelectedKeys=function(){return(0,_utils.getTargetOrDefaultTarget)(h.isRoot(),h.setSelectedKeys,h.props.setSelectedKeys)},this.getSetExpandedPath=function(){return(0,_utils.getTargetOrDefaultTarget)(h.isRoot(),h.setExpandedPath,h.props.setExpandedPath)},this.getExpandedPathInProps=function(){return(0,_utils.getTargetOrDefaultTarget)(h.isRoot(),h.state.expandedPathInProps,h.props.expandedPathInProps)},this.createIsSelectFunction=function(e,t){var n={},a=e.selectedKeys,r=void 0===a?[]:a;"number"==typeof r&&(r=r.toString());var i=t.level,s=t.separator,u=r.length;if(r&&0<u)if(t.mutliple)for(var l=0;l<u;l++)n[r[l]]=!0;else{var o=t.selectedKeysData;if(0===r.length)return function(){};if(-1===(r[0]+"").indexOf(s))n[r[r.length-1]]=!0;else{var d=(0,_utils.getTargetOrDefaultTargetLazy)(h.isRoot(),function(){return(0,_utils.getExpandDataOrSelectData)(t,r)},function(){return o});n[d[i]]=!0}}return function(e){return n[e]}},this.onDocumentClick=function(e){var t=h.getMouseDownInMenus();t&&!t(e.target)&&h.setState({childData:EmptyData,popupVisible:!1})}},Result=(0,_themeHoc2.default)((0,_ThrottleScroller2.default)(Menu,_menu.MenuItemHeight,"Container",["MenuItem","MenuItemWrap"]),_index2.default.Menu,{hover:!0});Result.Placeholder=Placeholder,Result.computeCanSeeCount=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:_menu.DefaultHeight,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:_menu.DefaultMenuItemHeight;return Math.floor((0,_support.getCanSeeCountRealy)(e,t))},SubMenu=(0,_themeHoc2.default)((_temp=_class=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,React.Component),_createClass(e,[{key:"render",value:function(){var t=this,e=this.props,n=e.getPartOfThemeConfig("Szf").SubMenu,a=(0,e.getPartOfThemeHocProps)("Szf"),r=a.viewClass,i=a.theme;return n||(i=(0,_objectUtils.deepMerge)(_defineProperty({},r,{SubMenu:i[r]}),i)),React.createElement(Result,Object.assign({},e,{theme:i,viewClass:r,ref:function(e){return t.svtarget=e}}))}}]),e}(),_class.displayName=_index2.default.SubMenu,_temp),_index2.default.SubMenu,{hover:!0}),exports.default=Result;