"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_Four=require("./Four"),_Four2=_interopRequireDefault(_Four),_DragArea=require("./DragArea"),_DragArea2=_interopRequireDefault(_DragArea),_getZ2=require("../function/getZ"),_initialState=require("../initialState"),_initialState2=_interopRequireDefault(_initialState),_styled=require("../styled"),_utils=require("../function/utils"),_event=require("../function/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var clickLock=_initialState.lockingWayFlag.clickLock,Window=function(){function I(e){_classCallCheck(this,I);var t=_possibleConstructorReturn(this,(I.__proto__||Object.getPrototypeOf(I)).call(this,e));_initialiseProps.call(t),t.box=_react2.default.createRef(),t.dragArea=_react2.default.createRef();var i=(0,_getZ2.getZ)(),n=i.x,o=i.id,a=i.y,r=i.z,s=i.index,h=i.zIndexArr,u=i.upDateZFn,c=_initialState2.default.width,l=_initialState2.default.height,d=e.middle,g=e.x,p=void 0===g?d?void 0:n:g,f=e.y,m=void 0===f?d?void 0:a:f,D=e.z,v=e.width,x=e.height,_=e.maxWidth,k=e.maxHeight,w=e.canScale,y=void 0!==w&&w,b=e.lockDirection,S=(0,_utils.getComponentSize)(v,x,c,l,_,k,y),z=S.newWidth,C=S.newHeight,E=0===h.length?0:Math.max.apply(Math,_toConsumableArray(h));t.state=Object.assign({isAboveLeft:!1,isShow:!1,isHide:!1,zIndex:D||E||r},_initialState2.default,{width:z,height:C,windowWidth:0,x:p,y:m,isDoubleClick:!1,componentIndex:s,id:o,canScale:y,right:null,left:null,lockDirection:b,dragHeight:0,isDidMount:!1}),t.zIndexArr=h,t.upDateZFn=u,t.oldSize={width:0,height:0};var L=e.mouseEvents;return t.mouseEvents=L,t.windowCenter=!1,t}return _inherits(I,_react2.default.Component),_createClass(I,[{key:"componentDidMount",value:function(){this.freshWindowSize(),window.addEventListener("resize",this.freshWindowSize),this.onDragMove=this.mouseEvents.on("onDragMove",this.upDateDrag),this.onDragUp=this.mouseEvents.on("onDragUp",this.upDateDrag),this.onDoubleClick=this.mouseEvents.on("onDoubleClick",this.upDateOnDoubleClick),this.dragOpen=this.mouseEvents.on("drag_open",this.upDateDragOpen),this.borderMove=this.mouseEvents.on("border_move",this.upDateSize),this.borderUp=this.mouseEvents.on("border_up",this.upDateSize),this.upDateIsLock=this.mouseEvents.on("upDate_isLock",this.upDateIsLock),this.shrink=this.mouseEvents.on("shrink",this.upDateSize),this.zIndex=this.mouseEvents.on("upDate_zIndex",this.upDateZIndex),this.lockupDateZ=this.mouseEvents.on("lockupDateZIndex",this.lockupDateZIndex),this.upDateDragHeight=this.mouseEvents.on("upDateDragHeight",this.upDateDragHeightFun)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.freshWindowSize),this.onDragMove.removeListener(),this.onDragUp.removeListener(),this.dragOpen.removeListener(),this.borderMove.removeListener(),this.borderUp.removeListener(),this.upDateIsLock.removeListener(),this.zIndex.removeListener(),this.lockupDateZ.removeListener(),this.onDoubleClick.removeListener(),this.upDateDragHeight.removeListener()}},{key:"shouldComponentUpdate",value:function(e,t){var i=this,n=t.width,o=t.height,a=t.windowWidth,r=t.windowHeight,s=t.right,h=t.left,u=t.isDidMount,c=e.lockDirection,l=e.lockTop,d=e.minHeight,g=e.minWidth,p=e.maxWidth,f=void 0===p?a:p,m=e.maxHeight,D=void 0===m?r:m,v=e.lockingWay,x=e.isLock,_=e.x,k=e.y,w=e.middle,y={node:this.box,minWidth:g,minHeight:d,maxWidth:f,maxHeight:D},b="string"==typeof n?0:n,S="string"==typeof o?0:o;"auto"===n&&setTimeout(function(){var e=(0,_event.getNodeSize)(y).w;b=e,i.setState({width:e})},0),"auto"===o&&setTimeout(function(){var e=(0,_event.getNodeSize)(y).h;S=e,i.setState({height:e})},0);var z=(0,_utils.getLockingWay)(v).isDrag;return!w||x||this.windowCenter||"auto"===n||"auto"===o||(this.setState({x:_||(a-b)/2,y:k||(r-S)/2}),this.windowCenter=!0),x&&z&&(null===s&&"right"===c&&a&&"auto"!==b&&this.setState({right:"right:0px",x:a-b,y:l}),null===h&&"left"===c&&this.setState({x:0,y:l,left:"left:0px"})),u||this.setState({isDidMount:!0}),!0}},{key:"render",value:function(){var e=this.state,t=e.windowWidth,i=e.windowHeight,n=e.zIndex,o=e.width,a=e.height,r=e.x,s=e.y,h=e.isFloat,u=e.right,c=e.left,l=e.lockDirection,d=e.isTransition,g=e.componentIndex,p=e.id,f=e.maxX,m=e.maxY,D=e.canScale,v=e.dragHeight,x=e.isDidMount,_=this.props,k=_.children,w=_.isLock,y=_.hasClose,b=_.lockingWay,S=_.width,z=_.height,C=_.canMinimize,E=void 0!==C&&C,L=_.headReverse,I=_.onDragStart,W=_.onDrag,H=_.onDragEnd,O=_.onChangeSizeStart,M=_.onChangeSize,A=_.onChangeSizeEnd,F=_.onChangeLock,Z=_.lockingIcon,j=_.minimizeIcon,q=_.lockTop,R=_.maxWidth,U=void 0===R?t:R,P=_.maxHeight,T=void 0===P?i:P,N=_.minWidth,X=_.minHeight,Y=_.lockBottom,B=_.propsIsLock,G=_.onFixed,J=_.canDoubleClickScale,K=_.head,Q=_.getHeadEvent,V=_.mask,$=_.autoLevel,ee=U<N?t:U,te=T<X?i:T,ie={windowWidth:t,windowHeight:i,width:o,height:a,isLock:w,propsIsLock:B,lockingWay:b,canMinimize:E,headReverse:L,id:p,lockingIcon:Z,minimizeIcon:j,propsWidth:S,propsHeight:z,boxNode:this.box,maxX:f,maxY:m,x:r,y:s,lockTop:q,lockDirection:l,onFixed:G,canDoubleClickScale:J,head:K,getHeadEvent:Q};return _react2.default.createElement(_react2.default.Fragment,null,_react2.default.createElement(_styled.Box,{ref:this.box,width:o,height:a,x:r,left:c,right:u,top:s,zIndex:n,onMouseDown:this.onMouseDown,onClick:this.onClick,isLock:w,isFloat:h,lockDirection:l,lockingWay:b,isTransition:d,minWidth:N,minHeight:X,lockBottom:Y},_react2.default.createElement(_styled.Content,null,_react2.default.createElement(_react2.default.Fragment,null,_react2.default.createElement(_DragArea2.default,Object.assign({ref:this.dragArea,onUp:this.onUp,onOpen:this.onOpen,mouseEvent:this.mouseEvents,onDragStart:I,onDrag:W,onDragEnd:H,onClose:this.onClose,upDateZFn:$&&this.upDateZFn,zIndexArr:this.zIndexArr,componentIndex:g,onChangeLock:F,hasClose:y},ie)),(b!==clickLock||w)&&b===clickLock||h||!D?null:_react2.default.createElement(_Four2.default,_defineProperty({mouseEvent:this.mouseEvents,x:r,y:s,maxX:f,maxY:m,isLock:w,width:o,height:a,minWidth:N,minHeight:X,maxWidth:ee,maxHeight:te,canScale:D,onChangeSizeStart:O,onChangeSize:M,onChangeSizeEnd:A,boxNode:this.box,lockDirection:l},"isLock",w))),_react2.default.createElement(_styled.Children,{isFloat:h,isLock:w,lockingWay:b,dragHeight:v},k))),V&&x?_react2.default.createElement(_styled.Mask,{zIndex:n-1}):null)}}]),I}(),_initialiseProps=function(){var u=this;this.onUp=function(e){var t=u.state,i=t.width,n=t.height;u.setState(Object.assign({},e)),u.oldSize={width:i,height:n},u.upDateEventZindex();var o=u.props.onUp;o&&o({lockDirection:e.lockDirection})},this.onOpen=function(e){var t=u.props.onOpen;t&&t({lockDirection:e.lockDirection,isLock:e.isLock});u.setState(Object.assign({},u.oldSize,e))},this.freshWindowSize=function(){var e=document.body||{},t=e.offsetWidth,i=e.offsetHeight,n=u.state,o=n.width,a=n.height,r=n.x,s=n.y,h=n.isDoubleClick?{width:t,height:i}:{width:o,height:a};u.setState(Object.assign({windowWidth:t,windowHeight:i,x:r,y:s},h,{isTransition:!1,maxX:t,maxY:i})),u.mouseEvents.emit("onFreshWindowSize",Object.assign({x:r,y:s,maxX:t,maxY:i},h))},this.upDateSize=function(e){u.setState(Object.assign({},e))},this.upDateDrag=function(e){u.setState(Object.assign({},e))},this.upDateDragOpen=function(e){var t=e.right,i=e.x;t&&(i=u.state.windowWidth-u.oldSize.width);u.setState(Object.assign({},e,{x:i}))},this.upDateIsLock=function(e){var t=u.props.onChangeLock;t&&t(e)},this.upDateOnDoubleClick=function(e){u.setState(Object.assign({},e))},this.upDateZIndex=function(e){var t=e.z+2;(0,u.upDateZFn)(u.state.componentIndex,t),u.setState({zIndex:t})},this.lockupDateZIndex=function(e){var t=e.z;u.setState({zIndex:t})},this.onMouseDown=function(e){u.props.isLock||u.upDateEventZindex()},this.upDateEventZindex=function(){if(u.props.autoLevel){var e=u.zIndexArr,t=u.upDateZFn,i=u.state.componentIndex,n=Math.max.apply(Math,_toConsumableArray(e));if(!u.getMaxZ()){var o=n+1;t(i,o),u.setState({zIndex:o})}}},this.getMaxZ=function(){var e=u.zIndexArr,t=u.state.zIndex,i=Math.max.apply(Math,_toConsumableArray(e)),n=0;return e.forEach(function(e){e===i&&(n+=1)}),t===i&&1===n},this.onClick=function(e){},this.onClose=function(){var e=u.props,t=e.dom,i=e.onClose;t&&(0,_reactDom.unmountComponentAtNode)(t),i&&i({isRemove:!0})},this.upDateDragHeightFun=function(e){var t=e.dragHeight;u.setState({dragHeight:t})}};exports.default=Window;