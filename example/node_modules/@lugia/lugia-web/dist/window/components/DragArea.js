"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function o(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_utils=require("../function/utils"),_getZ=require("../function/getZ"),_event=require("../function/event"),_math=require("../function/math"),_initialState=require("../initialState"),_initialState2=_interopRequireDefault(_initialState),_index=require("../../icon/index"),_index2=_interopRequireDefault(_index),_styled=require("../styled");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var floatWidth=_initialState.normalDragFloatSize.floatWidth,floatHeight=_initialState.normalDragFloatSize.floatHeight,DragArea=function(){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));_initialiseProps.call(t);var i=_initialState2.default.isFloat,o=e.id,n=e.lockDirection,a=(0,_getZ.changeFloatTimes)(o,i).changeFloat;return t.Drag=_react2.default.createRef(),t.dragHeight=0,t.changeFloat=a,t.lockDirection=n,t.haveDirection=n,t.state={isDown:!1,isFloat:i,isDoubleClick:!1,right:"",isFixed:!1,isClickBtn:!1},t.onMouseDownClient={downX:0,downY:0},t.xy={x:0,y:0},t.throttle=!1,t.up=!0,t.move=!1,t.moveTimes=0,t.propsSize={},t.propsXY={},t}return _inherits(r,_react2.default.Component),_createClass(r,[{key:"changeFloatFun",value:function(e){var t=this.props.id;this.changeFloat(t,e)}},{key:"getOpenPoint",value:function(){var e=this.resetXY(),t=e.x,i=e.y,o=this.props.maxX,n=this.propsSize.width,a=""!==this.state.right?"right":"left",r=(0,_utils.dragCircle)({x:t,maxX:o,width:n,isFloat:!1,direction:a}),s=r.left,l=r.right;return{x:r.x,y:i,right:l,left:s}}},{key:"componentWillUnmount",value:function(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}},{key:"componentDidMount",value:function(){this.addListener()}},{key:"componentDidUpdate",value:function(){if(this.Drag.current){var e=this.Drag.current.offsetHeight,t=this.props,i=t.mouseEvent,o=t.getHeadEvent;this.dragHeight||(i.emit("upDateDragHeight",{dragHeight:e}),o&&o(this),this.dragHeight=e)}}},{key:"render",value:function(){var e=this.state,t=e.isFloat,i=e.isTransition,o=this.props,n=o.isLock,a=o.headReverse,r=o.head,s=this.getHeadIconNumber(),l=t?null:this.headFloat(),c=t?null:this.headLock();return _react2.default.createElement(_react2.default.Fragment,null,_react2.default.createElement(_styled.DragWrap,{ref:this.Drag},r&&!t?_react2.default.createElement(_styled.Drag,{isFloat:t,isLock:n,onMouseDown:this.onMouseDown,iconNumber:s,onDoubleClick:this.onDoubleClick,height:"auto",width:"100%",display:"block"},_react2.default.createElement("div",null,t?null:r)):_react2.default.createElement(_styled.DragBox,{isFloat:t,isTransition:i},a?l:c,t?_react2.default.createElement(_react2.default.Fragment,null,_react2.default.createElement(_styled.Float,{onMouseDown:this.onMouseDown},_react2.default.createElement(_styled.Image,null))):_react2.default.createElement(_styled.Drag,{isFloat:t,isLock:n,onMouseDown:this.onMouseDown,iconNumber:s,onDoubleClick:this.onDoubleClick},_react2.default.createElement("div",null,t?null:r)),a?c:l)))}}]),r}(),_initialiseProps=function(){var w=this;this.onUpDown=function(){w.setState({isDown:!1})},this.onUpUp=function(){if(!w.state.isFixed){var e=w.props,t=e.onUp,i=e.maxX,o=e.x,n=e.y,a=(0,_utils.dragCircle)({x:o,maxX:i,isFloat:!0}),r=a.left,s=a.right,l=a.x;w.changeFloatFun(!0);var c={isFloat:!0,isTransition:!0},u=w.getFloatOpenLockDirection(s);if(t)t(Object.assign({width:floatWidth,height:floatHeight,y:w.getIsFloatLimtY(!0,"",n),x:l,left:r,right:s},c,{lockDirection:u}));w.setState(Object.assign({isDown:!1},c,{right:s}))}},this.onOpen=function(){var e=w.props,t=e.onOpen,i=e.mouseEvent;w.changeFloatFun(!1);var o=w.getOpenPoint(),n=o.x,a=o.y,r=o.right,s=o.left,l=w.getFloatOpenLockDirection(r),c={x:n,y:w.getLockY(l,a),right:r,left:s,isTransition:!0,lockDirection:l};t&&t({isFloat:!1,lockDirection:l}),i.emit("drag_open",c),w.setState({isDown:!1,isFloat:!1,isTransition:!0})},this.getFloatOpenLockDirection=function(e){var t=w.props.lockingWay;return(0,_utils.getLockingWay)(t).isDrag?e?"right":"left":""},this.resetXY=function(){var e=w.state.right,t=w.propsSize,i=t.width,o=t.height,n=w.propsXY,a=n.x,r=n.y,s=w.props,l=s.maxX,c=s.maxY,u=a,h=r;return e&&(u=l-i),c-r<o&&(h=c-o),{x:u,y:h}},this.onDoubleClick=function(){if(!w.state.isFixed){var e=w.props,t=e.mouseEvent,i=e.windowWidth,o=e.windowHeight,n=e.isLock,a=e.canDoubleClickScale;if(!n&&a){var r=w.state.isDoubleClick;if(r)t.emit("onDoubleClick",Object.assign({},w.oldSize,{isDoubleClick:!1,isTransition:!1}));else{var s=w.propsSize,l=s.width,c=s.height,u=w.propsXY,h=u.x,p=u.y;t.emit("onDoubleClick",{width:i,height:o,x:0,y:0,isDoubleClick:!0,isTransition:!1}),w.oldSize={width:l,height:c,x:h,y:p}}w.setState({isDoubleClick:!r,isTransition:!1})}}},this.onMouseDown=function(e){if(!w.state.isFixed){var t=w.props,i=t.isLock,o=t.lockingWay,n=(0,_utils.getLockingWay)(o).isClick;if(!i||!n){var a=e.clientX,r=e.clientY;w.onMouseDownClient={downX:a,downY:r},w.setState({isDown:!0}),w.up=!1;var s=w.props,l=s.width,c=s.height,u=s.x,h=s.y;w.propsSize={width:l,height:c},w.propsXY={x:u,y:h},w.currentlockDirection=w.lockDirection,w.onDragStart({x:u,y:h,lockDirection:w.lockDirection,isLock:i})}}},this.onDragStart=function(e){var t=w.props.onDragStart;t&&t(Object.assign({},e))},this.onMouseMove=function(e){if(!w.props.propsIsLock){var t=w.state,i=t.isDown,o=t.isFixed,n=w.moveEqualDown(e);if(!(!i||w.up||o||n||w.throttle)){w.throttle=!0,w.move=!0;var a=w.props,r=a.windowWidth,s=a.windowHeight,l=a.isLock,c=a.lockingWay,u=a.lockTop,h=(0,_utils.getLockingWay)(c).isDrag,p=(0,_utils.dragRange)(e,h,u,r,s),d=p.currentX,g=p.currentY,f=p.lockDirection;l&&h&&w.intoFatherContainer(),f&&(w.haveDirection=f),setTimeout(function(){w.lockDirection=f,w.movePosition(d,g,f,h),w.throttle=!1},20)}}},this.moveEqualDown=function(e){var t=e.clientX,i=e.clientY,o=w.onMouseDownClient,n=o.downX,a=o.downY;return n===t&&a===i},this.movePosition=function(e,t,i,o){if(!w.up){var n=w.props.mouseEvent,a=w.onMouseDownClient,r=a.downX,s=a.downY,l=w.state.isFloat,c=w.propsXY,u=c.x,h=c.y,p=(0,_utils.getMoveXY)(r,s,e,t),d=p.moveX,g=p.moveY,f=(0,_event.dragXY)(u,h,d,g),m=f.x,v=f.y;w.moveTimes+=1;var D=1===w.moveTimes&&!l&&o?{width:"auto",height:"auto"}:{};n.emit("onDragMove",Object.assign({x:m,y:v,right:"",left:"",isTransition:!1,lockDirection:i},D)),w.xy={x:m,y:v};var k=w.props.onDrag;if(k){var _=l?"":i,y=w.props.zIndexArr,x=void 0===y?[0]:y,F=Math.max.apply(Math,_toConsumableArray(x));k(Object.assign({},w.xy,{clientX:e,clientY:t,lockDirection:_,sideZIndex:F}))}}},this.onMouseUp=function(e){w.up=!0;var t=w.props,i=t.mouseEvent,o=t.x,n=t.y,a=w.state,r=a.isDown,s=a.isFloat,l=w.propsSize,c=l.width,u=l.height;if(r)if(w.setState({isDown:!1}),w.move){if(!w.moveEqualDown(e)){var h=s?"":w.lockDirection,p=w.circleFloatXY(h),d=p.left,g=p.right,f=p.newX,m=p.newY,v=Object.assign({},w.xy,{y:w.getLockY(h,m),x:f}),D=v.x,k=v.y;w.onDragEnd({isUpdata:!0,width:c,height:u,isFloat:s,lockDirection:h,x:D,y:k}),i.emit("onDragUp",{isUpDate:!0,x:D,y:k,right:g,left:d,isDoubleClick:!1,isTransition:!1}),w.setState({isDoubleClick:!1,isTransition:!1,right:g}),w.move=!1}}else s?w.onOpen():w.onDragEnd({isUpdata:!1,width:c,height:u,isFloat:s,lockDirection:w.currentlockDirection,x:o,y:n})},this.onDragEnd=function(e){var t=e.isUpdata,i=e.width,o=e.height,n=e.isFloat,a=e.lockDirection,r=e.x,s=e.y,l=w.props.onDragEnd;l&&(w.lockupDateZIndex(),l({isUpdata:t,width:i,height:o,isFloat:n,lockDirection:a,x:r,y:s}))},this.getLockY=function(e,t){var i=w.props,o=i.lockTop,n=i.lockingWay;return(0,_utils.getLockingWay)(n).isDrag&&e&&(0,_math.isNumber)(o)?o:t},this.lockupDateZIndex=function(){var e=w.props,t=e.id,i=e.lockingWay,o=w.state.isFloat,n=(0,_utils.getLockingWay)(i).isDrag;if(!o&&n&&w.lockDirection){var a=w.changeFloat(t,!1),r=w.props,s=r.upDateZFn,l=r.zIndexArr,c=r.mouseEvent,u=r.componentIndex,h=Math.min.apply(Math,_toConsumableArray(l)),p=a?h-1:h+1;s&&s(u,p),c.emit("lockupDateZIndex",{z:p})}},this.circleFloatXY=function(e){var t=w.xy,i=t.x,o=t.y,n=w.state.isFloat,a=w.props.maxX,r=w.propsSize.width,s=(0,_utils.dragCircle)({x:i,maxX:a,isFloat:n,direction:e,width:r});return{left:s.left,right:s.right,newX:s.x,newY:w.getIsFloatLimtY(n,e,o)}},this.getIsFloatLimtY=function(e,t,i){var o=w.props.maxY-floatHeight-1;return t?0:e?Math.max(1,Math.min(i,o)):i},this.addListener=function(){document.addEventListener("mousemove",w.onMouseMove),document.addEventListener("mouseup",w.onMouseUp)},this.intoFatherContainer=function(){var e=w.props.mouseEvent,t=w.props.isLock;e.emit("upDate_isLock",{isLock:!t})},this.onClose=function(){var e=w.props.onClose;e&&e()},this.getHeadIconNumber=function(){var e=w.props,t=e.hasClose,i=e.lockingWay,o=e.canMinimize,n=0,a=(0,_utils.getLockingWay)(i).isClick;return(t||a||o)&&(n+=1),n},this.onFixed=function(){var e=!w.state.isFixed;w.setState({isFixed:e});var t=w.props.onFixed;t&&t({isFixed:e})},this.headLock=function(){var e=w.state,t=e.isFloat,i=e.isFixed,o=w.props,n=o.lockingWay,a=o.headReverse,r=o.canMinimize,s=o.isLock,l=o.lockingIcon,c=o.minimizeIcon,u=o.onFixed,h=(0,_utils.getLockingWay)(n).isClick,p=h&&s||!r,d="onFixed"in w.props&&"function"==typeof u,g={onMouseDown:p?null:w.onUpDown,onMouseUp:p?null:w.onUpUp,disableUp:p,isFloat:t,isLock:s,headReverse:a,iconClass:c||"lugia-icon-reminder_minus"},f={onClick:w.intoFatherContainer,isFloat:t,headReverse:a,iconClass:l||"lugia-icon-financial_tag"},m={onClick:w.onFixed,isFloat:t,isFixed:i,headReverse:a,iconClass:"lugia-icon-financial_pin"},v=p?null:w.iconComponent(g),D=h?w.iconComponent(f):null,k=d&&!s?w.iconComponent(m):null;return _react2.default.createElement(_react2.default.Fragment,null,a?null:k,a?v:D,a?D:v,a?k:null)},this.headFloat=function(){var e=w.state.isFloat,t=w.props,i=t.isLock,o=t.hasClose,n=t.headReverse,a={onClick:w.onClose,isFloat:e,isLock:i,headReverse:n,iconClass:"lugia-icon-reminder_close"};return o?w.iconComponent(a):null},this.iconComponent=function(e){var t=e.iconClass,i=e.isFixed;return _react2.default.createElement(_styled.Close,Object.assign({},e,{isChecked:i}),_react2.default.createElement(_index2.default,{iconClass:t}))}};exports.default=DragArea;