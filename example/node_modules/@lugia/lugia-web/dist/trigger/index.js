"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function i(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),e}}();require("../common/shirm");var _react=require("react"),React=_interopRequireWildcard(_react),_reactDom=require("react-dom"),_contains=require("rc-util/lib/Dom/contains"),_contains2=_interopRequireDefault(_contains),_addEventListener=require("rc-util/lib/Dom/addEventListener"),_addEventListener2=_interopRequireDefault(_addEventListener),_Popup=require("./Popup"),_Popup2=_interopRequireDefault(_Popup),_themeProvider=require("../theme-provider"),_themeProvider2=_interopRequireDefault(_themeProvider),_index=require("../consts/index"),_index2=_interopRequireDefault(_index);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t.default=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function noop(){}function returnDocument(){return window.document}var ALL_HANDLERS=["onClick","onMouseDown","onTouchStart","onMouseEnter","onMouseLeave","onFocus","onBlur","_onClick"],Trigger=function(){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));r.getRootDomNode=function(){return(0,_reactDom.findDOMNode)(r)},r.onMouseEnter=function(e){r.fireEvents("onMouseEnter",e),r.delaySetPopupVisible(!0,r.props.mouseEnterDelay)},r.onMouseLeave=function(e){r.fireEvents("onMouseLeave",e),r.delaySetPopupVisible(!1,r.props.mouseLeaveDelay)},r.onPopupMouseEnter=function(){r.clearDelayTimer()},r.onPopupMouseLeave=function(e){e.relatedTarget&&!e.relatedTarget.setTimeout&&r.component&&(0,_contains2.default)(r.component.getPopupDomNode(),e.relatedTarget)||r.delaySetPopupVisible(!1,r.props.mouseLeaveDelay)},r.onFocus=function(e){r.fireEvents("onFocus",e),r.clearDelayTimer(),r.isFocusToShow()&&(r.focusTime=Date.now(),r.delaySetPopupVisible(!0,r.props.focusDelay))},r.onMouseDown=function(e){r.fireEvents("onMouseDown",e),r.preClickTime=Date.now()},r.onTouchStart=function(e){r.fireEvents("onTouchStart",e),r.preTouchTime=Date.now()},r.onBlur=function(e){r.fireEvents("onBlur",e),r.clearDelayTimer(),r.isBlurToHide()&&r.delaySetPopupVisible(!1,r.props.blurDelay)},r.createOnClick=function(i){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"onClick";return function(e){if(r.fireChildrenEvents(i,e),r.fireSelfEvents(n,e),r.focusTime){var t=0;if(r.preClickTime&&r.preTouchTime?t=Math.min(r.preClickTime,r.preTouchTime):r.preClickTime?t=r.preClickTime:r.preTouchTime&&(t=r.preTouchTime),Math.abs(t-r.focusTime)<20)return;r.focusTime=0}r.preClickTime=0,r.preTouchTime=0,e.preventDefault&&e.preventDefault();var o=!r.state.popupVisible;(r.isClickToHide()&&!o||o&&r.isClickToShow())&&r.setPopupVisible(!r.state.popupVisible)}},r.onDocumentClick=function(e){var t=e.target,o=(0,_reactDom.findDOMNode)(r),i=r.getPopupDomNode();(0,_contains2.default)(o,t)||(0,_contains2.default)(i,t)||r.forcePopup||r.close()};var t=e.popupVisible,o=void 0!==t&&t,i=e.defaultPopupVisible;return o="popupVisible"in e?!!o:!!i,r.handlers={},r.state={popupVisible:o},r}return _inherits(n,React.Component),_createClass(n,[{key:"getContainer",value:function(){if(this.popupContainer)return this.popupContainer;var e=this.props,t=e.getPopupContainer,o=e.getDocument,i=document.createElement("div");return i.style.position="releative",i.style.top="0",i.style.left="0",(t?t((0,_reactDom.findDOMNode)(this)):o().body).appendChild(i),this.popupContainer=i}},{key:"getComponent",value:function(){var t=this,e=this.props,o=this.state,i=e.onPopupAlign,n=e.popup,r=e.offsetX,s=e.offsetY,u=e.destroyPopupOnHide,a=e.mask,l=e.zIndex,c=e.align,p=e.getTheme,h=e.className,d={};return this.isMouseEnterToShow()&&(d.onMouseEnter=this.onPopupMouseEnter),this.isMouseLeaveToHide()&&(d.onMouseLeave=this.onPopupMouseLeave),React.createElement(_Popup2.default,Object.assign({getTheme:p,key:"popup",offsetX:r,offsetY:s,className:h,ref:function(e){return t.component=e},destroyPopupOnHide:u,visible:o.popupVisible,align:c,onAlign:i},d,{getRootDomNode:this.getRootDomNode,isMask:a,zIndex:l}),"function"==typeof n?n():n)}},{key:"componentWillReceiveProps",value:function(e,t){var o=e.popupVisible;void 0!==o&&(this.setFirstShow(o),this.setState({popupVisible:o}))}},{key:"componentWillMount",value:function(){var o=this;ALL_HANDLERS.forEach(function(t){o.handlers["fire"+t]=function(e){o.fireEvents(t,e)}})}},{key:"componentDidUpdate",value:function(){var e=this.props.getDocument;if(this.state.popupVisible){var t=void 0;return!this.clickOutsideHandler&&this.isClickToHide()&&(t=e(),this.clickOutsideHandler=(0,_addEventListener2.default)(t,"mousedown",this.onDocumentClick)),void(this.touchOutsideHandler||(t=t||e(),this.touchOutsideHandler=(0,_addEventListener2.default)(t,"touchstart",this.onDocumentClick)))}this.clearOutsideHandler()}},{key:"componentWillUnmount",value:function(){this.clearDelayTimer(),this.clearOutsideHandler(),this.popupContainer&&document.body&&document.body.removeChild(this.popupContainer),this.popupContainer=void 0}},{key:"getPopupDomNode",value:function(){return this.component&&this.component.getPopupDomNode?this.component.getPopupDomNode():null}},{key:"setPopupVisible",value:function(e,t){this.forcePopup=t,this.clearDelayTimer(),this.setFirstShow(e),this.state.popupVisible!==e&&("popupVisible"in this.props||this.setState({popupVisible:e}),this.props.onPopupVisibleChange(e))}},{key:"setFirstShow",value:function(e){!this.isFirstShow&&e&&(this.isFirstShow=e)}},{key:"delaySetPopupVisible",value:function(e,t){var o=this,i=1e3*t;this.clearDelayTimer(),i?this.delayTimer=setTimeout(function(){o.setPopupVisible(e),o.clearDelayTimer()},i):this.setPopupVisible(e)}},{key:"clearDelayTimer",value:function(){this.delayTimer&&(clearTimeout(this.delayTimer),this.delayTimer=null)}},{key:"clearOutsideHandler",value:function(){this.clickOutsideHandler&&(this.clickOutsideHandler.remove(),this.clickOutsideHandler=null),this.touchOutsideHandler&&(this.touchOutsideHandler.remove(),this.touchOutsideHandler=null)}},{key:"createTwoChains",value:function(e){var t=this.props.children.props,o=this.props;return t[e]&&o[e]?this.handlers["fire"+e]:t[e]||o[e]}},{key:"render",value:function(){var e=this.props.children,t=React.Children.only(e),o={};this.isClickToHide()||this.isClickToShow()?(t.type.displayName===""+_index2.default.ThemeWrapWidget+_index2.default.DropMenuButton?o._onClick=this.createOnClick("_onClick"):o.onClick=this.createOnClick("onClick"),o.onMouseDown=this.onMouseDown,o.onTouchStart=this.onTouchStart):(o.onClick=this.createTwoChains("onClick"),o.onMouseDown=this.createTwoChains("onMouseDown"),o.onTouchStart=this.createTwoChains("onTouchStart")),this.isMouseEnterToShow()?o.onMouseEnter=this.onMouseEnter:o.onMouseEnter=this.createTwoChains("onMouseEnter"),this.isMouseLeaveToHide()?o.onMouseLeave=this.onMouseLeave:o.onMouseLeave=this.createTwoChains("onMouseLeave"),this.isFocusToShow()||this.isBlurToHide()?(o.onFocus=this.onFocus,o.onBlur=this.onBlur):(o.onFocus=this.createTwoChains("onFocus"),o.onBlur=this.createTwoChains("onBlur")),o.key="container";var i=this.props.createPortal?(0,_reactDom.createPortal)(this.getComponent(),this.getContainer()):this.getComponent();return React.createElement(React.Fragment,null,React.cloneElement(t,o),this.props.lazy?this.isFirstShow?i:null:i)}},{key:"isClickToShow",value:function(){var e=this.props,t=e.action,o=e.showAction;return-1!==t.indexOf("click")||-1!==o.indexOf("click")}},{key:"isClickToHide",value:function(){var e=this.props,t=e.action,o=e.hideAction;return-1!==t.indexOf("click")||-1!==o.indexOf("click")}},{key:"isMouseEnterToShow",value:function(){var e=this.props,t=e.action,o=e.showAction;return-1!==t.indexOf("hover")||-1!==o.indexOf("mouseEnter")}},{key:"isMouseLeaveToHide",value:function(){var e=this.props,t=e.action,o=e.hideAction;return-1!==t.indexOf("hover")||-1!==o.indexOf("mouseLeave")}},{key:"isFocusToShow",value:function(){var e=this.props,t=e.action,o=e.showAction;return-1!==t.indexOf("focus")||-1!==o.indexOf("focus")}},{key:"isBlurToHide",value:function(){var e=this.props,t=e.action,o=e.hideAction;return-1!==t.indexOf("focus")||-1!==o.indexOf("blur")}},{key:"fireEvents",value:function(e,t){this.fireChildrenEvents(e,t),this.fireSelfEvents(e,t)}},{key:"fireChildrenEvents",value:function(e,t){var o=this.props.children.props[e];o&&o(t)}},{key:"fireSelfEvents",value:function(e,t){var o=this.props[e];o&&o(t)}},{key:"forceAlign",value:function(){this.component.forceAlign()}},{key:"close",value:function(){this.setPopupVisible(!1)}}]),n}();Trigger.defaultProps={getDocument:returnDocument,onPopupVisibleChange:noop,afterPopupVisibleChange:noop,onPopupAlign:noop,mouseEnterDelay:0,mouseLeaveDelay:.1,focusDelay:0,blurDelay:.15,destroyPopupOnHide:!1,popupAlign:{},defaultPopupVisible:!1,mask:!1,action:[],className:"",showAction:[],hideAction:[],lazy:!0,getTheme:function(){return{}}},exports.default=(0,_themeProvider2.default)(Trigger,_index2.default.Trigger);