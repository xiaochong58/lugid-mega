"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}(),_templateObject=_taggedTemplateLiteral(["\n  display: inline-block;\n  vertical-align: top;\n"],["\n  display: inline-block;\n  vertical-align: top;\n"]),_react=require("react"),React=_interopRequireWildcard(_react),_tree=require("../tree"),_tree2=_interopRequireDefault(_tree),_objectUtils=require("@lugia/object-utils"),_dropmenu=require("../dropmenu"),_dropmenu2=_interopRequireDefault(_dropmenu),_menu=require("../menu"),_menu2=_interopRequireDefault(_menu),_tabs=require("../tabs"),_tabs2=_interopRequireDefault(_tabs),_styledComponents=require("styled-components"),_styledComponents2=_interopRequireDefault(_styledComponents),_utils=require("../menu/utils"),_utils2=require("../cascader/utils"),_props9=require("../consts/props"),_navmenu=require("../css/navmenu");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _taggedTemplateLiteral(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var TabPane=_tabs2.default.TabPane,MenuWrap=_styledComponents2.default.div(_templateObject),MenuTree=function(){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));_initialiseProps.call(t),t.state={data:e.data?e.data:[],popupVisible:!1,value:(0,_utils2.getValue)(e,null),expandedPath:(0,_utils2.getInitExpandedPath)(e),activityValue:e.activityValue?e.activityValue:"",tabsPopupVisible:!1,tabsMenuExpandedPath:[],tabsMenuValue:[]},t.activityIndex=-1;var a=e.pathSeparator;return t.treeData=(0,_utils.getTreeData)(t.props,a),t}return _inherits(n,React.Component),_createClass(n,[{key:"shouldComponentUpdate",value:function(e,t){var a=this.props,n=this.state;return n.data!==t.data||n.value!==t.value||n.popupVisible!==t.popupVisible||n.expandedPath!==t.expandedPath||n.activityValue!==t.activityValue||n.tabsPopupVisible!==t.tabsPopupVisible||n.tabsMenuExpandedPath!==t.tabsMenuExpandedPath||n.tabsMenuValue!==t.tabsMenuValue||a.value!==e.value||a.inlineExpandAll!==e.inlineExpandAll||a.data!==e.data||a.inlineType!==e.inlineType||a.mode!==e.mode||a.valueField!==e.valueField||a.displayField!==e.displayField||a.themeStyle!==e.themeStyle||a.separator!==e.separator||a.autoHeight!==e.autoHeight||a.switchAtEnd!==e.switchAtEnd||a.activityValue!==e.activityValue||a.switchIconNames!==e.switchIconNames||a.renderSuffixItems!==e.renderSuffixItems||a.igronSelectField!==e.igronSelectField}},{key:"render",value:function(){return this.getNavMenu()}},{key:"setPopupVisible",value:function(e,t){var a=1<arguments.length&&void 0!==t?t:{};this.setState(Object.assign({popupVisible:e},a))}},{key:"exposeOnChange",value:function(e){var t=this.state.value,a=(void 0===t?[]:t)[0],n=this.props,i=n.onChange,r=n.onSelect,l=n.onClick,u=n.displayField,o=this.getCheckedItem(e),s={value:e,newValue:e,oldValue:a,newItem:o,oldItem:this.getCheckedItem(a),newDisplayValue:o[u]};i&&i(s),r&&r(s),l&&l(s)}},{key:"getCheckedItem",value:function(t){if(!t)return{};var e=this.props.valueField,a=void 0===e?_props9.ValueField:e;return this.treeData.find(function(e){return e[a]===t})}}],[{key:"getDerivedStateFromProps",value:function(e,t){return t?{value:(0,_utils2.getValue)(e,t),expandedPath:t.expandedPath,activityValue:e.activityValue?e.activityValue:t.activityValue}:{}}}]),n}();MenuTree.defaultProps={mode:"inline",valueField:"value",displayField:"text",inlineExpandAll:!0,themeStyle:"light",inlineType:"primary",pathSeparator:"/",separator:"|",switchAtEnd:!0,igronSelectField:"disabled",switchIconNames:{open:"lugia-icon-direction_up",close:"lugia-icon-direction_down"}};var _initialiseProps=function(){var f=this;this.getNavMenu=function(){var e=f.props.mode;return"vertical"===e?f.getVerticalNavMenu():"horizontal"===e?f.getHorizontalNavMenu():f.getInlineNavMenu()},this.getVerticalNavMenu=function(){var e=f.props,t=e.data,a=e.displayField,n=e.valueField,i=e.separator,r=e.autoHeight,l=void 0!==r&&r,u=e.themeStyle,o=e.divided,s=e.renderSuffixItems,p=f.state,d=p.popupVisible,c=p.value,h=p.expandedPath;return React.createElement(MenuWrap,null,React.createElement(_menu2.default,Object.assign({},f.getMenuTheme(u),{data:t,separator:i,autoHeight:l,popupVisible:d,valueField:n,displayField:a,action:"hover",divided:o,mutliple:!1,handleIsInMenu:f.handleIsInMenu,onClick:f.handleClickMenu,selectedKeys:c,expandedPath:h,onExpandPathChange:f.onExpandPathChange,renderSuffixItems:s})))},this.onExpandPathChange=function(e){f.setState({expandedPath:e,popupVisible:!0}),f.setPopupVisible(!0,{expandedPath:e})},this.getMenuValue=function(e){var t=f.props.separator,a=e.split(t);return a[a.length-1]},this.handleClickMenu=function(e,t,a){var n=t.selectedKeys;a&&a.children&&0!==a.children.length||f.setPopupVisible(!1,{value:n}),f.exposeOnChange(f.getMenuValue(n[0]))},this.getHorizontalNavMenu=function(){var e=f.getTabsData();if(0===e.length){return React.createElement(_tabs2.default,Object.assign({tabType:"line"},f.getTabsTheme(f.props.themeStyle),{tabPosition:"top",hideContent:!0,data:[{title:"皮卡丘",activityValue:"皮卡丘"},{title:"独角虫",activityValue:"独角虫"},{title:"小拉达",activityValue:"小拉达"},{title:"尼多兰",activityValue:"尼多兰"},{title:"皮皮",activityValue:"皮皮"}]}))}var t=f.state.activityValue;return React.createElement(_tabs2.default,Object.assign({tabType:"line"},f.getTabsTheme(f.props.themeStyle),{tabPosition:"top",hideContent:!0,onTabClick:f.onTabClick,activityValue:f.getActivityValue(t),getTabpane:f.getTabpane}),f.getTabpanes(e))},this.getTabpanes=function(e){var l=[];return e.forEach(function(e,t){var a=e.title,n=e.value,i=e.disabled,r=e.icon;l.push(React.createElement(TabPane,{title:a,onMouseEnter:f.onTabsMouseEnter,value:n,disabled:i,icon:r,suffixIcon:f.isHasChildren(t)?"lugia-icon-direction_down":null}))}),l},this.onTabsMouseEnter=function(e){var t=f.props.action,a=e.index;f.isHasChildren(a)&&"click"!==t&&(f.activityIndex=a)},this.onTabClick=function(e){var t=e.index,a=e.activityValue;if(!f.isHasChildren(t))return f.exposeOnChange(a),void f.setState({activityValue:a});"hover"!==f.props.action&&(f.activityIndex=t)},this.getActivityValue=function(t){var e=f.props,a=e.valueField,n=e.pathSeparator,i=f.treeData.filter(function(e){return t===e[a]})[0];if(!i)return"";var r=i.path;return r?r.split(n)[0]:t},this.getTabpane=function(e,t){var a=f.state.tabsPopupVisible;if(!f.isHasChildren(t))return e;var n=f.getHorizontaMenu(t),i=f.props.action,r=a&&f.activityIndex===t;return React.createElement(_dropmenu2.default,{popupVisible:r,onPopupVisibleChange:f.onTabsPopupVisibleChange,offsetY:4,align:"bottomLeft",menus:n,action:i,hideAction:i},e)},this.onTabsPopupVisibleChange=function(e){"hover"===f.props.action?f.setState({tabsPopupVisible:e,tabsMenuExpandedPath:[]}):setTimeout(function(){f.setState({tabsPopupVisible:e,tabsMenuExpandedPath:[]})},150)},this.getHorizontaMenu=function(e){var t=f.props,a=t.data,n=void 0===a?[]:a,i=t.autoHeight,r=void 0===i||i,l=t.themeStyle,u=n[e].children,o=f.state,s=o.tabsMenuExpandedPath,p=o.tabsMenuValue;return React.createElement(_menu2.default,Object.assign({action:"hover"},f.getTabsMenuTheme(l),{autoHeight:r,data:u,expandedPath:s,onExpandPathChange:f.onTabsMenuExpandPathChange,onClick:f.onClickTabsMenu,selectedKeys:p}))},this.onTabsMenuExpandPathChange=function(e){f.setState({tabsMenuExpandedPath:e})},this.getParentTarget=function(t){var e=f.props,a=e.valueField,n=e.data,i=void 0===n?[]:n,r=e.pathSeparator,l=f.treeData.filter(function(e){return t===e[a]})[0].path.split(r)[0],u=void 0;return i.forEach(function(e,t){e[a]===l&&(u=e)}),u},this.onClickTabsMenu=function(e,t,a){var n=f.props.valueField,i=t.selectedKeys,r=void 0===i?[]:i,l=a.children;if(!l||0===l.length){var u=f.getParentTarget(a[n])[n];f.setState({activityValue:u,tabsMenuValue:r}),f.exposeOnChange(f.getMenuValue(r[0]))}},this.isHasChildren=function(e){var t=f.props.data,a=(void 0===t?[]:t)[e].children;return!!a&&!!a.length},this.getTabsData=function(){var e=f.props,t=e.data,a=void 0===t?[]:t,n=e.displayField,i=void 0===n?_props9.DisplayField:n,r=e.valueField,l=void 0===r?_props9.ValueField:r,u=[];return a.forEach(function(e){var t={};t.title=e[i],t.value=e[l],t.disabled=e.disabled,t.icon=e.icon,u.push(t)}),u},this.mergeTheme=function(e,t){var a=f.props.getPartOfThemeHocProps(e),n=a.viewClass,i=a.theme;return{viewClass:n,theme:(0,_objectUtils.deepMerge)(_defineProperty({},n,Object.assign({},t)),i)}},this.getTabsTheme=function(e){var t=void 0;return t="dark"===e?_navmenu.HorizontalDarkTheme:_navmenu.HorizontalLightTheme,f.mergeTheme("Tabs",t)},this.getTabsMenuTheme=function(e){var t=void 0;return t="dark"===e?_navmenu.DarkTabsMenuTheme:_navmenu.LightTabsMenuTheme,f.mergeTheme("Menu",t)},this.getMenuTheme=function(e){var t=void 0;return t="dark"===e?_navmenu.DarkMenuTheme:_navmenu.LightMenuTheme,f.mergeTheme("Menu",t)},this.getTreeTheme=function(e,t){var a=void 0;return a="ellipse"===e?"dark"===t?_navmenu.EllipseDarkTheme:_navmenu.EllipseLightTheme:"dark"===t?_navmenu.PrimaryDarkTheme:_navmenu.PrimaryLightTheme,f.mergeTheme("Tree",a)},this.getInlineNavMenu=function(){var e=f.state.value,t=f.props,a=t.inlineType,n=t.inlineExpandAll,i=t.valueField,r=t.displayField,l=t.autoHeight,u=void 0===l||l,o=t.themeStyle,s=t.switchIconNames,p=t.renderSuffixItems,d=t.pathSeparator,c=t.switchAtEnd,h=t.igronSelectField,v=f.getTreeTheme(a,o);return React.createElement(MenuWrap,null,React.createElement(_tree2.default,Object.assign({},v,{switchIconNames:s,expandAll:n,switchAtEnd:c,autoHeight:u,showSwitch:!0,__navmenu:!0,inlineType:a,data:f.treeData,value:e,mutliple:!1,valueField:i,displayField:r,onlySelectLeaf:!0,onChange:f.onChange,igronSelectField:h,pathSeparator:d,renderSuffixItems:p})))},this.getExposeItem=function(e){var t={};if(!e)return t;var a=f.props,n=a.valueField,i=void 0===n?"value":n,r=a.displayField,l=void 0===r?"text":r;return t[i]=e[i],t[l]=e[l],t},this.handleIsInMenu=function(e){f.state.popupVisible&&e||setTimeout(function(){f.setState({popupVisible:e})},220)},this.onChange=function(e){var t=e[0];f.exposeOnChange(t),f.setState({value:e})}};exports.default=MenuTree;