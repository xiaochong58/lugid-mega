"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.treeDragController=void 0;var _createClass=function(){function o(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,r,t){return r&&o(e.prototype,r),t&&o(e,t),e}}(),_listener=require("@lugia/listener"),_listener2=_interopRequireDefault(_listener),_react=require("react"),_react2=_interopRequireDefault(_react),_tree=require("../../css/tree"),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var TreeDragController=function(){function e(){var s=this;_classCallCheck(this,e),this.createTreeDrag=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=s.createUUid(),t=new _listener2.default,o=new TreeDrag(t);o.uuid=r,s.treeDrags=Object.assign({},s.treeDrags,_defineProperty({},r,o));var n=e.groupKey;return n&&(o.groupKey=n,s.groups[n]?s.groups[n].push(o.uuid):s.groups[n]=[o.uuid]),o},this.getTreeDrag=function(e){return s.treeDrags[e]},this.getGroupAllData=function(){return s.groups},this.getGroupDataByGroupKey=function(e){return s.groups[e]},this.destroyInvalidGroupInfo=function(){Object.keys(s.groups).forEach(function(e){s.groups[e].length<=0&&delete s.groups[e]})},this.deleteGroupRelationship=function(e){var r=e.uuid,t=e.groupKey,o=s.groups[t];if(o){var n=o.indexOf(r);0<=n&&o.splice(n,1),s.destroyInvalidGroupInfo()}},this.destroyTreeDrag=function(e){var r=s.treeDrags[e];r&&(s.deleteGroupRelationship(r),delete s.treeDrags[e])},this.createUUid=function(){for(var e=[],r="0123456789abcdef",t=0;t<36;t++)e[t]=r.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=r.substr(3&Number(e[19])|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},this.createDragCopyDiv=function(){if(s.isDrag&&(document.addEventListener("mousemove",s.documentMouseMove),document.addEventListener("mouseup",s.documentMouseUp),!s.dragCopyListener)){var e=document.createElement("div");window.document.body.appendChild(e);var r=new _listener2.default;s.dragCopyListener=r,_reactDom2.default.render(_react2.default.createElement(DragCopy,{listener:r}),e)}},this.destroyDragCopyDiv=function(){s.dragCopyListener&&(s.dragCopyListener.emit("copyEnd"),document.removeEventListener("mousemove",s.documentMouseMove),document.removeEventListener("mouseup",s.documentMouseUp))},this.documentMouseMove=function(e){var r=e.clientX,t=e.clientY,o=treeDragController.dragNode.node,n=(o=void 0===o?{}:o).props,a=(n=void 0===n?{}:n).title,i=void 0===a?"":a;s.dragCopyListener.emit("copyStart",{top:t+22,left:r,title:i})},this.documentMouseUp=function(){document.removeEventListener("mousemove",s.documentMouseMove),document.removeEventListener("mouseup",s.documentMouseUp),s.previousDragEnd&&s.previousDragEnd(),s.isFirstLeave=!0,s.dragNode=void 0,s.isDrag=!1,s.dragStart=!1,s.oldMousePosition=void 0,s.previousDragEnd=void 0,s.dragCopyListener.emit("copyEnd")},this.isSameGroup=function(e,r){if(s.treeSource===r)return!0;var t=s.getGroupDataByGroupKey(e);return!!t&&t.includes(r)},this.treeDrags={},this.groups={},this.isFirstLeave=!0}return _createClass(e,[{key:"getDragNodeData",value:function(){var e={};if(!this.dragNode)return e;var r=this.dragNode.node,t=(r=void 0===r?{}:r).props,o=t.disabled,n=t.expanded,a=t.isLeaf,i=t.item,s=(i=void 0===i?{}:i).path,u=i.pid,l=i.value;return e={text:i.text,value:l,pid:u,path:s,disabled:o,expanded:n,isLeaf:a,currentNodeIndex:i.currentNodeIndex}}}]),e}(),treeDragController=new TreeDragController,TreeDrag=function(){function r(e){_classCallCheck(this,r),this.nodesInformation={},this.listener=e}return _createClass(r,[{key:"mouseDown",value:function(e){var r=e.clientX,t=e.clientY;if(0===e.button){var o=this.calculationMouseHoverPosition({mouseX:r,mouseY:t}),n=(o||{}).node,a=(n=void 0===n?{}:n).props,i=(a=void 0===a?{}:a).disabled;o&&!i&&(treeDragController.dragNode=o,treeDragController.dragStart=!0,treeDragController.treeSource=this.uuid,treeDragController.oldMousePosition={mouseX:r,mouseY:t})}}},{key:"mouseUp",value:function(e,r){treeDragController.dragStart=!1;var t=e.button;if(treeDragController.isDrag&&0===t){treeDragController.isDrag=!1;var o=this.preName;o&&this.listener.emit(o+"-setDrageState",""),this.listener.emit("copyEnd");var n=!treeDragController.treeSource||treeDragController.treeSource===this.uuid;if(treeDragController.dragStart=!1,treeDragController.isDrag=!1,this.targetNode&&treeDragController.dragNode){var a=this.targetNode,i=a.nodeEmitName,s=a.node.props,u=s.item,l=s.pos,d=a.position,g=u.pid,p=u.path,c=void 0===p?"":p,f=u.currentNodeIndex,v=u.nextNodeIndex,D=u.preNodeIndex,m=u.parentIndex,h=treeDragController.dragNode,C=h.nodeEmitName,y=h.node.props,_=y.item,b=y.translateTreeData,N=_.pid,I=_.path,S=void 0===I?"":I,x=_.currentNodeIndex,E=_.nextNodeIndex,M=_.preNodeIndex;if(!(c.split("/").includes(C)&&n||i===C&&n)){var O={dragInfo:{key:C,pid:N,dragPath:S,data:_},targetInfo:{pid:g,key:i,pos:l,data:u,dropPosition:"dragOver"===d?"in":"dragOverGapTop"===d?"top":"bottom"},dropToGap:"dragOver"!==d,translateTreeData:b,isSelf:n};b||(O.dragInfo=Object.assign({dargCurrentIndex:x,dargNextIndex:E,dargPreIndex:M,data:_},O.dragInfo),O.targetInfo=Object.assign({targetParentIndex:m,targetCurrentIndex:f,targetNextIndex:v,targetPreIndex:D},O.targetInfo)),treeDragController.isSameGroup(this.groupKey,this.uuid)&&r(O),treeDragController.previousDragEnd&&treeDragController.previousDragEnd(),treeDragController.isFirstLeave=!0,treeDragController.oldMousePosition=void 0,treeDragController.treeSource="",treeDragController.dragNode=void 0}}}}},{key:"mouseMove",value:function(e,r,t){var a=this;if(treeDragController.dragStart){var i=e.clientX,s=e.clientY,o=treeDragController.oldMousePosition||{},n=o.mouseX,u=void 0===n?0:n,l=o.mouseY,d=void 0===l?0:l;if(!(Math.abs(u-i)<20&&Math.abs(d-s)<20)&&(treeDragController.isDrag=!0,treeDragController.dragNode)){var g=treeDragController.dragNode.node,p=(g=void 0===g?{}:g).props,c=(p=void 0===p?{}:p).title,f=void 0===c?"":c;if(this.listener.emit("copyStart",{top:s+22,left:i,title:f}),t){var v=treeDragController.dragNode.node;if(v){var D=v.props,m=(D=void 0===D?{}:D).isLeaf,h=D.expanded;!m&&h&&r(v),clearTimeout(this.mouseTimer),this.mouseTimer=setTimeout(function(){if(treeDragController.dragStart){var e=a.calculationMouseHoverPosition({mouseX:i,mouseY:s});if(e){var r=e.nodeEmitName,t=e.position,o=a.preName;a.targetNode=e,o&&a.listener.emit(o+"-setDrageState","");var n=treeDragController.isSameGroup(a.groupKey,a.uuid)?t:"noDrop";r&&t&&a.listener.emit(r+"-setDrageState",n),a.preName=r}}},100)}}}}}},{key:"mouseLeave",value:function(e,r,t,o){if(treeDragController.isDrag&&treeDragController.dragNode){var n=o.isIgnoreDragOut,a=treeDragController.treeSource===this.uuid;clearTimeout(this.mouseTimer),this.listener.emit(this.preName+"-setDrageState",""),this.listener.emit("copyEnd"),this.isShowDargCopyDiv()||n&&a?(treeDragController.dragStart=!1,treeDragController.isDrag=!1):(treeDragController.createDragCopyDiv(),treeDragController.isFirstLeave&&(treeDragController.previousDragEnd=t),treeDragController.isFirstLeave=!1);var i=treeDragController.getDragNodeData();r&&r({mouseEvent:e,nodeData:i})}}},{key:"onMouseEnter",value:function(e,r){var t={};treeDragController.isDrag||(treeDragController.destroyDragCopyDiv(),t=treeDragController.getDragNodeData()),r&&r({mouseEvent:e,nodeData:t})}},{key:"isShowDargCopyDiv",value:function(){var e=treeDragController.getGroupDataByGroupKey(this.groupKey),r=treeDragController.treeSource===this.uuid;return r&&e&&e.length<=1||r&&!e}},{key:"calculationMouseHoverPosition",value:function(e){var c=this,f=e.mouseX,v=e.mouseY;if(!this.nodesInformation)return{};var D=void 0;return Object.keys(this.nodesInformation).some(function(e,r,t){var o=c.nodesInformation[e],n=o.nodeRef,a=o.node,i=n.getBoundingClientRect(),s=i.left,u=i.right,l=i.top,d=i.bottom,g=i.height;if(s<=f&&f<=u&&l<=v&&v<=d){var p=Math.max(.2*g,4);return D={position:v<=l+p?"dragOverGapTop":d-p<=v?"dragOverGapBottom":"dragOver",nodeEmitName:e,node:a},!0}return!1}),D}},{key:"deletetNodeInformation",value:function(e){var r=this.nodesInformation;e&&delete r[e]}},{key:"collectNodeInformation",value:function(e){var r=0<arguments.length&&void 0!==e?e:{},t=r.nodeName,o=r.nodeRef,n=r.node;t&&o&&(this.nodesInformation=this.nodesInformation?Object.assign({},this.nodesInformation,_defineProperty({},t,{nodeRef:o,node:n})):_defineProperty({},t,{nodeRef:o,node:n}))}}]),r}();exports.treeDragController=treeDragController;var DragCopy=function(){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.DragCopy=function(e){r.floatContent=e},r.state={isShow:!1,title:"",position:{top:0,left:0}},r}return _inherits(t,_react2.default.Component),_createClass(t,[{key:"componentDidMount",value:function(){var n=this,e=this.props.listener;e.on("copyStart",function(e){var r=e.top,t=e.left,o=e.title;n.setState({isShow:!0,title:o,position:{top:r,left:t}})}),e.on("copyEnd",function(e){n.setState({isShow:!1,title:""})})}},{key:"render",value:function(){var e=this.state,r=e.isShow,t=e.title,o=e.position,n=o.top,a=void 0===n?0:n,i=o.left,s=void 0===i?0:i;return r&&_react2.default.createElement(_tree.DragCopyWrap,{ref:this.DragCopy,style:{left:s,top:a}},t)}}]),t}();exports.default=DragCopy;