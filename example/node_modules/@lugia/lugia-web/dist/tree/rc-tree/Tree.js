"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.contextTypes=void 0;var _createClass=function(){function r(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,o){return t&&r(e.prototype,t),o&&r(e,o),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_warning=require("warning"),_warning2=_interopRequireDefault(_warning),_util=require("./util"),_drag=require("./drag"),_drag2=_interopRequireDefault(_drag),_tree=require("../../css/tree");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function noop(){}var contextTypes=exports.contextTypes={rcTree:_propTypes2.default.shape({selectable:_propTypes2.default.bool})},Tree=function(){function s(e){_classCallCheck(this,s);var t=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e));_initialiseProps.call(t);var o=e.expandedKeys,r=e.checkedKeys,n=e.halfCheckedKeys,a=e.groupKey;return t.treeDrag=_drag.treeDragController.createTreeDrag({groupKey:a}),t.state={expandedKeys:o,checkedKeys:r,halfCheckedKeys:n,selectedKeys:t.calcSelectedKeys(e),highlight:t.caclcHighLight(e),dragNodesKeys:"",dragOverNodeKey:""},t}return _inherits(s,_react2.default.Component),_createClass(s,[{key:"getChildContext",value:function(){return{rcTree:{selectable:this.props.selectable}}}},{key:"componentWillReceiveProps",value:function(e){var t=this.props,o={},r=e.expandedKeys;r&&(o.expandedKeys=r);var n=e.checkedKeys,a=void 0===n?{}:n,s=e.halfCheckedKeys,p=void 0===s?[]:s;o.checkedKeys=a,o.halfCheckedKeys=p;var i=e.selectedKeys!==t.selectedKeys?this.calcSelectedKeys(e,!0):void 0;i&&(o.selectedKeys=i);var l=e.highlight!==t.highlight?this.caclcHighLight(e,!0):void 0;l&&(o.highlight=l),this.setState(o)}},{key:"componentWillUnmount",value:function(){_drag.treeDragController.destroyTreeDrag(this.treeDrag.uuid)}},{key:"onDragStart",value:function(e,t){this.dragNode=t;var o={dragNodesKeys:this.getDragNodesKeys(t)},r=this.getExpandedKeys(t,!1);r&&(o.expandedKeys=r),this.setState(o),this.props.onDragStart({event:e,node:t})}},{key:"onDragEnter",value:function(t,o){var r=this,e=this.calcDropPosition(t,o);this.dragNode.props.eventKey!==o.props.eventKey||0!==e?(this.setState({dragOverNodeKey:o.props.eventKey,dropPosition:e}),this.delayedDragEnterLogic||(this.delayedDragEnterLogic={}),Object.keys(this.delayedDragEnterLogic).forEach(function(e){clearTimeout(r.delayedDragEnterLogic[e])}),this.delayedDragEnterLogic[o.props.pos]=setTimeout(function(){var e=r.getExpandedKeys(o,!0);e&&r.setState({expandedKeys:e}),r.props.onDragEnter({event:t,node:o,expandedKeys:e&&[].concat(_toConsumableArray(e))||[].concat(_toConsumableArray(r.state.expandedKeys))})},400)):this.setState({dragOverNodeKey:"",dropPosition:null})}},{key:"onDragOver",value:function(e,t){this.props.onDragOver({event:e,node:t})}},{key:"onDragLeave",value:function(e,t){this.props.onDragLeave({event:e,node:t})}},{key:"onDrop",value:function(e,t){var o=this.state,r=t.props.eventKey;if(this.setState({dragOverNodeKey:"",dropNodeKey:r}),-1<o.dragNodesKeys.indexOf(r))(0,_warning2.default)(!1,"Can not drop to dragNode(include it's children node)");else{var n=t.props.pos.split("-"),a={event:e,node:t,dragNode:this.dragNode,dragNodesKeys:[].concat(_toConsumableArray(o.dragNodesKeys)),dropPosition:o.dropPosition+Number(n[n.length-1])};0!==o.dropPosition&&(a.dropToGap=!0),this.props.onDrop(a)}}},{key:"onDragEnd",value:function(e,t){this.setState({dragOverNodeKey:""}),this.props.onDragEnd({event:e,node:t})}},{key:"onExpand",value:function(e){var t=this,o=this.props,r=this.state,n=!e.props.expanded,a=[].concat(_toConsumableArray(r.expandedKeys)),s=e.props.eventKey,p=a.indexOf(s);n&&-1===p?a.push(s):!n&&-1<p&&a.splice(p,1);var i="expandedKeys"in o;if(i||this.setState({expandedKeys:a}),o.onExpand(a,{node:e,expanded:n}),n&&o.loadData)return o.loadData(e).then(function(){i||t.setState({expandedKeys:a})})}},{key:"onSelect",value:function(e,t){var o=this.props,r=this.state,n=e.props.eventKey,a=!e.props.selected,s=[].concat(_toConsumableArray(r.selectedKeys));if(a)o.multiple?s.push(n):s=[n];else{var p=s.indexOf(n);s.splice(p,1)}var i=[];s.length&&(0,_util.traverseTreeNodes)(o.children,function(e){-1!==s.indexOf(e.key)&&i.push(e)}),"selectedKeys"in o||this.setState({selectedKeys:s});var l={event:"select",selected:a,node:e,selectedNodes:i};o.onSelect(s,l,t)}},{key:"onContextMenu",value:function(e,t,o){this.props.onRightClick({event:e,node:t,item:o})}},{key:"getOpenTransitionName",value:function(){var e=this.props,t=e.openTransitionName,o=e.openAnimation;return t||"string"!=typeof o?t:e.prefixCls+"-open-"+o}},{key:"getDragNodesKeys",value:function(a){var s=[],p=a.props.pos.split("-");return(0,_util.traverseTreeNodes)(a.props.children,function(e,t,o,r){var n=o.split("-");(a.props.pos===o||p.length<n.length&&(0,_util.isInclude)(p,n))&&s.push(r)}),s.push(a.props.eventKey||a.props.pos),s}},{key:"getExpandedKeys",value:function(e,t){var o=e.props.eventKey,r=this.state.expandedKeys,n=r.indexOf(o);if(!t&&-1<n){var a=[].concat(_toConsumableArray(r));return a.splice(n,1),a}if(t&&-1===r.indexOf(o))return r.concat([o])}},{key:"generateTreeNodesStates",value:function(e,s){var p=[],i={};return(0,_util.traverseTreeNodes)(e,function(e,t,o,r,n,a){i[o]={node:e,key:r,checked:!1,halfChecked:!1,disabled:e.props.disabled,disableCheckbox:e.props.disableCheckbox,childrenPos:n,parentPos:a},-1!==s.indexOf(r)&&(i[o].checked=!0,p.push(o))}),p.forEach(function(e){(0,_util.updateCheckState)(i,e,!0)}),i}},{key:"calcSelectedKeys",value:function(e,t){var o=e.selectedKeys||(t?void 0:e.defaultSelectedKeys);if(o)return e.multiple?[].concat(_toConsumableArray(o)):o.length?[o[0]]:o}},{key:"caclcHighLight",value:function(e,t){var o=e.highlight||(t?void 0:e.defaulthighlight);if(o)return o}},{key:"calcDropPosition",value:function(e,t){var o=(0,_util.getOffset)(t.selectHandle).top,r=t.selectHandle.offsetHeight,n=e.pageY;return o+r-2<n?1:n<o+2?-1:0}},{key:"renderTreeNode",value:function(e,t,o){var r=2<arguments.length&&void 0!==o?o:0,n=this.state,a=this.props,s=r+"-"+t,p=e.key||s,i={root:this,eventKey:p,pos:s,loadData:a.loadData,prefixCls:a.prefixCls,showIcon:a.showIcon,draggable:a.draggable,expanded:-1!==n.expandedKeys.indexOf(p),selected:-1!==n.selectedKeys.indexOf(p),parentIsHighlight:-1!==a.parentHighlightKeys.indexOf(p),hightLight:-1!==n.highlight.indexOf(p),openTransitionName:this.getOpenTransitionName(),openAnimation:a.openAnimation,filterTreeNode:this.filterTreeNode,treeDrag:this.treeDrag};return a.checkable&&(i.checkable=a.checkable,i.checked=-1!==n.checkedKeys.indexOf(p),i.halfChecked=-1!==n.halfCheckedKeys.indexOf(p)),_react2.default.cloneElement(e,i)}},{key:"render",value:function(){var e=this.props,t=(0,_classnames2.default)(e.prefixCls,e.className,_defineProperty({},e.prefixCls+"-show-line",e.showLine)),o={};e.focusable&&(o.tabIndex="0",o.onKeyDown=this.onKeyDown);var r=e.getPartOfThemeProps,n=e.top;return _react2.default.createElement(_tree.TreeUl,Object.assign({},o,{className:t,role:"tree-node",unselectable:"on",style:e.style,themeProps:r("Container",{props:{top:n}}),onMouseMove:e.draggable&&this.onMouseMove,onMouseLeave:e.draggable&&this.onMouseLeave,onMouseDown:e.draggable&&this.onMouseDown,onMouseUp:e.draggable&&this.onMouseUp,onMouseEnter:e.draggable&&this.onMouseEnter}),_react2.default.createElement(_drag2.default,{listener:this.treeDrag.listener}),_react2.default.Children.map(e.children,this.renderTreeNode,this))}}]),s}();Tree.propTypes={prefixCls:_propTypes2.default.string,children:_propTypes2.default.any,showLine:_propTypes2.default.bool,showIcon:_propTypes2.default.bool,selectable:_propTypes2.default.bool,multiple:_propTypes2.default.bool,checkable:_propTypes2.default.oneOfType([_propTypes2.default.bool,_propTypes2.default.node]),checkStrictly:_propTypes2.default.bool,draggable:_propTypes2.default.bool,autoExpandParent:_propTypes2.default.bool,defaultExpandAll:_propTypes2.default.bool,defaultExpandedKeys:_propTypes2.default.arrayOf(_propTypes2.default.string),expandedKeys:_propTypes2.default.arrayOf(_propTypes2.default.string),defaultCheckedKeys:_propTypes2.default.arrayOf(_propTypes2.default.string),checkedKeys:_propTypes2.default.oneOfType([_propTypes2.default.arrayOf(_propTypes2.default.string),_propTypes2.default.object]),defaultSelectedKeys:_propTypes2.default.arrayOf(_propTypes2.default.string),selectedKeys:_propTypes2.default.arrayOf(_propTypes2.default.string),onExpand:_propTypes2.default.func,onCheck:_propTypes2.default.func,onSelect:_propTypes2.default.func,loadData:_propTypes2.default.func,onMouseEnter:_propTypes2.default.func,onMouseLeave:_propTypes2.default.func,onRightClick:_propTypes2.default.func,onDragStart:_propTypes2.default.func,onDragEnter:_propTypes2.default.func,onDragOver:_propTypes2.default.func,onDragLeave:_propTypes2.default.func,onDrop:_propTypes2.default.func,onDragEnd:_propTypes2.default.func,filterTreeNode:_propTypes2.default.func,openTransitionName:_propTypes2.default.string,openAnimation:_propTypes2.default.oneOfType([_propTypes2.default.string,_propTypes2.default.object])},Tree.childContextTypes=contextTypes,Tree.defaultProps={prefixCls:"rc-tree",showLine:!1,showIcon:!0,selectable:!0,multiple:!1,checkable:!1,checkStrictly:!1,draggable:!1,autoExpandParent:!0,defaultExpandAll:!1,defaultExpandedKeys:[],defaultCheckedKeys:[],defaultSelectedKeys:[],onExpand:noop,onCheck:noop,onSelect:noop,onDragStart:noop,onDragEnter:noop,onDragOver:noop,onDragLeave:noop,onDragEnd:noop,onMouseEnter:noop,onMouseLeave:noop,onRightClick:noop};var _initialiseProps=function(){var p=this;this.onMouseDown=function(e){p.treeDrag.mouseDown(e)},this.onMouseUp=function(e){var t=p.props.onDrop;p.treeDrag.mouseUp(e,function(e){t&&t(e)})},this.onMouseMove=function(e){var t=p.props.onDrop;p.treeDrag.mouseMove(e,function(e){var t={dragNodesKeys:p.getDragNodesKeys(e)},o=p.getExpandedKeys(e,!1);o&&(t.expandedKeys=o),p.setState(t)},t)},this.onMouseLeave=function(e){var t=p.props,o=(t.onMouseLeave,t.onDragLeave),r=t.onDragEnd,n=t.isIgnoreDragOut,a=o;p.treeDrag.mouseLeave(e,a,r,{isIgnoreDragOut:n})},this.onMouseEnter=function(e){var t=p.props.onDragEnter;p.treeDrag.onMouseEnter(e,t)},this.onCheck=function(e,t,o){var r=!e.props.checked||e.props.halfChecked,n=Object.assign({},t,{event:"check",node:e,checked:r}),a=p.props.onCheck,s=p.state.checkKeys;a&&a((void 0===s?{}:s).checkedKeys,n,o)},this.onKeyDown=function(e){e.preventDefault()},this.filterTreeNode=function(e){var t=p.props.filterTreeNode;return"function"==typeof t&&!e.props.disabled&&t.call(p,e)}};exports.default=Tree;