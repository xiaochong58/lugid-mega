"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_rcAnimate=require("rc-animate"),_rcAnimate2=_interopRequireDefault(_rcAnimate),_toArray=require("rc-util/lib/Children/toArray"),_toArray2=_interopRequireDefault(_toArray),_Tree=require("./Tree"),_icon=require("../../icon"),_icon2=_interopRequireDefault(_icon),_checkbox=require("../../checkbox"),_checkbox2=_interopRequireDefault(_checkbox),_objectUtils=require("@lugia/object-utils"),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_tree=require("../../css/tree"),_stateColor=require("../../css/stateColor");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var defaultTitle="---",TreeNode=function(){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return _initialiseProps.call(t),t.state={dataLoading:!1,dragNodeHighlight:!1},t}return _inherits(r,_react2.default.Component),_createClass(r,[{key:"onSelect",value:function(){this.props.root.onSelect(this,this.props.item)}},{key:"onKeyDown",value:function(e){e.preventDefault()}},{key:"isSelectable",value:function(){var e=this.props,t=this.context;return"selectable"in e?e.selectable:t.rcTree.selectable}},{key:"renderSwitch",value:function(e){var t=this.props,r=t.describe,o=t.mutliple,n=t.disabled,i=t.__navmenu,a=t.switchIconNames,s=this.getSwitchIconTheme(e),l=s.viewClass,c=s.theme;if(r)return _react2.default.createElement(_tree.NullSwitch,null,_react2.default.createElement(_icon2.default,{viewClass:l,theme:c,singleTheme:!0,iconClass:"lugia-icon-financial_omit"}));if(o||!r||i){var p=a.open,u=a.close,h="open"===e?p:u;return _react2.default.createElement(_tree.Switch,{disabled:n,onClick:this.onExpand},_react2.default.createElement(_icon2.default,{viewClass:l,theme:c,disabled:n,singleTheme:!0,iconClass:h}))}return _react2.default.createElement(_tree.NullSwitch,null,_react2.default.createElement(_icon2.default,{viewClass:l,theme:c,singleTheme:!0,iconClass:"lugia-icon-financial_omit"}))}},{key:"renderCheckbox",value:function(){var e=this.props,t=e.checked,r=e.halfChecked,o=e.title,n=e.disabled,i=e.mutliple,a=e.itemHeight;return _react2.default.createElement(_tree.TitleWrap,{disabled:n,themeProps:this.getTitleWrapThemeProps("Text","SelectedText",{mutliple:i,itemHeight:a})},_react2.default.createElement(_tree.CheckboxContainer,null,this.getPreIcon(),_react2.default.createElement(_checkbox2.default,Object.assign({},this.getCheckBoxTheme(),{checked:t,disabled:n,indeterminate:r,onChange:this.onCheck}),o),this.getSuffixIcon()))}},{key:"getCheckBoxTheme",value:function(){var e=this.getCheckboxTextDefaultTheme();return this.mergeTheme("Checkbox",e)}},{key:"getCheckboxTextDefaultTheme",value:function(){var e=this.getTitleWrapThemeProps("Text","SelectedText",{}).themeConfig,t=(e=void 0===e?{}:e).normal,r=(t=void 0===t?{}:t).color,o=void 0===r?_stateColor.mediumGreyColor:r,n=t.font,i=(n=void 0===n?{}:n).size,a=void 0===i?13:i,s=e.hover,l=(s=void 0===s?{}:s).color,c=void 0===l?_stateColor.themeColor:l,p=s.font,u=(p=void 0===p?{}:p).size,h=void 0===u?a:u,d=e.disabled,f=(d=void 0===d?{}:d).color,m=d.font,g=(m=void 0===m?{}:m).size;return{CheckboxText:{normal:{color:o,font:{size:a,fontWeight:500}},hover:{color:c,font:{size:h,fontWeight:500}},disabled:{color:f,font:{size:void 0===g?a:g,fontWeight:500}}}}}},{key:"renderChildren",value:function(r){var e=this.renderFirst;this.renderFirst=1;var t=!0;!e&&r.expanded&&(t=!1);var o=null;r.children&&(o=(0,_toArray2.default)(r.children).filter(function(e){return!!e}));var n=o;if(o&&(Array.isArray(o)&&o.length&&o.every(function(e){return e.type&&e.type.__OrginalWidget__.isTreeNode})||o.type&&o.type.isTreeNode)){var i={};r.openTransitionName?i.transitionName=r.openTransitionName:"object"===_typeof(r.openAnimation)&&(i.animation=Object.assign({},r.openAnimation),t||delete i.animation.appear),n=_react2.default.createElement(_rcAnimate2.default,Object.assign({},i,{showProp:"data-expanded",transitionAppear:t,component:""}),r.expanded?_react2.default.createElement(_tree.SubTreeWrap,{themeProps:this.props.getPartOfThemeProps("SubTreeWrap",{props:{paddingTop:r.marginBottom}}),"data-expanded":r.expanded,propsConfig:{expanded:r.expanded}},_react2.default.Children.map(o,function(e,t){return r.root.renderTreeNode(e,t,r.pos)},r.root)):null)}return n}},{key:"isChecked",value:function(){var e=this.props,t=e.mutliple,r=e.checked,o=e.selected;return t?r:o}},{key:"getSelectedTitleWrapThemeProps",value:function(e,t){var r=this.props,o=r.expanded,n=r.isLeaf,i=this.props.getPartOfThemeProps(e,t),a=i.themeConfig,s=void 0===a?{}:a,l=s.normal,c=void 0===l?{}:l;if(o&&!n){var p=this.props.getPartOfThemeProps("TextExpanded").normal,u=void 0===p?{}:p;s.normal=(0,_objectUtils.deepMerge)((0,_objectUtils.deepMerge)(this.getDefaultTitleWrapTheme("normal",t.props),c),u)}else s.normal=(0,_objectUtils.deepMerge)(this.getDefaultTitleWrapTheme("normal",t.props),c);return i}},{key:"getDefaultTitleWrapThemeProps",value:function(e,t){var r=this.props,o=r.expanded,n=r.isLeaf,i=this.props.getPartOfThemeProps(e,t),a=i.themeConfig,s=void 0===a?{}:a,l=s.hover,c=void 0===l?{}:l,p=s.normal,u=void 0===p?{}:p;if(o&&!n){var h=this.props.getPartOfThemeProps("TextExpanded").themeConfig,d=(h=void 0===h?{}:h).normal,f=void 0===d?{}:d;s.normal=(0,_objectUtils.deepMerge)(u,f)}return s.hover=(0,_objectUtils.deepMerge)(this.getDefaultTitleWrapTheme("hover",t.props),c),i}},{key:"getDefaultTitleWrapTheme",value:function(e,t){var r=t.mutliple;return t.__navmenu||!0===r?{}:"hover"===e?{background:{color:_tree.spiritColor}}:{background:{color:"rgba(77,99,255,0.2)"}}}},{key:"getTitleWrapThemeProps",value:function(e,t,r){var o=2<arguments.length&&void 0!==r?r:{},n=this.props.parentIsHighlight;return this.isChecked()||n?this.getSelectedTitleWrapThemeProps(t,{props:o}):this.getDefaultTitleWrapThemeProps(e,{props:o})}},{key:"getThemeProps",value:function(e,t,r){var o=2<arguments.length&&void 0!==r?r:{},n=this.props,i=n.getPartOfThemeProps,a=n.parentIsHighlight;return this.isChecked()||a?i(t,{props:o}):i(e,{props:o})}},{key:"getPreIcon",value:function(){var e=this.props,t=e.icon,r=e.icons,o=void 0===r?{}:r,n=e.disabled;if(!t&&!o)return null;var i=o.prefixIconClass,a=o.prefixIconSrc,s=i||t;if(!s&&!a)return null;var l=this.getIconTheme("PrefixIcon"),c=l.viewClass,p=l.theme;return _react2.default.createElement(_icon2.default,Object.assign({iconClass:s,src:a,disabled:n},this.props.dispatchEvent([["hover"],["active"]],"f2c"),{singleTheme:!0,viewClass:c,theme:p}))}},{key:"getSuffixIcon",value:function(){var e=this.props,t=e.icon,r=e.icons,o=void 0===r?{}:r,n=e.disabled;if(!t&&!o)return null;var i=o.suffixIconClass,a=o.suffixIconSrc;if(!i&&!a)return null;var s=this.getIconTheme("SuffixIcon"),l=s.viewClass,c=s.theme;return _react2.default.createElement(_icon2.default,Object.assign({iconClass:i,src:a},this.props.dispatchEvent([["hover"],["active"]],"f2c"),{singleTheme:!0,disabled:n,viewClass:l,theme:c}))}},{key:"componentDidMount",value:function(){var e=this.props,t=e.eventKey,r=e.draggable,o=e.treeDrag,n=o.listener;this.selectHandle&&r&&(o.collectNodeInformation({nodeName:t,nodeRef:this.selectHandle,node:this}),this.unSetNodeDragStateListener=n.on(t+"-setDrageState",this.setNodeDragState))}},{key:"componentWillUnmount",value:function(){var e=this.props,t=e.eventKey,r=e.treeDrag;if(e.draggable){var o=this.unSetNodeDragStateListener,n=void 0===o?{}:o;r.deletetNodeInformation(t);var i=n.removeListener;i&&i()}}},{key:"render",value:function(){var t=this,r=this.props,e=r.checked,o=r.selected,n=r.parentIsHighlight,i=r.disabled,a=r.inlineType,s=r.pos,l=r.describe,c=void 0!==l&&l,p=r.color,u=r.isLeaf,h=r.title,d=r.item,f=r.shape,m=r.mutliple,g=r.itemHeight,v=r.showSwitch,_=r.__navmenu,b=r.expanded,T=r.onlySelectLeaf,y=r.switchAtEnd,C=r.renderSuffixItems,x=r.eventKey,S=r.checkedCSS,P=r.marginBottom,k=this.state.dragState,D=b?"open":"close",w=!0,E=r.title,j=this.renderChildren(r);j&&j!==r.children||(j=null,u&&(w=!1));var I=this.getTitleWrapThemeProps("Text","SelectedText",{pos:s,mutliple:m,shape:f,selected:o||n,describe:c,inlineType:a,__navmenu:_});r.draggable;var O=this.getThemeProps("TreeItemWrap","SelectedTreeItemWrap",{dragState:k,pos:s,itemHeight:g,inlineType:a,selected:o,marginBottom:P,hasChildren:!!d.children});if(this.isChecked()){var N=O.themeConfig.normal,H=void 0===N?{}:N;H.height&&delete H.height}var W,M,q,L,A,R=_?_tree.NavLi:_tree.Li;return _react2.default.createElement(R,Object.assign({key:x,themeProps:O,unselectable:"on",inlineType:a},{},{isLeaf:u,selected:o,title:h,color:p,height:g},(0,_themeHoc.addMouseEvent)(this)),_react2.default.createElement(_tree.FlexWrap,{disabled:i,themeProps:O},_react2.default.createElement(_tree.FlexBox,{disabled:i,themeProps:O},!v||y?null:w?this.renderSwitch(D):(q=t.getIconTheme("SwitchIcon"),L=q.viewClass,A=q.theme,_react2.default.createElement(_tree.NullSwitch,null,_react2.default.createElement(_icon2.default,{viewClass:L,theme:A,singleTheme:!0,iconClass:"lugia-icon-financial_omit"}))),r.checkable&&"checkbox"===S?this.renderCheckbox():(W=_react2.default.createElement(_tree.TitleSpan,{themeProps:I,color:p,pos:s,selected:o,inlineType:a,title:E,height:g},t.getPreIcon(),_react2.default.createElement(_tree.Text,null,E),t.getSuffixIcon()),M={onContextMenu:t.onContextMenu},r.disabled||(M.onClick=function(e){e.preventDefault(),m&&t.onCheck(e),t.isSelectable()&&(t.onSelect(),(!r.describe&&T||"close"==D)&&t.onExpand())},r.draggable),_react2.default.createElement(_tree.TitleWrap,Object.assign({themeProps:I,ref:t.saveSelectHandle,title:"string"==typeof E?E:""},M,{pos:r.pos,inlineType:a,shape:f,checked:e,selected:o,describe:c,disabled:i}),W)),C?this.getRenderSuffixItems(d):null,y&&w?this.renderSwitch(D):null)),j)}}]),r}();TreeNode.propTypes={prefixCls:_propTypes2.default.string,disabled:_propTypes2.default.bool,disableCheckbox:_propTypes2.default.bool,expanded:_propTypes2.default.bool,isLeaf:_propTypes2.default.bool,root:_propTypes2.default.object,onSelect:_propTypes2.default.func,checkedCSS:0},TreeNode.contextTypes=_Tree.contextTypes,TreeNode.defaultProps={title:defaultTitle,checkedCSS:"checkbox"};var _initialiseProps=function(){var l=this;this.onCheck=function(e){l.props.root.onCheck(l,e,l.props.item)},this.onMouseEnter=function(e){e.preventDefault(),l.props.root.onMouseEnter(e,l)},this.onMouseLeave=function(e){e.preventDefault(),l.props.root.onMouseLeave(e,l)},this.onContextMenu=function(e){var t=l.props.item;e.preventDefault(),l.props.root.onContextMenu(e,l,t)},this.onDragStart=function(e){e.stopPropagation(),l.setState({dragNodeHighlight:!0}),l.props.root.onDragStart(e,l);try{e.dataTransfer.setData("text/plain","")}catch(e){}},this.onDragEnter=function(e){e.preventDefault(),e.stopPropagation(),l.props.root.onDragEnter(e,l)},this.onDragOver=function(e){e.preventDefault(),e.stopPropagation(),l.props.root.onDragOver(e,l)},this.onDragLeave=function(e){e.stopPropagation(),l.props.root.onDragLeave(e,l)},this.onDrop=function(e){e.preventDefault(),e.stopPropagation(),l.setState({dragNodeHighlight:!1}),l.props.root.onDrop(e,l)},this.onDragEnd=function(e){e.stopPropagation(),l.setState({dragNodeHighlight:!1}),l.props.root.onDragEnd(e,l)},this.onExpand=function(){var e=l.props.root.onExpand(l);if(e&&"object"===(void 0===e?"undefined":_typeof(e))){var t=function(e){l.setState({dataLoading:e})};t(!0),e.then(function(){t(!1)},function(){t(!1)})}},this.saveSelectHandle=function(e){l.selectHandle=e},this.mergeTheme=function(e,t){var r=l.props.getPartOfThemeHocProps(e),o=r.viewClass,n=r.theme;return{viewClass:o,theme:(0,_objectUtils.deepMerge)(_defineProperty({},o,Object.assign({},t)),n)}},this.getSwitchIconTheme=function(e){var t=l.props.getPartOfThemeHocProps("SwitchIcon"),r=t.viewClass,o=t.theme,n=l.props.getPartOfThemeHocProps("SwitchIconExpanded"),i=n.viewClass,a=n.theme,s={normal:{margin:{left:3,right:3}}};return"open"===e?{viewClass:r,theme:(0,_objectUtils.deepMerge)((0,_objectUtils.deepMerge)(_defineProperty({},r,Object.assign({},s)),o),_defineProperty({},r,Object.assign({},a[i])))}:{viewClass:r,theme:(0,_objectUtils.deepMerge)(_defineProperty({},r,Object.assign({},s)),o)}},this.getIconTheme=function(e){var t=l.props.getPartOfThemeHocProps(e),r=t.viewClass,o=t.theme,n={normal:{margin:{left:"SuffixIcon"===e?3:0,right:"PrefixIcon"===e?3:0}}};return{viewClass:r,theme:(0,_objectUtils.deepMerge)(_defineProperty({},r,Object.assign({},n)),o)}},this.setNodeDragState=function(e){l.setState({dragState:e})},this.getRenderSuffixItems=function(e){var t=(0,l.props.renderSuffixItems)(e),r=_react2.default.Children.map(t,function(e){var t=e.props;return _react2.default.cloneElement(e,Object.assign({},t,l.props.dispatchEvent([["hover"],["active"]],"f2c")))});return _react2.default.createElement(_tree.SuffixWrap,null,r)}};TreeNode.isTreeNode=1,exports.default=(0,_themeHoc2.default)(TreeNode,"TreeItem",{hover:!0});