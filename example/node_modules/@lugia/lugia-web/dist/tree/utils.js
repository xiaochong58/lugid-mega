"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}}(),_version=require("./version");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var EmptyError="结点不能为空",PathEqlKey="path不能等于key",PidEqlKey="pid不能等于key",PathNotContainerPid="path必须包含pid",PidPathMustSameExist="pid&path必须同时存在",isInit=-1,ErrorDefine={EmptyError:EmptyError,PathEqlKey:PathEqlKey,PidEqlKey:PidEqlKey,PidPathMustSameExist:PidPathMustSameExist,PathNotContainerPid:PathNotContainerPid},notEmpty=function(e){return null!=e&&""!==e},VirtualRoot="lugia_tree_root",TreeUtils=function(){function E(e,t){_classCallCheck(this,E),this.VirtualRoot=VirtualRoot;var i=t.expandAll,r=t.onlySelectLeaf,a=void 0!==r&&r,n=t.displayField,l=void 0===n?"title":n,s=t.valueField,h=void 0===s?"key":s,o=t.igronSelectField,d=t.limitCount,u=t.splitQuery,c=t.pathSeparator,f=void 0===c?"/":c,v=t.pathField,p=t.pidField;return this.Error=ErrorDefine,this.version=0,this.oldVersion=isInit,this.oldTreeData=e,this.treeData=e,this.orignalData=e,this.query=null,this.blackList=[],this.whiteList=[],this.expandAll=i,this.catchPathArray={},this.onlySelectLeaf=a,this.displayField=l,this.valueField=h,this.notInTree={},this.inTree={},this.igronSelectField=o,this.limitCount=d,this.splitQuery=u,this.selCount=0,this.pathSeparator=f,this.pathField=v,this.pidField=p,this}return _createClass(E,[{key:"checkTree",value:function(e){var i=this,r=[];return e.forEach(function(e){var t=i.isRightTreeRowData(e);""!==t&&r.push(JSON.stringify(e)+"==>"+t)}),r=r.concat(this.isRightLevel(e))}}]),_createClass(E,[{key:"updateVersion",value:function(){_version.updateVersion.call(this)}},{key:"isRightTreeRowData",value:function(e){function t(e){return e!=i}var i=e[this.valueField],r=e[this.displayField],a=e[this.pidField],n=e[this.pathField],l=notEmpty(i)&&notEmpty(r),s=notEmpty(a),h=notEmpty(n),o=!s&&!h||s&&h,d=!o||t(a),u=!o||t(n),c=!h||!s||n.endsWith(a);return l?o?d?u?c?"":PathNotContainerPid:PathEqlKey:PidEqlKey:PidPathMustSameExist:EmptyError}},{key:"isRightLevel",value:function(c){function f(e){return e[v.valueField]+"结点的层级位置错误，必须处于父节点【"+e.pid+"】的范围内!"}function e(e){var r=0<arguments.length&&void 0!==e?e:{};return function(){var i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(e,t){};c.forEach(function(e){var t=e[v.valueField];r[t]=e,i&&i(r,e)})}}var v=this,p=[],l={},r=[];if(e(l)(function(e,t){var i=t[v.pidField];notEmpty(i)&&r.push(i)}),r.forEach(function(e){notEmpty(l[e])||p.push(function(e){return"找不到key:"+e+"的结点."}(e))}),0<p.length)return p;var y={},a=0;e()(function(e,t){var i=t[v.pidField],r=t[v.valueField];y[r]=a++,notEmpty(i)&&!e[i]&&p.push(f(t))});function g(e){for(var t=[],i=l[e];i;){var r=i,a=r[v.valueField],n=r[v.pidField];t.push(a),i=l[n]}return t.reverse()}var k={};return c.forEach(function(e){var t=e[v.pidField],i=e[v.pathField],r=e[v.valueField];t&&g(t).join(v.pathSeparator)!==i&&(k[r]=!0,p.push(function(e){return e[v.valueField]+"结点path信息错误!"}(e)))}),c.forEach(function(e,t){var i=e[v.pidField];if(i){var r=g(i).map(function(e){return y[e]}),a=r.length;if(0<a)for(var n=r[a-1],l=c[n],s=l[v.pathField],h=l[v.valueField],o=(s?""+s+v.pathSeparator:"")+h,d=n+1;d<t;d++){var u=c[d][v.pathField];if(u&&!u.startsWith(o)&&!k[e[v.valueField]]){p.push(f(e));break}}}}),p}},{key:"generateTreeNode",value:function(e){var l=this,s=[];if(e){var h={};e.forEach(function(e){var t=Object.assign({},e),i=t[l.pidField],r=t[l.valueField];if(h[r]=t,i){var a=h[i],n=a.children;n||(n=[],a.children=n),n.push(t)}else s.push(h[r])})}return s}},{key:"slice",value:function(e,t,i,r){var a={rows:[],parentCount:0};if(e&&0===e.length)return a;var n=e.slice(t,t+i),l=n[0];if(!l)return console.warn("树形数据存在问题"),a;if(!l.pid)return{rows:n,parentCount:0};var s=this.getPathNodes(e,t,r),h=s.length;return Array.prototype.push.apply(s,n),{rows:s,parentCount:h}}},{key:"getPathNodes",value:function(e,t,i){var r=[],a=e[t];if(!a)return r;var n=a[this.pathField];if(n)for(var l=this.getPathArray(n),s=l.length,h=0;h<s;h++){var o=this.getRow(l[h],i);o&&r.push(o)}return r}},{key:"getPathArray",value:function(e){if(!e)return[];var t=this.catchPathArray[e];return t||(this.catchPathArray[e]=e.split(this.pathSeparator),this.catchPathArray[e])}},{key:"getKeys",value:function(e){var t=this;return e?e.map(function(e){return e[t.valueField]}):[]}},{key:"fetchNodeExtendInfo",value:function(e,t,i){i[VirtualRoot]||this.initAllNodeIndexAndTopRoot(t,i);var r=i[e],a=r.index,n=r.can,l=t[a];if(l){var s=l.isLeaf;if(void 0!==s&&s)return{can:n,nowVisible:0,realyVisible:0,childrenIdx:[],children:0,begats:0,index:r.index}}if(void 0!==r.begats)return r;var h=t.length,o=0,d=0,u=[],c=l[this.pathField],f=e;c&&(f=""+c+this.pathSeparator+e);for(var v=a+1;v<h;v++){var p=!1,y=t[v],g=y[this.pidField],k=y[this.pathField],F=y[this.valueField];if(g===e){o++,u.push(v);var x=i[F].begats,E=void 0===x?-1:x;0<E&&(d+=E,v+=E),d++,p=!0}else k&&0===k.indexOf(f)&&(d++,p=!0);if(!p)break}return this.generateExtendInfo(e,d,o,i,u,a,n)}},{key:"initAllNodeIndexAndTopRoot",value:function(e,t){var i=[],r=0;if(!t[VirtualRoot]){for(var a=e.length,n=0;n<a;n++){var l=e[n],s=l.pid,h=l[this.valueField];s||i.push(n);var o=this.can(l);o&&r++,t[h]={index:n,can:o}}var d=i.length,u=this.expandAll?a:d;t[VirtualRoot]={can:!1,canTotal:r,nowVisible:u,realyVisible:u,childrenIdx:i,children:d,begats:a,index:-1}}}},{key:"generateExtendInfo",value:function(e,t,i,r,a,n,l){var s=this.expandAll?t:e===this.VirtualRoot?i:0;return r[e]={can:l,nowVisible:s,realyVisible:s,childrenIdx:a,children:i,begats:t,index:n}}},{key:"expandNode",value:function(e,t){var i=this.treeData,a=this.fetchNodeExtendInfoById(i,t),r=a(e),n=r.children,l=r.expanded,s=r.begats,h=void 0===s?0:s,o=void 0===l;if(!this.expandAll&&o&&(r.nowVisible=r.realyVisible=n),!(this.expandAll&&o)&&!0!==l&&0!=h){var d=r.realyVisible,u=r.index;r.nowVisible=d,this.processPath(i[u],function(e){var t=a(e),i=t.nowVisible,r=t.realyVisible;t.nowVisible=i+d,t.realyVisible=r+d}),r.expanded=!0,this.updateVersion()}}},{key:"fetchNodeExtendInfoById",value:function(t,i){var r=this;return function(e){return r.fetchNodeExtendInfo(e,t,i)}}},{key:"colapseNode",value:function(e,t){var i=this.treeData,a=this.fetchNodeExtendInfoById(i,t),r=a(e),n=r.expanded,l=r.realyVisible,s=void 0===l?0:l,h=r.begats;if(!1!==n&&0!=(void 0===h?0:h)){var o=r.index;r.nowVisible=0,this.processPath(i[o],function(e){var t=a(e),i=t.realyVisible,r=void 0===i?0:i;t.realyVisible=r-s,0!==t.nowVisible&&(t.nowVisible=t.realyVisible)}),r.expanded=!1,this.updateVersion()}}},{key:"processPath",value:function(e,t){var i=e[this.pathField],r=[this.VirtualRoot];i&&Array.prototype.push.apply(r,this.getPathArray(i));for(var a=r.length,n=0;n<a;n++)t(r[n])}},{key:"fixedNullAndUndefined",value:function(e){return null==e?"":e}},{key:"fixedNullAndUndefinedArray",value:function(e){return null==e?[]:e}},{key:"isWhiteOrBlackListChanged",value:function(){return this.whiteOrBlackListChanged}},{key:"search",value:function(e,t,i,r,a){var n=2<arguments.length&&void 0!==i?i:"include",l=this,s=r,h=a,o=this.fixedNullAndUndefined(t)!==this.fixedNullAndUndefined(this.query),d=JSON.stringify(this.fixedNullAndUndefinedArray(s))!==JSON.stringify(this.fixedNullAndUndefinedArray(this.blackList)),u=JSON.stringify(this.fixedNullAndUndefinedArray(h))!==JSON.stringify(this.fixedNullAndUndefinedArray(this.whiteList));this.whiteOrBlackListChanged=d||u;var c=o||d||u;if(c&&this.updateVersion(),!this.isVersionChange())return this.oldTreeData;if(c&&(e.id2ExtendInfo={}),""===t)this.treeData=this.getFilterResult(s,h);else if(o){var f=this.getQueryArray(t),v=this.getFilterResult(s,h),p=this.getRowSet(v,function(e){var t=e[l.displayField];return l.match(t,f,n)},function(){return!0});p.length===v.length?this.treeData=v:this.treeData=p.reverse()}return this.query=t,this.blackList=s,this.whiteList=h,this.oldTreeData=this.generateRealTreeData(e),this.oldTreeData}},{key:"getRowSet",value:function(e,t,i){for(var r={},a={},n=[],l=e.length-1;0<=l;l--){var s=e[l],h=s[this.valueField],o=s[this.pathField];if(t(s)){if(i(s,r)&&void 0!==o&&void 0===a[o]){var d=this.getPathArray(o);a[o]=!0;for(var u=d.length,c=0;c<u;c++){r[d[c]]=!0}}i(s,r)&&n.push(s)}else!0===r[h]&&(n.push(s),delete r[h])}return n}},{key:"getFilterResult",value:function(r,i){var a=this;if(!r&&!i)return this.orignalData;var e=this.orignalData,t=this.getRowSet(e,function(e){var t=e[a.valueField];return r?!r.includes(t):i?i.includes(t):void 0},function(e,t){var i=e[a.valueField];return e.isLeaf||t[i]||!r});return t.length===this.orignalData.length?this.orignalData:t.reverse()}},{key:"isVersionChange",value:function(){return this.version!==this.oldVersion}},{key:"match",value:function(e,t,i){if(null==e)return!1;if(!t)return!1;switch(e+="",i){case"start":return this.toMach(e,t,function(e,t){return e.startsWith(t)});case"end":return this.toMach(e,t,function(e,t){return e.endsWith(t)});case"include":return this.toMach(e,t,function(e,t){return!!~e.indexOf(t)});case"eql":return this.toMach(e,t,function(e,t){return e===t});default:return!1}}},{key:"getQueryArray",value:function(e){return this.splitQuery?e.split(this.splitQuery):[e]}},{key:"toMach",value:function(e,t,i){for(var r=0;r<t.length;r++){var a=t[r];if(a&&""!==a&&i(e,a))return!0}return!1}},{key:"generateRealTreeData",value:function(e){var t=this.treeData;if(!this.isVersionChange())return this.oldTreeData;var i=e.id2ExtendInfo,r=this.fetchNodeExtendInfoById(t,i),a=r(this.VirtualRoot),n=a.nowVisible;if(0===n)return[];this.oldVersion=this.version;var l=a.childrenIdx,s=void 0===l?[]:l,h=a.children,o=void 0===h?0:h,d=a.begats,u=void 0===d?0:d;if(n===o)return this.oldTreeData=this.fetchLevelOneChild(t,s);if(n===u)return this.oldTreeData=t;for(var c=t.length,f=[],v=0;v<c;v++){var p=t[v];f.push(p);var y=r(p[this.valueField]),g=y.childrenIdx,k=void 0===g?[]:g,F=y.nowVisible,x=void 0===F?0:F,E=y.children,S=void 0===E?0:E,b=y.begats,N=void 0===b?0:b;if(0===x)v+=N;else if(x===S)Array.prototype.push.apply(f,this.fetchLevelOneChild(t,k)),v+=N;else if(x===N){var P=v+1;Array.prototype.push.apply(f,t.slice(P,P+N)),v+=N}}return this.oldTreeData=f}},{key:"fetchLevelOneChild",value:function(e,t){for(var i=[],r=t.length,a=0;a<r;a++)i.push(e[t[a]]);return i}},{key:"selectNode",value:function(e,t,i){if(!0!==t.checked[e]){var r=E.Selected,a=this.updateSelectedStatusForChildren(e,t,i,r)[this.pathField],n=this.fetchNodeExtendInfo(e,this.treeData,i).begats,l=(void 0===n?0:n)+1;this.updateSelectedStatusForParent(a,t,l,r,i)}}},{key:"selectDirNode",value:function(e,t,i){if(!0!==t.checked[e]){var r=this.getRow(e,i);r?this.selectDirNodeByRow(r,t,i):console.warn("选择的结点不存在")}}},{key:"selectDirNodeByRow",value:function(e,t,i){var r=e[this.valueField],a=t.checked;if(!0!==a[r]){var n=e.isLeaf;if(!0!==(void 0!==n&&n)){var l=t.halfchecked,s=t.value,h=l[r],o=this.fetchNodeExtendInfo(r,this.treeData,i);if(void 0!==h){var d=o.begats;h===(void 0===d?0:d)&&(l[r]=h+1,a[r]=!0)}else l[r]=1;this.selectRow(s,r,e,o);var u=e[this.pathField];this.updateSelectedStatusForParent(u,t,1,E.Selected,i)}else this.selectNode(r,t,i)}}},{key:"unSelectNode",value:function(e,t,i){var r=1;if(!this.isLeaf(e,i)){var a=t.halfchecked[e];if(1===a)r=1;else{var n=this.fetchNodeExtendInfo(e,this.treeData,i).begats,l=(void 0===n?0:n)+1;r=Math.min(a+1,l),a<l&&(r-=1)}}var s=E.UnSelected,h=this.updateSelectedStatusForChildren(e,t,i,s)[this.pathField];this.updateSelectedStatusForParent(h,t,r,s,i)}},{key:"updateSelectedStatusForParent",value:function(e,t,i,r,a){if(e){var n=t.checked,l=t.halfchecked,s=this.getPathArray(e),h=s.length;switch(r){case E.Selected:for(var o=0;o<h;o++){var d=s[o];if(!n[d]){this.halfCheckForParent(d,t,r,i);var u=this.fetchNodeExtendInfo(d,this.treeData,a).begats,c=void 0===u?0:u;l[d]===c+1&&(n[d]=!0)}}break;case E.UnSelected:for(var f=0;f<h;f++){var v=s[f];delete n[v],this.halfCheckForParent(v,t,r,i)}}}}},{key:"isLeaf",value:function(e,t){var i=this.getRow(e,t);if(!i)return!1;var r=i.isLeaf,a=void 0!==r&&r;return a}},{key:"getRow",value:function(e,t){if(t[VirtualRoot]||this.initAllNodeIndexAndTopRoot(this.treeData,t),t[e]){var i=t[e].index;return this.treeData[i]}return null}},{key:"getTitle",value:function(e,t){if(!e||0===e.length)return[];for(var i=[],r=e.length,a=0;a<r;a++){var n=e[a],l=this.getRow(n,t);if(l){var s=l[this.displayField];i.push(s)}else i.push(this.getNoInTreeTitle(n))}return i}},{key:"getNoInTreeTitle",value:function(e){var t=this.notInTree[e];return t||""}},{key:"getNotInTree",value:function(){var e=this.notInTree;return void 0===e?{}:e}},{key:"getInTree",value:function(){var e=this.inTree;return void 0===e?{}:e}},{key:"updateSelectedStatusForChildren",value:function(e,t,i,r){for(var a=this.treeData,n=this.fetchNodeExtendInfo(e,a,i),l=n.index,s=n.begats,h=a.length,o=l+s,d=l;d<=o&&d<h;d++){var u=a[d],c=u[this.valueField];switch(r){case E.Selected:var f=this.fetchNodeExtendInfo(c,a,i),v=t.checked,p=t.value;if(!this.selectRow(p,c,u,f))break;v[c]=!0;var y=u.isLeaf,g=void 0!==y&&y,k=this.fetchNodeExtendInfo(c,a,i).begats,F=void 0===k?0:k,x=d===l||!g?F+1:F;if(0<x)t.halfchecked[c]=x;break;case E.UnSelected:this.clearSelectInfo(c,t)}}return a[l]}},{key:"halfCheckForParent",value:function(e,t,i,r){if(0!==r){var a=t.halfchecked,n=!a[e];switch(i){case E.Selected:this.halfSelectedForParent(e,t,r);break;case E.UnSelected:var l=a[e];l&&(a[e]=l-r),(n||a[e]<=0)&&this.clearSelectInfo(e,t)}}else this.clearSelectInfo(e,t)}},{key:"halfSelectedForParent",value:function(e,t,i){var r=t.halfchecked;r[e]||(r[e]=0),r[e]=r[e]+i}},{key:"clearSelectInfo",value:function(e,t){var i=t.value,r=t.halfchecked,a=t.checked;delete r[e],delete a[e],delete i[e]}},{key:"value2SelectInfo",value:function(e,t,i,r){var a=e.length;if(this.selCount=0,this.notInTree={},this.inTree={},!i||!a)return{value:{},halfchecked:{},checked:{}};var n={},l={},s={};this.initAllNodeIndexAndTopRoot(this.treeData,r);for(var h=[],o={},d={},u=[],c={},f=0;f<a;f++){var v=e[f];if(!c[v]){var p=this.getRow(v,r);if(p){this.selCount++;var y=p.isLeaf,g=void 0!==y&&y,k=p[this.pathField];if(g)k?(d[k]||(d[k]=this.getPathArray(k)),o[k]||(o[k]=[]),o[k].push(p)):u.push(p);else{var F=this.getPathArray(k).length,x=h[F];(x=x||(h[F]=[])).push(p)}this.inTree[v]=!0}else{n[v]=!0;var E=t[f];this.notInTree[v]=E||v}c[v]=!0}}for(var S={value:n,halfchecked:l,checked:s},b=h.length,N=b-1;0<=N;N--){var P=h[N];if(P)for(var I=P.length,w=0;w<I;w++){var V=P[w][this.valueField];this.fetchNodeExtendInfo(V,this.treeData,r)}}for(var A=0;A<b;A++){var T=h[A];if(T)for(var D=T.length,R=0;R<D;R++)this.selectDirNodeByRow(T[R],S,r)}for(var C=this.treeData,m=Object.keys(d),L=m.length,O=0;O<L;O++){for(var U=m[O],q=o[U],M=q.length,_=0,B=0;B<M;B++){var K=q[B][this.valueField];s[K]=!0;var j=this.fetchNodeExtendInfo(K,C,r).begats,Q=void 0===j?0:j;_+=l[K]=Q+1}for(var J=d[U],W=J.length,z=0;z<W;z++){var G=J[z];if(!s[G]){this.halfSelectedForParent(G,S,_);var H=this.fetchNodeExtendInfo(G,C,r).begats,X=void 0===H?0:H;l[G]===X+1&&(s[G]=!0)}}}for(var Y=u.length,Z=0;Z<Y;Z++){s[u[Z][this.valueField]]=!0}return{value:i,halfchecked:l,checked:s}}},{key:"selectRow",value:function(e,t,i,r){return!e[t]&&(!!r.can&&(e[t]=!0,!(null!=this.limitCount&&Object.keys(e).length>this.limitCount)||(delete e[t],!1)))}},{key:"can",value:function(e){if(this.igronSelectField&&!0===e[this.igronSelectField])return!1;if(this.onlySelectLeaf){var t=e.isLeaf;if(!(void 0!==t&&t))return!1}return!0}},{key:"getCanTotal",value:function(e){var t=this.fetchNodeExtendInfo(VirtualRoot,this.treeData,e);if(!t)return 0;var i=t.canTotal;return void 0===i?0:i}}]),E}();TreeUtils.Selected=1,TreeUtils.UnSelected=0,exports.default=TreeUtils;