"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),_templateObject=_taggedTemplateLiteral(["\n  font-size: ",";\n  line-height: ",";\n  text-align: center;\n  display: block;\n"],["\n  font-size: ",";\n  line-height: ",";\n  text-align: center;\n  display: block;\n"]),_templateObject2=_taggedTemplateLiteral(["\n  color: red;\n"],["\n  color: red;\n"]);require("../common/shirm");var _openAnimation=require("../common/openAnimation"),_openAnimation2=_interopRequireDefault(_openAnimation),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_empty=require("../empty"),_empty2=_interopRequireDefault(_empty),_react=require("react"),React=_interopRequireWildcard(_react),_rcTree=require("./rc-tree"),_FormFieldWidgetSupport=require("../common/FormFieldWidgetSupport"),_FormFieldWidgetSupport2=_interopRequireDefault(_FormFieldWidgetSupport),_ThrottleTree=require("./ThrottleTree"),_ThrottleTree2=_interopRequireDefault(_ThrottleTree),_index=require("../consts/index"),_index2=_interopRequireDefault(_index);require("./index.css");var _utils=require("./utils"),_utils2=_interopRequireDefault(_utils),_index3=require("../utils/index"),_styledComponents=require("styled-components"),_styledComponents2=_interopRequireDefault(_styledComponents),_css=require("../css"),_units=require("../css/units");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _taggedTemplateLiteral(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var em=(0,_units.px2emcss)(_css.FontSizeNumber),EmptyBox=_styledComponents2.default.span(_templateObject,_css.FontSize,em(20)),ErrorTooltip=(0,_styledComponents2.default)(EmptyBox)(_templateObject2),Tree=function(){function a(e){_classCallCheck(this,a);var t=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e));if(_initialiseProps.call(t),t.allExpandInfo=t.getEmptyExpandInfo(),t.allStart=0,t.end=0,t.canSeeCount=0,t.createQueryAllTreelUtils(e),t.isEmpty(e))return t.state={start:0,hasError:!1,expandedKeys:[],expand:t.getEmptyExpandInfo(),selectValue:[],selectedInfo:t.getEmptyNodeId2SelectInfo(),parentHighlightKeys:[],__dontShowEmpty:!1},_possibleConstructorReturn(t);var i=t.updateExpandInfo(e),n=i.id2ExtendInfo,r={hasError:!1,start:_FormFieldWidgetSupport2.default.getInitStart(e,0),expandedKeys:t.getExpandedKeys(e,n),expand:i,selectValue:[],selectedInfo:t.getEmptyNodeId2SelectInfo(),parentHighlightKeys:[]};return t.updateStateValuForLimitValue(e,r,n,t.getInitValue(e)),t.state=r,t}return _inherits(a,React.Component),_createClass(a,[{key:"getViewData",value:function(){var e=this.data;return void 0===e?[]:e}},{key:"getQueryData",value:function(){var e=this.props;if(this.isQueryAll(e)){var t=e.data;return void 0===t?[]:t}return this.getViewData()}},{key:"isSelectAll",value:function(){var e=this.state.expand.id2ExtendInfo,t=this.props,i=t.limitCount,n=void 0===i?9999999:i,r=this.getUtils(t),a=Object.keys(this.getNotInTree()).length,s=Math.min(r.getCanTotal(e),n);return!(s<=0)&&r.selCount+a>=s}},{key:"isChecked",value:function(e){var t=this.state.selectedInfo,i=t.checked,n=t.halfchecked;return i[e]||n[e]}},{key:"getInitValue",value:function(e){return _FormFieldWidgetSupport2.default.getInitValueArray(e)}},{key:"isNotLimit",value:function(e){return _FormFieldWidgetSupport2.default.isNotLimit(e)}},{key:"componentWillReceiveProps",value:function(e){var t=JSON.stringify(e.data)!==JSON.stringify(this.props.data);!0==t&&(this.allExpandInfo=this.getEmptyExpandInfo(),this.createQueryAllTreelUtils(e));var i=this.props.query!==e.query,n=this.props.blackList!==e.blackList,r=this.props.whiteList!==e.whiteList,a=e.value!=this.props.value;if(t||i||a||n||r){var s=this.updateExpandInfo(e),l=s.id2ExtendInfo,o={hasError:!1,start:this.isQueryAll(e)?this.allStart:_FormFieldWidgetSupport2.default.getInitStart(e,this.state.start),selectedInfo:this.getEmptyNodeId2SelectInfo(),expandedKeys:this.getExpandedKeys(e,l),expand:s,selectValue:[],parentHighlightKeys:[]};if(this.isNotLimit(e)){var u=this.state,d=u.selectValue,c=void 0===d?[]:d,p=u.selectedInfo.value;this.updateStateValue(e,o,l,c,p,Object.keys(p))}else this.updateStateValuForLimitValue(e,o,l,this.getInitValue(e));this.setState(o)}this.props.start!==e.start&&this.setState({start:_FormFieldWidgetSupport2.default.getInitStart(e,this.state.start)});var h=this.props.current;if(h!==e.current){if(h>this.end-2){var f=Math.min(this.state.start+this.canSeeCount,this.getViewData().length-1);this.setState({start:f})}h<this.state.start&&this.setState({start:Math.max(this.state.start-this.canSeeCount,0)})}this.setState({hasError:!1})}},{key:"getEmptyNodeId2SelectInfo",value:function(){return{checked:{},value:{},halfchecked:{}}}},{key:"getNotInTree",value:function(){return this.getUtils(this.props).getNotInTree()}},{key:"getInTree",value:function(){return this.getUtils(this.props).getInTree()}},{key:"updateStateValuForLimitValue",value:function(e,t,i,n){var r=this.getValueObject(e,n),a=r.obj,s=r.val;this.updateStateValue(e,t,i,n,a,s)}},{key:"getValueObject",value:function(e,t){if(this.isSingleSelectForProps(e)){if(!t||0===t.length)return{obj:{},val:[]};var i=t[0];return{obj:_defineProperty({},i,!0),val:[i]}}for(var n=t.length,r={},a=0;a<n;a++){var s=t[a];""!==s&&(r[s]=!0)}return{obj:r,val:t}}},{key:"updateStateValue",value:function(e,t,i,n,r,a){var s=e.displayValue,l=void 0===s?[]:s;this.isSingleSelectForProps(e)?t.selectValue=n:t.selectedInfo=this.getUtils(e).value2SelectInfo(a,l||[],r,i)}},{key:"updateExpandInfo",value:function(e){var t=this.getEmptyExpandInfo();this.isQueryAll(e)&&(t=this.allExpandInfo),this.createQueryTreeUtils(e);var i=e.query,n=e.blackList,r=e.whiteList,a=e.searchType,s=void 0===a?"include":a;return this.search(this.getUtils(e),t,i,s,n,r),t}},{key:"getEmptyExpandInfo",value:function(){return{id2ExtendInfo:{}}}},{key:"getExpandedKeys",value:function(e,t){if(this.isQueryAll(e)){var i=this.getUtils(e);if(null==this.allExpandKeys||i.isWhiteOrBlackListChanged()){var n=this.props.expandAll;this.allExpandKeys=n?Object.keys(t):[]}return this.allExpandKeys}return Object.keys(t)}},{key:"isQueryAll",value:function(e){return""===e.query}},{key:"shouldComponentUpdate",value:function(e,t){var i=this.props,n=i.data!==e.data,r=i.blackList!==e.blackList,a=i.whiteList!==e.whiteList,s=e.theme!==i.theme,l=this.state;return i.query!==e.query||n||r||a||i.current!==e.current||l.hasError!==t.hasError||l.start!==t.start||i.svThemVersion!==e.svThemVersion||i.mutliple!==e.mutliple||l.selectValue!==t.selectValue||l.expand!==t.expand||l.selectedInfo!==t.selectedInfo||s}},{key:"createQueryTreeUtils",value:function(e){var t=this.createUtils(e,!0);t&&(this.utils=t)}},{key:"createQueryAllTreelUtils",value:function(e){var t=this.createUtils(e);t&&(this.queryAllUtils=t,this.allExpandKeys=null,this.allStart=0)}},{key:"createUtils",value:function(e,t){var i=e.data,n=e.onlySelectLeaf,r=e.expandAll,a=e.displayField,s=e.valueField,l=e.limitCount,o=e.splitQuery,u=e.igronSelectField,d=e.pathSeparator,c=e.pathField,p=e.pidField,h=1<arguments.length&&void 0!==t?t:r;return i?new _utils2.default(i,{expandAll:h,onlySelectLeaf:n,displayField:a,valueField:s,limitCount:l,splitQuery:o,igronSelectField:u,pathSeparator:d,pathField:c,pidField:p}):null}},{key:"getUtils",value:function(e){return this.isQueryAll(e)?this.queryAllUtils:this.utils}},{key:"render",value:function(){var e=this.props,t=this.state,i=React.createElement(_empty2.default,{themeProps:e.getPartOfThemeProps("Container")}),n=e.__dontShowEmpty;if(this.isEmpty(e)&&!n)return i;if(this.state.hasError)return React.createElement(ErrorTooltip,null,"树形数据错误");var r=e.query,a=e.current,s=e.igronSelectField,l=e.blackList,o=e.whiteList,u=e.searchType,d=void 0===u?"include":u,c=e.valueField,p=e.getTreeData,h=t.expand,f=t.expandedKeys,y=t.selectedInfo,v=t.start,g=t.selectValue,m=void 0===g?[]:g,_=t.parentHighlightKeys,x=void 0===_?[]:_,S=h.id2ExtendInfo,E=y.checked,k=y.halfchecked,I=this.getUtils(e),b=this.search(I,h,r,d,l,o);if(this.data=b,p&&p(b),0===b.length&&!n)return i;this.isQueryAll(e)&&(this.allStart=v);var C=[],F=b[a];if(F){var T=F[c];C.push(T+"")}return React.createElement(_ThrottleTree2.default,Object.assign({},e,{id2ExtendInfo:S,start:v,igronSelectField:s,onScroller:this.onScroller,onScrollerEndChange:this.onScrollerEndChange,onCanSeeCountChange:this.onCanSeeCountChange,onCheck:this.onCheck,onSelect:this.onSelect,data:b,selectable:this.isSingleSelect(),highlight:C,selectedKeys:m,parentHighlightKeys:x,checkedKeys:Object.keys(E),halfCheckedKeys:Object.keys(k),utils:I,expandedKeys:f,onExpand:this.onExpand}))}},{key:"search",value:function(e,t,i,n,r,a){var s=3<arguments.length&&void 0!==n?n:"include",l=r,o=a;return this.data=e.search(t,i,s,l,o)}},{key:"select",value:function(e,t,i){if(!1!==this.isSingleSelect()){var n=e[0],r=null!=n?n:"",a=this.props,s=a.onlySelectLeaf,l=void 0!==s&&s,o=a.igronSelectField,u=void 0===o?"":o,d=a.limitCount;if(!(null!=d&&d<=0)){if(!0===l||u){var c=this.getUtils(a),p=this.state.expand.id2ExtendInfo;if(l&&!c.isLeaf(r,p))return;if(""!=u&&null!=u){var h=c.getRow(r,p);if(h&&!0===h[u])return}}this.onChange([r],i),this.isNotLimit(a)&&this.setState({selectValue:e,parentHighlightKeys:t})}}}},{key:"check",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=arguments[3],r=this.state,a=this.props,s=r.selectedInfo,l=s.halfchecked,o=s.value,u=void 0===l[e]&&t,d=this.getUtils(a),c=d.selectDirNode,p=d.unSelectNode,h=d.selectNode,f=u?c:p,y=u?h:p,v=r.expand.id2ExtendInfo,g=i?f:y;if(g.call(d,e,s,v),this.onChange(Object.keys(o),n,s),this.isNotLimit(a)){var m={start:this.state.start,hasError:!1,selectedInfo:this.getEmptyNodeId2SelectInfo(),expandedKeys:this.state.expandedKeys,expand:this.state.expand,selectValue:[],parentHighlightKeys:[]},_=s.value;this.updateStateValue(a,m,v,[],_,Object.keys(_)),this.setState(m)}}},{key:"getRows",value:function(e){var t=0<arguments.length&&void 0!==e?e:[];if(!t||t.length<=0)return[];for(var i=[],n=this.props,r=this.state.expand.id2ExtendInfo,a=this.getUtils(n),s=t.length,l=0;l<s;l++){var o=t[l],u=a.getRow(o,r);u?i.push(u):i.push(null)}return i}},{key:"getTitle",value:function(e){var t=this.allExpandInfo.id2ExtendInfo;return this.queryAllUtils.getTitle(e,t)}},{key:"expand",value:function(e){this.isExpand(e)||(this.state.expandedKeys.push(e+""),this.expandOrCollapse(e,[].concat(_toConsumableArray(this.state.expandedKeys)),!0))}},{key:"collapse",value:function(e){this.isExpand(e)&&((0,_index3.deleteValue)(this.state.expandedKeys,e+""),this.expandOrCollapse(e,[].concat(_toConsumableArray(this.state.expandedKeys)),!1))}},{key:"isExpand",value:function(e){return-1!==this.state.expandedKeys.indexOf(e+"")}},{key:"expandOrCollapse",value:function(e,t,i){var n=this.props,r=this.state,a=this.getUtils(n),s=r.expand,l=s.id2ExtendInfo;i?a.expandNode(e,l):a.colapseNode(e,l),this.isQueryAll(n)&&(this.allExpandKeys=t);var o=Object.assign({},s,{id2ExtendInfo:l});this.setState({expand:o,expandedKeys:t});var u=n.onExpand,d=n.data;u&&u(t,void 0===d?[]:d)}},{key:"isLimitStart",value:function(){return"start"in this.props}},{key:"isEmpty",value:function(e){var t=e.data;return!t||0===t.length}},{key:"isSingleSelect",value:function(){return this.isSingleSelectForProps(this.props)}},{key:"canSelect",value:function(e){return this.state.expand.id2ExtendInfo[e].can}},{key:"isSingleSelectForProps",value:function(e){return!1===e.mutliple}},{key:"componentDidCatch",value:function(){this.setState({hasError:!0})}}]),a}();Tree.displayName=_index2.default.Tree,Tree.defaultProps={expandAll:!1,mutliple:!1,pathSeparator:"/",defaultValue:"",displayField:"title",valueField:"key",onlySelectLeaf:!1,query:"",current:-1,openAnimation:_openAnimation2.default,igronSelectField:"disabled",inlineType:"primary",parentIsHighlight:!1,shape:"default",showSwitch:!0,__navmenu:!1,switchAtEnd:!1,switchIconNames:{open:"lugia-icon-direction_caret_down",close:"lugia-icon-direction_caret_right"}};var _initialiseProps=function(){var p=this;this.onScrollerEndChange=function(e){p.end=e},this.onCanSeeCountChange=function(e){p.canSeeCount=e},this.onSelect=function(e,t,i){var n=p.props,r=n.parentIsHighlight,a=n.pathField,s=t.node.props,l=s.item[a],o=void 0===l?"":l,u=s.isLeaf,d=[];r&&u&&(d=o.split("/"));var c=p.props.onSelect;c&&c(e,i),p.select(e,d,i)},this.onCheck=function(e,t,i){var n=t.node,r=t.checked,a=t.shiftKey,s=n.props.eventKey;p.check(s,r,a,i)},this.onChange=function(e,t,i){p.value=e;var n=p.props.onChange,r=p.getCheckedItems(e);n&&n(e,p.getTitle(e),{item:t,checkedItems:r,selectedInfo:i})},this.getCheckedItems=function(i){var n=[];if(0===(i||[]).length)return n;var e=p.props,t=e.data,r=e.valueField;return t.forEach(function(e){var t=e[r];-1!==i.indexOf(t)&&n.push(e)}),n},this.onExpand=function(e,t){var i=t.expanded,n=t.node.props.eventKey;p.expandOrCollapse(n,e,i)},this.onScroller=function(e,t){p.isLimitStart()||p.setState({start:e});var i=p.props.onScroller;i&&i(e,t)}};exports.default=(0,_themeHoc2.default)(Tree,_index2.default.Tree,{hover:!0});