"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();require("../common/shirm");var _theme=require("../theme"),_theme2=_interopRequireDefault(_theme),_react=require("react"),_react2=_interopRequireDefault(_react),_inputtag=require("../inputtag"),_inputtag2=_interopRequireDefault(_inputtag),_trigger=require("../trigger"),_trigger2=_interopRequireDefault(_trigger),_index=require("../tree/index.js"),_index2=_interopRequireDefault(_index),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_index3=require("../consts/index"),_index4=_interopRequireDefault(_index3),_objectUtils=require("@lugia/object-utils"),_FormFieldWidgetSupport=require("../common/FormFieldWidgetSupport"),_FormFieldWidgetSupport2=_interopRequireDefault(_FormFieldWidgetSupport),_QueryInput=require("../common/QueryInput"),_QueryInput2=_interopRequireDefault(_QueryInput),_select=require("../select"),_selectFunction=require("../common/selectFunction"),_input=require("../css/input");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _objectWithoutProperties(e,t){var r={};for(var n in e)0<=t.indexOf(n)||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var DefaultLimitCount=999999,TreeSelect=function(){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));_initialiseProps.call(t);var r=t.getInitValue(e),n=r.value,a=r.displayValue;return t.state={open:!1,query:"",validateStatus:"success",help:_input.DefaultHelp,treeFilter:"",value:n,displayValue:a,selectCount:n.length,current:-1,end:0,start:0,selectAll:!1,themeConfig:t.getCurrentTheme()},t.changeOldValue(n),t.treeVisible=!1,t.inputTag=_react2.default.createRef(),t}return _inherits(i,_react2.default.Component),_createClass(i,[{key:"getInitValue",value:function(e){var t=_FormFieldWidgetSupport2.default.getCodeItemArray(e),r=t.value,n=t.displayValue;return{value:r,displayValue:n&&0<n.length?n:[].concat(_toConsumableArray(r))}}},{key:"shouldComponentUpdate",value:function(e,t){var r=this.props;if(!0==(r.data!==e.data))return!0;var n=this.state;return n.query!==t.query||n.current!==t.current||n.treeFilter!==t.treeFilter||n.start!==t.start||n.selectAll!==t.selectAll||n.treeWidth!==t.treeWidth||r.disabled!==e.disabled||r.validateStatus!==e.validateStatus||r.help!==e.help||r.mutliple!==e.mutliple||r.svThemVersion!==e.svThemVersion||n.selectCount!==t.selectCount||n.value!==t.value||n.displayValue!==t.displayValue}},{key:"componentWillReceiveProps",value:function(e){if(!_FormFieldWidgetSupport2.default.isNotLimit(e)){var t=e.value,r=void 0===t?[]:t;if(this.changeOldValue(r),e.value!==this.props.value||e.displayValue!==this.props.displayValue){var n=this.getInitValue(e),a=n.value,i=n.displayValue;this.setState({value:a,displayValue:i,selectCount:a.length})}this.props.svThemVersion!==e.svThemVersion&&this.setState({themeConfig:this.getCurrentTheme()})}}},{key:"getInner",value:function(e,t){var r=this,n=e.data,a=e.disabled,i=e.help,u=e.validateStatus,l=e.placeholder,o=e.canSearch,s=e.mutliple,c=e.canInput,p=e.igronSelectField,h=e.valueField,g=e.displayField,d=e.expandAll,f=e.translateTreeData,y=e.createPortal,v=e.renderSuffixItems,m=e.onRightClick,T=(e.onSelect,_objectWithoutProperties(e,["onSelect"])),C=t.current,_=t.start,V=t.treeFilter,I=t.value,b=t.displayValue,S=t.query,k=t.selectAll,q=[n&&0!==n.length?_react2.default.createElement(_QueryInput2.default,{query:S,onQueryInputChange:this.onQueryInputChange,onQueryInputKeyDown:this.onQueryInputKeyDown,refreshValue:this.onRefresh,addClick:this.onAdd,isCheckedAll:k,onCheckAll:this.onSelectAll,canSearch:o,mutliple:s,canInput:c}):null,_react2.default.createElement(_index2.default,Object.assign({data:n,key:"tree"},T,this.getTreeTheme(),{current:C,start:_,expandAll:d,onScroller:this.onScroller,query:V,ref:function(e){r.treeCmp=e},value:I,onChange:this.onTreeChange,valueField:h,displayField:g,displayValue:b,igronSelectField:p,translateTreeData:f,renderSuffixItems:v,onRightClick:m}))];return _react2.default.createElement(_theme2.default,{config:this.getInputtagTheme()},_react2.default.createElement(_trigger2.default,{themePass:!0,popup:q,onPopupVisibleChange:this.onTreePopupVisibleChange,align:"bottomLeft",key:"trigger",offsetY:4,ref:function(e){r.treeTriger=e},createPortal:y,action:a?[]:["click"],hideAction:["click"]},_react2.default.createElement(_inputtag2.default,{key:"inputtag",help:i,validateStatus:u,onFocus:this.onFocus,disabled:a,value:I,displayValue:b,onChange:this.onInputTagChange,mutliple:this.isMutliple(),placeholder:l,ref:this.inputTag,createPortal:y,onClear:this.onClear,onPopupVisibleChange:this.onInputTagPopupVisibleChange})))}},{key:"setPopupVisible",value:function(){var e;this.treeTriger&&(e=this.treeTriger).setPopupVisible.apply(e,arguments)}},{key:"render",value:function(){var e=this.props,t=this.state;return this.getInner(e,t)}},{key:"isMutliple",value:function(){return this.props.mutliple}},{key:"isCanInput",value:function(){return this.props.canInput}},{key:"getCurrentRow",value:function(){var e=this.getTree().getViewData();return e&&e[this.state.current]?e[this.state.current]:null}},{key:"appendValue",value:function(){var e=this.props,t=this.state,r=t.query,n=t.value,a=t.displayValue;if(r&&r.trim()&&this.isCanInput()&&!this.isLimit()){clearTimeout(this.queryHandle);var i=(0,_selectFunction.appendCustomValue)(e,r,n,a),u=i.newValue,l=i.newDisplayValue;this.setValue([].concat(_toConsumableArray(u)),[].concat(_toConsumableArray(l)),{}),this.onQueryInputChange("")}}},{key:"isLimit",value:function(){var e=this.props.limitCount,t=void 0===e?DefaultLimitCount:e;return this.state.value.length>=t}},{key:"componentDidUpdate",value:function(){this.props.disabled&&this.setTreePopupVisible(!1),this.setState({selectAll:this.isSelectAll()})}},{key:"canSelect",value:function(e){var t=this.getTree();return t&&t.canSelect(e)}},{key:"getNotInTree",value:function(){var e=this.getTree();return e?e.getNotInTree():{}}},{key:"getInTree",value:function(){var e=this.getTree();return e?e.getInTree():{}}},{key:"getViewData",value:function(){return this.treeCompontIsEmpty()?[]:this.getTree().getViewData()}},{key:"getQueryData",value:function(){return this.treeCompontIsEmpty()?[]:this.getTree().getQueryData()}},{key:"getTree",value:function(){return this.treeCmp.innerTree.current.getThemeTarget()}},{key:"isSelectAll",value:function(){return!this.treeCompontIsEmpty()&&this.getTree().isSelectAll()}},{key:"treeCompontIsEmpty",value:function(){return!this.treeCmp||!this.treeCmp.innerTree.current}},{key:"getInputTagCount",value:function(){var e=this.getInputTag();return e?e.getCount():0}},{key:"getInputTagValueObject",value:function(){var e=this.getInputTag();return e?e.getValueObject():{}}},{key:"getInputTag",value:function(){return this.inputTag?this.inputTag.current.getThemeTarget():null}},{key:"setValue",value:function(e,t,r,n){var a=3<arguments.length&&void 0!==n?n:function(){};if(this.onChange(e,t),_FormFieldWidgetSupport2.default.isNotLimit(this.props)){var i=(0,_selectFunction.setNewValue)(e,t),u=i.realyVal,l=i.realDisp;this.setState(Object.assign({value:u,displayValue:l},r,{selectCount:u.length}),a),this.changeOldValue(e)}}},{key:"setTreePopupVisible",value:function(e){this.treeTriger&&this.treeTriger.getThemeTarget()&&this.treeTriger.getThemeTarget().setPopupVisible(e)}},{key:"getRows",value:function(e){var t=0<arguments.length&&void 0!==e?e:[];if(!t||t.length<=0)return[];var r=this.getTree();return r?r.getRows(t):[]}},{key:"changeOldValue",value:function(e){this.oldValue=e}},{key:"getCurrentTheme",value:function(){return(0,_selectFunction.getTheme)(this.props,_index4.default.Tree)}},{key:"componentDidMount",value:function(){var e=this.inputTag.current.getThemeTarget().container.offsetWidth;this.setState({treeWidth:e})}},{key:"componentDidCatch",value:function(){this.setState({start:0})}}]),i}();TreeSelect.defaultProps={getTheme:function(){return{}},mutliple:!1,onlySelectLeaf:!0,canInput:!1,valueField:"value",displayField:"text",mode:"local",createPortal:!0,throttle:200,disabled:!1,canSearch:!1,expandAll:!1,translateTreeData:!1};var _initialiseProps=function(){var k=this;this.mergeTheme=function(e,t){var r=k.props.getPartOfThemeHocProps(e),n=r.viewClass,a=r.theme;return{viewClass:n,theme:(0,_objectUtils.deepMerge)(_defineProperty({},n,Object.assign({},t)),a)}},this.getContainerWidth=function(){return k.state.treeWidth},this.getTreeTheme=function(){var e={Container:{normal:{width:k.getContainerWidth()}}};return k.mergeTheme("Tree",e)},this.onClear=function(e){var t=k.props.onClear;t&&t(e)},this.getInputtagTheme=function(){var e=k.props.getPartOfThemeConfig;return _defineProperty({},_index4.default.InputTag,{InputTagWrap:e("Container"),TagWrap:e("TagWrap"),TagIcon:e("TagIcon"),SwitchIcon:e("SwitchIcon"),ClearIcon:e("ClearIcon"),Placeholder:e("Placeholder"),Menu:e("InputMenu")})},this.onFocus=function(){},this.onClearQuery=function(){k.onQueryInputChange("")},this.onRefresh=function(e){var t=k.props;k.onQueryInputChange(""),k.setValue([],[],{start:0});var r=t.onRefresh;r&&r(e)},this.onQueryInputKeyDown=function(e){13===e.keyCode&&k.appendValue(),40===e.keyCode&&k.setState({current:Math.min(k.state.current+1,k.getViewData().length-1)}),38===e.keyCode&&k.setState({current:Math.max(k.state.current-1,0)});var t=37===e.keyCode,r=k.getTree();if(r){var n=k.getCurrentRow();if(n){var a=n.key,i=n.isLeaf;if(t){if(void 0!==i&&i)return;r.collapse(a)}39===e.keyCode&&r.expand(a);var u=16===e.keyCode,l=17===e.keyCode;(u||l)&&(k.isMutliple()?r.check(a,!r.isChecked(a),u):r.select([a]))}}},this.onAdd=function(){k.appendValue()},this.getItems=function(r){if(0===r.length)return[];var e=k.props,t=e.data,n=void 0===t?[]:t,a=e.valueField;return n.filter(function(e){var t=e[a];return-1!==r.indexOf(t)})},this.expandOnSelect=function(e,t){var r=k.props.onSelect,n=k.getItems(e);r&&r(e,t,n)},this.onSelectAll=function(){var e=!k.isSelectAll(),t=k.props,r=t.displayField,n=t.valueField;if(!0==e){var a=k.getQueryData(),i=k.state,u=i.value,l=i.displayValue,o=[].concat(_toConsumableArray(u)),s=[].concat(_toConsumableArray(l)),c=0,p=k.props.limitCount,h=void 0===p?DefaultLimitCount:p;h-=o.length;for(var g=k.getInTree(),d=0;d<a.length;d++){var f=a[d],y=f[n],v=f[r];if(!g[y]){if(h<=c)break;k.canSelect(y)&&(o.push(y),s.push(v),c++)}}k.expandOnSelect(o,s),k.setValue(o,s,{})}else{for(var m=k.getInputTagValueObject(),T=k.getQueryData(),C=T.length,_=0;_<C;_++){var V=T[_][n];m[V]&&delete m[V]}for(var I=Object.keys(m),b=[],S=0;S<I.length;S++)b.push(m[I[S]][r]);k.expandOnSelect([],[]),k.setValue(I,b,{})}},this.onQueryInputChange=function(e){var t=e.newValue,n=t||"";if(n!==k.state.query){k.queryHandle&&clearTimeout(k.queryHandle),k.setState({query:n});var r=function(){var e=k.props,t=e.onQuery,r=e.mode;t&&t(n),"local"===r?k.setState({treeFilter:n}):k.setState({treeFilter:""})},a=k.props.throttle,i=void 0===a?-1:a;0<i?k.queryHandle=setTimeout(r,i):r()}},this.onInputTagPopupVisibleChange=function(e){e&&k.setTreePopupVisible(!1)},this.onTreePopupVisibleChange=function(e){var t=k.state;if(e){var r=k.props.onTrigger;r&&r();var n=t.selectCount;k.isMutliple()&&(n=k.getInputTagCount()),k.onQueryInputChange(""),k.setState({selectCount:n},function(){k.queryInput&&k.queryInput.getThemeTarget()&&k.queryInput.getThemeTarget().focus()})}k.treeVisible=e},this.onInputTagChange=function(e){var t=e.value,r=e.displayValue;k.setValue(t,r,{})},this.onTreeChange=function(e,t){k.expandOnSelect(e,t),k.setValue(e,t,{},function(){k.isMutliple()||k.setTreePopupVisible(!1)})},this.onChange=function(e,t){var r=k.props.mutliple;if((0!==k.oldValue.length||0!==e.length)&&(k.oldValue!==e&&!(e&&k.oldValue&&e.toString()===k.oldValue.toString()))){if(k.oldValue!==e){var n=k.props.onChange,a=(0,_select.getNewValueOrOldValue)(k.getItems(e),r),i=(0,_select.getNewValueOrOldValue)(k.getItems(k.oldValue),r),u={newValue:e,oldValue:k.oldValue,newItem:a,oldItem:i,newDisplayValue:t};n&&n(u)}r||k.setTreePopupVisible(!1)}},this.onScroller=function(e){k.setState({start:e})}};exports.default=(0,_themeHoc2.default)(TreeSelect,_index4.default.TreeSelect,{hover:!0});