"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports._InputTag_=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_templateObject=_taggedTemplateLiteral(["\n  top: 50%;\n  right: ",";\n  position: absolute;\n  transform: translateY(-50%);\n  font-size: ",";\n  color: ",";\n"],["\n  top: 50%;\n  right: ",";\n  position: absolute;\n  transform: translateY(-50%);\n  font-size: ",";\n  color: ",";\n"]);require("../common/shirm");var _react=require("react"),React=_interopRequireWildcard(_react),_styledComponents=require("styled-components"),_styledComponents2=_interopRequireDefault(_styledComponents),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_ItemOption=require("./ItemOption"),_ItemOption2=_interopRequireDefault(_ItemOption),_icon=require("../icon"),_icon2=_interopRequireDefault(_icon),_MoreItem=require("./MoreItem"),_MoreItem2=_interopRequireDefault(_MoreItem),_FontItem=require("./FontItem"),_FontItem2=_interopRequireDefault(_FontItem),_objectUtils=require("@lugia/object-utils"),_NumberUtils=require("../common/NumberUtils"),_index=require("../consts/index"),_index2=_interopRequireDefault(_index),_props2=require("../consts/props"),_dropmenu=require("../dropmenu"),_dropmenu2=_interopRequireDefault(_dropmenu),_menu=require("../menu"),_menu2=_interopRequireDefault(_menu),_FormFieldWidgetSupport=require("../common/FormFieldWidgetSupport"),_FormFieldWidgetSupport2=_interopRequireDefault(_FormFieldWidgetSupport),_PlaceContainer=require("../common/PlaceContainer"),_PlaceContainer2=_interopRequireDefault(_PlaceContainer),_input=require("../css/input"),_menu3=require("../css/menu"),_inputtag=require("../css/inputtag"),_ErrorTip=require("../tooltip/ErrorTip"),_ErrorTip2=_interopRequireDefault(_ErrorTip),_units=require("../css/units");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var u=e.apply(this,arguments);return new Promise(function(a,o){return function t(e,r){try{var n=u[e](r),i=n.value}catch(e){return void o(e)}if(!n.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});a(i)}("next")})}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _taggedTemplateLiteral(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var ClearMenuItemButton=(0,_styledComponents2.default)(_icon2.default)(_templateObject,(0,_units.px2remcss)(_inputtag.FontSize),(0,_units.px2remcss)(16),_inputtag.lightGreyColor),InputTag=function(){function t(e){_classCallCheck(this,t);var l=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return l.onQueryInput=function(e){var t=e.newValue,r=t||"";l.setState({query:r})},l.onFocus=function(){l.setState({focus:!0},function(){var e=l.props.onFocus;e&&e()})},l.onBlur=function(){l.setState({focus:!1},function(){var e=l.props.onBlur;e&&e()})},l.onClick=function(e){var t=l.props.onClick;t&&t(e)},l.mergeTheme=function(e,t){var r=l.props.getPartOfThemeHocProps(e),n=r.viewClass,i=r.theme;return{viewClass:n,theme:(0,_objectUtils.deepMerge)(_defineProperty({},n,Object.assign({},t)),i)}},l.getInputTagMenuTheme=function(){var e=(0,l.props.getPartOfThemeConfig)("InputTagWrap").normal,t=(void 0===e?{}:e).width,r={Container:{normal:{width:void 0===t?250:t}},MenuItem:{MenuItemWrap:{normal:{color:"#222"},hover:{color:"#222",background:{color:""}}}}};return l.mergeTheme("Menu",r)},l.onClear=function(e){var t=l.props,r=t.disabled,n=t.onClear;r||(n&&n(e),l.onChange([],[]),e.preventDefault(),e.stopPropagation(),l.isLimit()||l.setState({value:{}},function(){l.adaptiveItems(l.getOffSetWidth()),l.count=0}))},l.getIcon=function(e){var t=e[_props2.ValueField];return React.createElement(ClearMenuItemButton,{iconClass:"lugia-icon-reminder_close",onClick:l.onDelItem.bind(l,t),key:t})},l.onDelItem=function(e,t){if(t.preventDefault(),t.stopPropagation(),!l.props.disabled){var r=l.state.value;if(r&&r[e]){l.count--,l.count<0&&(l.count=0);for(var n=l.getKeys(r),i=[],a=[],o=n.length,u=0;u<o;u++){var s=n[u];s!==e&&(i.push(s),a.push(r[s].text))}l.onChange(i,a),l.isLimit()||(delete r[e],l.resetValueKeys(),l.adaptiveItems(l.getOffSetWidth()))}}},l.onChange=function(e,t){var r=l.props.onChange;r&&r({value:e,displayValue:t})},l.onMoreClick=function(e){l.setPopupVisible(!0),e.preventDefault(),e.stopPropagation()},l.onPopupVisibleChange=function(e){var t=l.props.onPopupVisibleChange;!0===e&&l.setState({visible:e}),t&&t(e)},l.count=0,l.state={focus:!1,items:[],query:"",popupVisible:!1,value:l.fetchValueObject(e)},l.fontItem=React.createRef(),l}var r;return _inherits(t,React.Component),_createClass(t,[{key:"isMutliple",value:function(){return!!this.props.mutliple}}]),_createClass(t,[{key:"shouldComponentUpdate",value:function(e,t){var r=this.props,n=this.state;return n.items!==t.items||r.value!==e.value||r.value.length!==e.value.length||r.svThemVersion!==e.svThemVersion||r.mutliple!==e.mutliple||r.validateStatus!==e.validateStatus||r.help!==e.help||r.disabled!==e.disabled||this.needMoreItem&&n.query!==t.query||n.value!==t.value||n.focus!==t.focus||r.displayValue!==e.displayValue||r.displayValue.length!==e.displayValue.length}},{key:"fetchValueObject",value:function(e){var t={},r=this.getValue(e),n=r.value,i=void 0===n?[]:n,a=r.displayValue,o=void 0===a?[]:a,u=!i||0===i.length;if(!1===this.isMutliple())return u?{}:(this.count=1,{text:o===[]?i:o});for(var s=i.length,l=0;l<s;l++){var c=i[l];if(""!==c){var p=o[l];t[c]={text:p||c}}}return this.count=s,t}},{key:"getCount",value:function(){return this.count}},{key:"getValueObject",value:function(){return this.state.value}},{key:"getValue",value:function(e){return _FormFieldWidgetSupport2.default.getCodeItemArray(e)}},{key:"isLimit",value:function(){var e=this.props;return!_FormFieldWidgetSupport2.default.isNotLimit(e)}},{key:"componentWillReceiveProps",value:function(e){var t=this;if(this.isLimit()&&e.value!==this.props.value){var r=this.fetchValueObject(e);this.setState({value:r},function(){t.adaptiveItems(t.getOffSetWidth())})}}},{key:"render",value:function(){var t=this,e=this.props,r=this.state,n=void 0,i=this.getClearButton(),a=this.getPlaceholder(),o=e.getPartOfThemeProps("TagWrap"),u=React.createElement(_FontItem2.default,{themeProps:o,theme:this.getTagItemTheme(),ref:this.fontItem,key:"fontItem"}),s=r.focus,l=e.disabled,c=e.validateStatus,p=e.prefix,f=e.suffix,h=e.getPartOfThemeProps,m=e.createPortal,g=h("InputTagWrap");if(this.isMutliple()){var d=r.items;if(n=this.generateOutter(React.createElement(_inputtag.InnerContainer,{themeProps:g},React.createElement(_inputtag.FlexResBox,null,React.createElement(_inputtag.List,{ref:function(e){return t.list=e}},d),a,React.createElement(_inputtag.FocuInput,{onFocus:this.onFocus,onBlur:this.onBlur})),i)),this.needMoreItem){var v=r.query;n=React.createElement(_dropmenu2.default,{menus:this.getItems(v),onQuery:this.onQueryInput,onPopupVisibleChange:this.onPopupVisibleChange,action:[],query:v,hideAction:["click"],ref:function(e){t.dropMenu=e},createPortal:m},n)}}else n=this.generateOutter(React.createElement(_inputtag.SingleInnerContainer,{disabled:l},React.createElement(_inputtag.FlexResBox,null,p?React.createElement(_inputtag.Prefix,null,p):null,a,this.getSingleValue(),React.createElement(_inputtag.FocuInput,null)),f?React.createElement(_inputtag.Suffix,null,f):null,i));return React.createElement(_inputtag.OutContainer,{themeProps:g,focus:s,disabled:l,validateStatus:c,ref:function(e){return t.container=e},onClick:this.onClick},React.createElement(_inputtag.HiddenList,null,React.createElement(_inputtag.List,null,u)),n)}},{key:"generateOutter",value:function(e){var t=this,r=this.props;if("success"===r.validateStatus)return e;var n=r.help;return React.createElement(_ErrorTip2.default,{title:n,action:["click"],placement:"right",ref:function(e){t.errorTip=e}},e)}},{key:"getClearButton",value:function(){var e=this.props,t=e.canClear,r=e.pullIconClass,n=e.getPartOfThemeHocProps,i=e.clearIconClass,a=e.disabled;if(!e.isShowClearButton)return null;var o=this.isEmpty()||!t?n("SwitchIcon"):n("ClearIcon");return this.isEmpty()||!t?React.createElement(_inputtag.CommonIcon,Object.assign({},o,{disabled:a,singleTheme:!0,iconClass:r})):React.createElement(_inputtag.CommonIcon,Object.assign({},o,{disabled:a,singleTheme:!0,iconClass:i,onClick:this.onClear}))}},{key:"getPlaceholder",value:function(){var e=this.props.placeholder;return e&&this.isEmpty()?React.createElement(_PlaceContainer2.default,{themeProps:this.props.getPartOfThemeProps("Placeholder")},e):null}},{key:"isEmpty",value:function(){return this.isMutliple()?this.state.items.length<=0:""===this.getSingleValue()}},{key:"getSingleValue",value:function(){var e=this.state.value,t=(void 0===e?{}:e).text;return void 0===t?"":t}},{key:"getFontWidth",value:function(e){return this.fontItem.current.getWidth(e)}},{key:"getItems",value:function(e){var t=this.state.value,r=[];if(t)for(var n=this.getKeys(t),i=n.length,a=0;a<i;a++){var o=n[a],u=t[o].text;""!==e&&-1==u.indexOf(e)||r.push({value:o,text:u})}return React.createElement(_menu2.default,Object.assign({},this.getInputTagMenuTheme(),{data:r,step:30,getSuffix:this.getIcon}))}},{key:"getKeys",value:function(e){return e!=this.oldValue&&(this.valueKeys=Object.keys(e),this.oldValue=e),this.valueKeys}},{key:"resetValueKeys",value:function(){this.oldValue=void 0}},{key:"componentDidMount",value:function(){var e=this.getOffSetWidth();this.oldWidth=e,this.adaptiveItems(e)}},{key:"componentDidUpdate",value:function(){var e=this.getOffSetWidth();e!==this.oldWidth&&(this.oldWidth=e,this.adaptiveItems(e))}},{key:"getOffSetWidth",value:function(){return this.isMutliple()?this.list.offsetWidth:0}},{key:"getHeight",value:function(){var e=(0,this.props.getTheme)().height;return void 0===e?_menu3.DefaultHeight:e}},{key:"getTagMargin",value:function(){var e=(0,this.props.getPartOfThemeConfig)("TagWrap").normal,t=(e=void 0===e?{}:e).margin;if(!t)return 5;var r=t.left,n=t.right;return(0,_NumberUtils.toNumber)(r,0)+(0,_NumberUtils.toNumber)(n,0)}},{key:"getTagPadding",value:function(){var e=(0,this.props.getPartOfThemeConfig)("TagWrap").normal,t=(e=void 0===e?{}:e).padding;if(!t)return 10;var r=t.left,n=t.right;return(0,_NumberUtils.toNumber)(r,0)+(0,_NumberUtils.toNumber)(n,0)}},{key:"getTagFontSize",value:function(){var e=(0,this.props.getPartOfThemeConfig)("TagWrap").normal,t=(e=void 0===e?{}:e).font,r=(t=void 0===t?{}:t).size;return(0,_NumberUtils.isNumber)(r)?r:_inputtag.FontSize}},{key:"getTagWidth",value:function(){var e=(0,this.props.getPartOfThemeConfig)("TagWrap").normal,t=(e=void 0===e?{}:e).width;if(t&&(0,_NumberUtils.isNumber)(t))return t}},{key:"getMoreItemWidth",value:function(){var e=this.getTagMargin(),t=this.getTagWidth();return t?t+e:e+this.getTagPadding()+this.getTagFontSize()}},{key:"adaptiveItems",value:(r=_asyncToGenerator(_regenerator2.default.mark(function e(t){var r,n,i,a,o,u,s,l,c,p,f;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isMutliple()){e.next=2;break}return e.abrupt("return",!0);case 2:if(r=[],!(n=this.state.value)){e.next=32;break}i=this.getMoreItemWidth(),t-=i,a=0,o=this.getKeys(n),u=o.length,s=0;case 11:if(!(s<u)){e.next=29;break}if(l=o[s],c=n[l]){e.next=16;break}return e.abrupt("return",!1);case 16:return p=c.text,e.next=19,this.getFontWidth(p);case 19:if(f=e.sent,a+=f+this.getTagMargin(),t<a)return e.abrupt("break",29);e.next=25;break;case 25:r.push(React.createElement(_ItemOption2.default,{theme:this.getTagItemTheme(),key:l,onCloseClick:this.onDelItem.bind(this,l)},p));case 26:s++,e.next=11;break;case 29:this.needMoreItem=!1,u!==r.length&&(this.needMoreItem=!0),this.needMoreItem&&r.push(this.getMoreItem());case 32:return this.setState({items:r}),e.abrupt("return",!0);case 34:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"getMoreItem",value:function(){return React.createElement(_MoreItem2.default,{theme:this.getTagItemTheme(),themeProps:this.props.getPartOfThemeProps("TagWrap"),items:this.props.value,onClick:this.onMoreClick,key:"more_item"})}},{key:"getTagItemTheme",value:function(){var e=this.props.getPartOfThemeConfig;return{ItemTag:{TagWrap:e("TagWrap"),TagIcon:e("TagIcon")}}}},{key:"setPopupVisible",value:function(){var e;this.dropMenu&&(e=this.dropMenu).setPopupVisible.apply(e,arguments)}}]),t}();InputTag.displayName=_index2.default.InputTag,InputTag.defaultProps={getTheme:function(){return{}},mutliple:!0,disabled:!1,validateStatus:"success",help:_input.DefaultHelp,canClear:!0,pullIconClass:"lugia-icon-direction_down",clearIconClass:"lugia-icon-reminder_close"};var InputTagBox=(0,_themeHoc2.default)(InputTag,_index2.default.InputTag,{hover:!0}),_InputTag_=exports._InputTag_=InputTag;exports.default=InputTagBox;