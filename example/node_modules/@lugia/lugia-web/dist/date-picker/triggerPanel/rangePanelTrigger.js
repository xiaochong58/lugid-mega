"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function r(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_moment=require("moment"),_moment2=_interopRequireDefault(_moment),_SwitchPanel=require("../switchPanel/SwitchPanel"),_SwitchPanel2=_interopRequireDefault(_SwitchPanel),_index=require("../../trigger/index"),_index2=_interopRequireDefault(_index),_RangeInput=require("../panel/RangeInput"),_RangeInput2=_interopRequireDefault(_RangeInput),_PageFooter=require("../panel/PageFooter"),_PageFooter2=_interopRequireDefault(_PageFooter),_getDerived=require("../utils/getDerived"),_styled=require("../styled/styled"),_mode=require("../mode"),_mode2=_interopRequireDefault(_mode),_differUtils=require("../utils/differUtils"),_booleanUtils=require("../utils/booleanUtils"),_utils=require("../utils/utils"),_themeConfig=require("../themeConfig/themeConfig"),_themeHoc=require("@lugia/theme-hoc");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Range=function(){function t(e){_classCallCheck(this,t);var p=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return p.getDatePanelValue=function(e){var a=p.state.format,t=p.monthAndYear,r=[];t.forEach(function(e,t){r.push((0,_moment2.default)(e).format(a))});var n=""!==e[0]||""!==e[1]?[].concat(_toConsumableArray(e)):r,o=(0,_booleanUtils.getIsSame)(n,a).isSameYandM,i=(0,_moment2.default)().date(),l=p.getIsValid(n).isValid;if(o){var s=(0,_moment2.default)(n[0],a).set({date:i}).add({month:1}).format(a);n[1]=s}return{panelfreshValue:n,isValid:l}},p.onClickTrigger=function(e,t,a){if((!p.isClear||!t)&&"showTime"!==p.state.status){var r=p.state,n=r.value,o=r.format;p.getIsValid(n).isValid&&p.drawPageAgain(n,o);var i=p.monthAndYear;p.setTargetMode(i),p.setPopupVisible(t),p.setState({visible:t})}},p.onChange=function(e){if(!p.isClear){var t=e.newValue,a=e.oldValue,r=e.number,n=e.event,o=p.getIsValid(t),i=o.formatIsValids,l=o.isValid,s=!0;l&&(p.oldValue=[].concat(_toConsumableArray(t)),p.oldMonthandYear=[].concat(_toConsumableArray(p.monthAndYear)),s=!1),p.setPopupVisible(s);var u=p.oldValue&&""!==p.oldValue[0]&&""!==p.oldValue,d=l?t:u?p.oldMonthandYear:i[r]?[t[r],t[r]]:[],g=p.state.format;i[r]&&(p.choseDate=d[0]);var c=""===t[0]&&""===t[1];p.setState({value:t,rangeValue:l||u||c?[]:d,visible:s},function(){var e=p.state,t=e.panelValue,a=e.isHover;!i[r]&&a||(p.monthAndYear=[].concat(_toConsumableArray(!l&&u?d:t)),p.panelDatesArray=(0,_differUtils.getCurrentPageDates)(p.monthAndYear,g),i[r]&&p.setTargetMode(p.monthAndYear),i[r]&&p.drawPageAgain(d,g))});var f=p.props.onChange;f&&f({newValue:t,oldValue:a,event:n}),c&&p.drawPageAgain(["",""],p.state.format)}},p.getIsValid=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],r=p.normalStyleValueObj,n=p.state.format,o=[],i=!0;return Array.isArray(e)&&e.forEach(function(e,t){var a=(0,_booleanUtils.formatValueIsValid)(r,e,n);o.push(a),a||(i=!1)}),{formatIsValids:o,isValid:i}},p.onChangeFirst=function(e){p.panelChange(Object.assign({},e,{index:0}))},p.onChangeSecond=function(e){p.panelChange(Object.assign({},e,{index:1}))},p.panelChange=function(e){var t=!(p.isClear=!1),a=e.newValue,r=e.event,n=p.state.format,o=p.state.rangeValue,i=0<o.length?[o[0]]:[];i.push(a);var l=i.length,s=[],u=void 0;if(1===l&&(s=[i[0],i[0]],u={hasNormalvalue:!0,rangeValue:i}),2===l){s=[].concat(i);var d=p.props,g=d.onOk,c=d.showTime;t=!1,(g||c)&&(t=!0);var f=p.getIsValid(s).isValid,h=p.props.onChange,m=p.getSortValue(s,n);f&&h&&h({newValue:m,oldValue:p.changeOldValue,event:r}),u={value:m,rangeValue:[],isHover:!1}}p.setPopupVisible(t),p.drawPageAgain(s,n),p.setState(u)},p.getSortValue=function(e,t){var a=(0,_moment2.default)(e[0],t),r=(0,_moment2.default)(e[1],t);return[_moment2.default.min(a,r).format(t),_moment2.default.max(a,r).format(t)]},p.setTargetMode=function(e){var t=p.state.status;p.targetModeFirst.onChange({value:e[0],isScroll:!1,status:t}),p.targetModeSecond.onChange({value:e[1],isScroll:!1,status:t})},p.rangeHoverChange=function(e){var t=p.state,a=t.value,r=t.format,n=t.rangeValue,o=p.getIsValid(a).formatIsValids;!a[0]&&!a[1]||""!==a[0]&&""!==a[1]||a.forEach(function(e,t){o[t]&&(p.validValue=e),e&&!o[t]&&(a[t]=p.validValue,n[0]=p.validValue)});var i=e.choseValue,l=[n[0],i];p.setState({rangeValue:l,isHover:!0}),p.drawPageAgain(l,r)},p.getCurrentYandM=function(e){var t=e.month,a=e.year,r=e.index,n=(0,_moment2.default)().set({month:t,year:a}).format("YYYY-MM"),o=p.monthAndYear;o[r]=n;var i=p.state.format;p.panelDatesArray=(0,_differUtils.getCurrentPageDates)(o,i);var l=p.state,s=l.rangeValue,u=l.value,d=0<s.length?s:u;s&&p.drawPageAgain(d,i)},p.setTriggerVisible=function(e){p.setPopupVisible(e)},p.onFocus=function(){var e=p.state,t=e.value,a=e.panelValue,r=e.status,n=p.getIsValid(t).isValid;p.isClear=!1,p.changeOldValue=[].concat(_toConsumableArray(t));var o=p.state.format;n&&(p.oldValue=[].concat(_toConsumableArray(t)),p.oldMonthandYear=[].concat(_toConsumableArray(p.monthAndYear)),p.monthAndYear=[].concat(_toConsumableArray(a)),p.panelDatesArray=(0,_differUtils.getCurrentPageDates)(a,o),p.setState({rangeValue:[]})),""===t[0]&&""===t[1]&&(p.setState({rangeValue:[]}),p.drawPageAgain(["",""],p.state.format)),"showTime"===r&&(p.pageFooterChange.onFocus({status:"showTime"}),p.setState({status:"showDate"})),p.onClickTrigger(!0);var i=p.props.onFocus;i&&i()},p.onBlur=function(e){var t=p.state.value,a=p.getIsValid(t),r=a.isValid,n=a.formatIsValids,o=""!==t[0]&&""!==t[1];if(""===t[0]&&""===t[1]&&(p.oldValue=["",""]),o&&!r){var i=p.oldValue[0]&&p.oldValue[1]?p.oldValue:p.changeOldValue?p.changeOldValue:["",""];p.setState({value:i})}!t[0]&&!t[1]||""!==t[0]&&""!==t[1]||n[e]||(t[e]="",p.setState({value:t}));var l=p.props.onBlur;l&&l()},p.onClear=function(e){var t=["",""];p.oldValue=["",""],p.isClear=!0,p.setState({value:t,hasNormalvalue:!1},function(){p.setPopupVisible(!1)});var a=p.props.onChange,r=p.state.value;a&&a({newValue:t,oldValue:[].concat(_toConsumableArray(r)),event:e})},p.footerChange=function(e){var t=!0,a=void 0;if("onOk"===e){t=!1,a={status:"showDate"};var r=p.props.onOk,n="function"==typeof r?r:r&&r.Function?r.Function:"";n&&n()}if("onOk"!==e){t=!0;var o=p.state,i=o.value,l=o.panelValue;"showTime"===e&&p.setTargetMode(i),"showDate"===e&&p.setTargetMode(l),"showDate"===e&&p.drawPageAgain(i,p.state.format),a={status:e}}p.setPopupVisible(t),p.setState(Object.assign({},a,{visible:t,rangeValue:[]}))},p.timeChange=function(e){var t=e.keys,a=e.timeIndex,r=e.value;p.times=t;var n=p.state.value,o=[].concat(_toConsumableArray(n));o[a]=r,p.setState({value:o})},p.drawPageAgain=function(e,t){var a=p.monthAndYear,r=p.panelDatesArray,n=(0,_differUtils.getIndexInRange)(e,a,r,t),o=n.rangeIndex,i=n.choseDayIndex;p.setState({rangeIndex:o,choseDayIndex:i})},p.trigger=_react2.default.createRef(),p.monthAndYear=[],p.isClear=!0,p.oldValue=["",""],p.targetModeFirst=new _mode2.default,p.targetModeSecond=new _mode2.default,p.pageFooterChange=new _mode2.default,p}return _inherits(t,_react.Component),_createClass(t,[{key:"componentDidMount",value:function(){var e=this.state,t=e.format,a=e.panelValue,r=(0,_moment2.default)().format(t);this.normalStyleValueObj=(0,_utils.getformatSymbol)(r),this.monthAndYear=[].concat(_toConsumableArray(a)),this.panelDatesArray=(0,_differUtils.getCurrentPageDates)(a,t)}},{key:"render",value:function(){var e=this.state,t=e.value,a=e.format,r=e.status,n=e.timeValue,o=e.visible,i=e.isClear,l=e.rangeIndex,s=e.choseDayIndex,u=e.rangeValue,d=e.valueIsValid,g=this.props,c=g.disabled,f=g.readOnly,h=g.theme,m=g.mode,p=g.getPartOfThemeProps,v=this.monthAndYear,_=!!d,V=(0,_differUtils.differMonthAndYear)(v),C=V.differAmonth,b=V.differAyear,y={panelChoseDate:u&&u[0],timeValue:n,rangeHoverChange:this.rangeHoverChange,getCurrentYandM:this.getCurrentYandM,differAmonth:C,differAyear:b,setTriggerVisible:this.setTriggerVisible,status:r,timeChange:this.timeChange,format:a},P=(0,_themeConfig.getFacePanelContain)({mode:m,getPartOfThemeProps:p}).themeProps;return _react2.default.createElement(_index2.default,{themePass:!0,createPortal:this.props.createPortal,popup:_react2.default.createElement(_styled.RangeWrap,Object.assign({},(0,_themeHoc.addMouseEvent)(this),h,{isTime:"showTime"===r,mode:m,themeProps:P}),_react2.default.createElement(_SwitchPanel2.default,Object.assign({},this.props,{value:v[0],onChange:this.onChangeFirst,index:0,timeIndex:0,hasTimeWrapBorder:!0},y,{rangeRenderIndex:l&&l[0],choseDayIndex:s&&s[0],model:this.targetModeFirst,timeValue:t[0],themeProps:P})),_react2.default.createElement(_SwitchPanel2.default,Object.assign({},this.props,{value:v[1],onChange:this.onChangeSecond,index:1,timeIndex:1},y,{rangeRenderIndex:l&&l[1],choseDayIndex:s&&s[1],model:this.targetModeSecond,timeValue:t[1],themeProps:P})),_react2.default.createElement(_PageFooter2.default,Object.assign({},this.props,{format:a,onChange:this.onChange,footerChange:this.footerChange,model:this.pageFooterChange,showTimeBtnIsDisabled:_}))),align:"bottomLeft",key:"trigger",ref:this.trigger,action:c||f?[]:["click"],hideAction:["click"]},_react2.default.createElement(_RangeInput2.default,Object.assign({},this.props,{placeholder:this.state.placeholder,value:t,onClick:this.onClickTrigger,onChange:this.onChange,onBlur:this.onBlur,onFocus:this.onFocus,onClear:this.onClear,disabled:c,readOnly:f,theme:h,visible:o,isClear:i})))}},{key:"setPopupVisible",value:function(){var e;this.trigger.current&&(e=this.trigger.current).setPopupVisible.apply(e,arguments)}}],[{key:"getDerivedStateFromProps",value:function(e,t){var a=(0,_getDerived.getDerivedForInput)(e,t),r=a.value,n=a.format,o=a.placeholder,i=a.panelValue,l=a.valueIsValid,s=!!t&&t.isHover;return{placeholder:o,value:r,panelValue:i,format:n,valueIsValid:l,visible:!!t&&t.visible,isClear:!!t&&t.isClear,rangeValue:t?t.rangeValue:[],status:t&&t.status,isHover:s}}}]),t}();Range.displayName="Range",exports.default=Range;