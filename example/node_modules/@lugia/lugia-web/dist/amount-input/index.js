"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_templateObject=_taggedTemplateLiteral(["\n    position: relative;\n    display: inline-block;\n  "],["\n    position: relative;\n    display: inline-block;\n  "]);require("../common/shirm");var _react=require("react"),_react2=_interopRequireDefault(_react),_index=require("../input/index"),_index2=_interopRequireDefault(_index),_index3=require("../consts/index"),_index4=_interopRequireDefault(_index3),_input=require("../css/input"),_reactDom=require("react-dom"),_tooltip=require("../tooltip"),_tooltip2=_interopRequireDefault(_tooltip),_utils=require("../utils"),_amountUtils=require("./amountUtils"),_KeyBoardEventAdaptor=require("../common/KeyBoardEventAdaptor"),_KeyBoardEventAdaptor2=_interopRequireDefault(_KeyBoardEventAdaptor),_Math=require("../common/Math"),_themeCssHoc=require("@lugia/theme-css-hoc"),_themeCssHoc2=_interopRequireDefault(_themeCssHoc),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc),_objectUtils=require("@lugia/object-utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _taggedTemplateLiteral(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}var InputContainer=(0,_themeCssHoc2.default)({tag:"span",className:"AmountInputContainer",normal:{defaultTheme:{width:"100%"},selectNames:[["width"],["height"],["margin"]]},css:(0,_themeCssHoc.css)(_templateObject)}),Title=(0,_themeCssHoc2.default)({tag:"span",className:"AmountInputTitle",normal:{selectNames:[["fontSize"],["font"],["color"]]}}),AmountInputPrefix=(0,_themeCssHoc2.default)({tag:"span",className:"AmountInputPrefix",normal:{selectNames:[["fontSize"],["color"]]}});Title.displayName="toolTip_title";var AmountTextBox=function(){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.handleChange=function(e){i.setValue((0,_Math.checkNumber)(e.newValue+"").replace(/^(\-)*(\d+)\.(\d\d\d).*$/,"$1$2.$3"),e.event)},i.onFocus=function(e){var t=i.props.onFocus;t&&t(e)},i.onBlur=function(e){var t=i.props.onBlur;t&&t(e)},i.onTransform=function(e){var t=i.props,r=t.disabled,o=t.onChange;if(!r){var n=i.state.value;if(o){var a=(0,_amountUtils.tipTool)((0,_amountUtils.parser)(n),_amountUtils.convertCurrency);o({event:e,newValue:i.state.rmb?n:a,oldValue:i.state.rmb?a:n})}i.setState({rmb:!i.state.rmb})}},i.onKeyDown=function(e){var t=i.props,r=t.onKeyDown,o=t.onEnter;r&&r(e);var n=e.keyCode;o&&13===n&&o(e)},i.preDisplayValue="",i.cursorPos=1,i.el=_react2.default.createRef(),i}return _inherits(t,_react.Component),_createClass(t,[{key:"componentDidUpdate",value:function(){var e=this.getInputDom(),t=this.props.amountPrefix;if(void 0!==this.preDisplayValue&&(0,_amountUtils.isAmount)(this.preDisplayValue)){this.preDisplayValue=this.preDisplayValue.startsWith(t)?this.preDisplayValue:t+this.preDisplayValue;var r=(0,_amountUtils.getNowPos)(this.preDisplayValue.substr(1),this.state.value,this.cursorPos-1)+1;this.cursorPos=r<=1||2===this.preDisplayValue.length?2:r,(0,_amountUtils.moveInputCursorPos)(e,this.cursorPos)}}},{key:"getInputDom",value:function(){return(0,_reactDom.findDOMNode)(this.el.current.getThemeTarget()).querySelector("input")}},{key:"setValue",value:function(e,t){this.updatePos();var r=this.state.value,o=this.props,n=o.disabled,a=o.onChange;this.preDisplayValue=(0,_amountUtils.isAmount)(e)?t.target.value:e;var i={newValue:Number(e),oldValue:Number(r),event:t};if("value"in this.props==!1){if(n)return;this.setState({value:e},function(){a&&a(i)})}else a&&a(i);e&&0!==e.length||this.setState({rmb:!1})}},{key:"updatePos",value:function(){this.cursorPos=(0,_amountUtils.getInputSelection)(this.getInputDom()).start}},{key:"render",value:function(){var e=this.state.value,t=this.props.getPartOfThemeHocProps("AmountTip"),r=t.theme,o=t.viewClass,n=(0,_objectUtils.deepMerge)(_defineProperty({},o,{Container:{normal:{getThemeMeta:function(e,t){var r=t.propsConfig.value;return{opacity:r&&r.length?1:0}}}}}),r),a=this.props.getPartOfThemeProps("Container");return _react2.default.createElement(_tooltip2.default,{propsConfig:{value:e},title:this.getTitle(),action:"focus",placement:"topLeft",popArrowType:"round",theme:n,viewClass:o},_react2.default.createElement(InputContainer,{themeProps:a},this.generateInput()))}},{key:"getTitle",value:function(){var e=this.state,t=e.value,r=e.rmb,o=this.props,n=o.amountPrefix,a=o.transform,i=o.themeProps,u="";u=n===_input.DefaultAmountPrefix?r?n+(0,_amountUtils.amountFormatter)(t):(0,_amountUtils.tipTool)((0,_amountUtils.parser)(t),_amountUtils.convertCurrency):n+(0,_amountUtils.amountFormatter)(t);var s=this.props.getPartOfThemeProps("TooltipTitle");return a?_react2.default.createElement(Title,{onClick:this.onTransform,themeProps:s},u):_react2.default.createElement(Title,{themeProps:i},u)}},{key:"generateInput",value:function(){var e=this.props,t=this.state,r=t.value,o=t.rmb,n=e.onKeyUp,a=e.onKeyPress,i=e.size,u=e.disabled,s=e.placeholder,l=this.getPrefix(),p=u?"":s,c=o?(0,_amountUtils.tipTool)((0,_amountUtils.parser)(r),_amountUtils.convertCurrency):(0,_amountUtils.amountFormatter)(r),m=this.props.getPartOfThemeHocProps("InnerInput"),f=m.theme,h=m.viewClass;return f[h].Container=(0,_objectUtils.deepMerge)(f[h].Container,this.props.getPartOfThemeProps("Container").themeConfig),_react2.default.createElement(_index2.default,{_maxLength:"16",theme:f,viewClass:h,ref:this.el,value:c,size:i,onKeyUp:n,onKeyPress:a,onKeyDown:this.onKeyDown,onFocus:this.onFocus,onBlur:this.onBlur,placeholder:p,onChange:this.handleChange,disabled:u,prefix:l,formatter:_amountUtils.amountFormatter,readOnly:o})}},{key:"getPrefix",value:function(){var e=this.props.amountPrefix,t=this.props.getPartOfThemeProps("AmountInputPrefix");return _react2.default.createElement(AmountInputPrefix,{themeProps:t},e)}}],[{key:"getDerivedStateFromProps",value:function(e,t){var r=e.value,o=e.defaultValue,n="value"in e;function a(e){return(!(0,_amountUtils.isAmount)(e)?(0,_amountUtils.converAmount)(e):e)+""}if(r=(0,_utils.fixControlledValue)(r),!t){var i=n?r:o||"",u=!(0,_amountUtils.isAmount)(i);return{value:a(i),rmb:u}}if(n)return{value:a(r),rmb:!(0,_amountUtils.isAmount)(r)}}}]),t}();AmountTextBox.defaultProps={disabled:!1,viewClass:_index4.default.AmountInput,size:"default",defaultValue:"",amountPrefix:_input.DefaultAmountPrefix,getTheme:function(){return{}},transform:!0},AmountTextBox.displayName=_index4.default.AmountInput;var TargetAmountTextBox=(0,_themeHoc2.default)((0,_KeyBoardEventAdaptor2.default)(AmountTextBox),_index4.default.AmountInput,{hover:!0,active:!0});exports.default=TargetAmountTextBox;