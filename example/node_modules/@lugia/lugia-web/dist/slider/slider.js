"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_utils=require("../utils"),_Math=require("../common/Math"),_styled=require("./styled"),_utils2=require("./utils"),_slider_public_size=require("./slider_public_size"),_styledConfig=require("./styledConfig"),_reactDom=require("react-dom"),_objectUtils=require("@lugia/object-utils"),_themeHoc=require("@lugia/theme-hoc"),_icon=require("../icon"),_icon2=_interopRequireDefault(_icon);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Slider=function(){function e(){_classCallCheck(this,e);var f=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return f.sliderHeight=_slider_public_size.rangeHeightNormal,f.mousedown=function(e){var t=e=e||window.event,r=t.pageX,a=t.pageY,n=f.props.vertical,i=f.getOffset(n),o=i.offsetLeft,s=i.offsetTop;f.offsetLeft=o,f.offsetTop=s;var l=f.getNewIndex(r,a).index,u=f.state,d=u.value,c=u.isInBall;f.oldValue=[].concat(_toConsumableArray(d));var h=f.props.disabled;f.pageX=r,f.pageY=a,h||(setTimeout(function(){return f.draging=c},0),c||f.publicmove(r,a,l,e),f.ballIndex=l,f.setState({changeBackground:!0}))},f.publicmove=function(e,t,r,a){var n=f.state,i=n.marksKeys,o=n.value,s=f.getMoveState(e,t).moveValue;o&&1===o.length&&(r=0);var l=f.getMarkValue(i,s).markValue;o[r]=0<i.length?l:s,f.setState({value:o,changeValue:o,moveValue:s,index:r,changeBackground:!0},function(){f.onchange(a)})},f.mouseup=function(e){f.props.disabled||(f.setState({changeBackground:!1}),f.onchange(e))},f.mouseenter=function(t){return function(){var e=!0;f.props.disabled&&(e=!1),f.setState({index:t,changeBackground:e,isInBall:!0})}},f.mouseleave=function(){f.setState({changeBackground:!1,isInBall:!1})},f.getMoveState=function(e,t){var r=f.state,a=r.maxValue,n=r.minValue,i=f.offsetLeft,o=f.offsetTop,s=f.style.rangeW,l=f.props.vertical,u=e-i;void 0!==l&&l&&(u=s-(t-o));var d=u/s*(a-n);return{moveValue:d=Number((d+n).toFixed(2))}},f.getNewIndex=function(e,t){var r=f.state.value,a=f.getMoveState(e,t).moveValue,n=0;Array.isArray(r)&&2===r.length&&(r[0]+r[1])/2<a&&(n=1);return{index:n}},f.getMarkValue=function(e,t){var r=0;if(0<e.length){var a=e[0],n=Math.abs(a-t);r=a;for(var i=1;i<e.length;i++){var o=e[i],s=Math.abs(o-t);s<n&&(n=s,r=o)}}return{markValue:r}},f.getSliderFatherWidth=function(e){if(f.SliderBigBox.current&&f.SliderBigBox.current.parentNode){var t=f.SliderBigBox.current.parentNode,r=t.offsetWidth,a=void 0===r?0:r,n=t.offsetHeight,i=void 0===n?0:n;f.sliderFatherWidth=e?i:a}},f.addDocListener=function(){document.addEventListener("mousemove",f.onDocMouseMove),document.addEventListener("mouseup",f.onDocMouseUp)},f.onDocMouseMove=function(e){if(f.draging){var t=e=e||window.event,r=t.pageX,a=t.pageY;if(f.pageX===r&&f.pageY===a)return;f.publicmove(r,a,f.ballIndex,e)}},f.onDocMouseUp=function(e){f.draging&&(f.onchange(e),f.draging=!1),f.state.changeBackground&&f.setState({changeBackground:!1})},f.getStyleForFalseElement=function(e,t,r){return window.getComputedStyle(e,":"+t)[r]},f.getDotSize=function(e,t){if(!t)return{dotWidths:[],dotHeights:[]};for(var r=t.length,a=[],n=[],i=(f.sliderHeight,0);i<r;i++){if("mask"===t[i].getAttribute("data-sign")){var o=f.getStyleForFalseElement(t[i],"before","width"),s=f.getStyleForFalseElement(t[i],"before","height"),l=f.getStyleForFalseElement(t[i],"before","right"),u=f.getStyleForFalseElement(t[i],"before","bottom"),d=e?Math.abs(parseFloat(l)):0,c=e?0:Math.abs(parseFloat(u)),h=e?d:parseFloat(o)+d,g=e?parseFloat(s)+c:c;a.push(h),n.push(g)}}return{dotWidths:a,dotHeights:n}},f.getMoveValue=function(e,t){var r=f.state,a=r.maxValue,n=r.minValue,i=f.style.rangeW;return{btnMove:(e/(a-n)*i-t/2)/i*100}},f.getLevePadding=function(e,t,r,a){var n=t&&0<t.length&&r&&0<r.length,i=a,o=a,s=(n?e?r[0]:t[0]:0)/2,l=(n?e?r[r.length-1]:t[t.length-1]:0)/2;return a<s&&(i=s),a<l&&(o=e?s:l),[i,o]},f.sliderRange=_react2.default.createRef(),f.SliderBigBox=_react2.default.createRef(),f.offsetLeft=0,f.offsetTop=0,f.sliderFatherWidth=0,f.iconsDistance=[0,0],f}return _inherits(e,_react.Component),_createClass(e,[{key:"getItem",value:function(e,t,r){var a=t&&r[t[0]],n=t&&r[t[1]];return 2===e?[a,n]:a}},{key:"getNewValue",value:function(e,t,r){var a=e?t&&t[0]:t;return r&&(a=e?t:t&&t.join(",")),a}},{key:"onchange",value:function(e){var t=this.props.onChange,r=this.state,a=r.marks,n=r.marksKeys,i=r.changeValue,o=this.oldValue,s=i.sort(_Math.sortable),l=o&&o.sort(_Math.sortable),u=s.length,d=1===u,c={oldValue:this.getNewValue(d,o),newValue:this.getNewValue(d,i),event:e};this.getNewValue(d,s,"join")!==this.getNewValue(d,o,"join")&&(0<n.length&&(c.newItem=this.getItem(u,i,a),c.oldItem=this.getItem(u,l,a)),t&&t(c))}},{key:"componentDidMount",value:function(){var a=this;this.addDocListener();var e=this.props,t=e.disabled,r=e.vertical,n=void 0!==r&&r,i=this.getOffset(n),o=i.dotWidths,s=i.dotHeights;this.setState({dotWidths:o,dotHeights:s},function(){var e=a.getOffset(n),t=e.offsetLeft,r=e.offsetTop;a.offsetLeft=t,a.offsetTop=r}),t&&(this.mousedown=null),this.getSliderFatherWidth(n)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("mousemove",this.onDocMouseMove),document.removeEventListener("mouseup",this.onDocMouseUp)}},{key:"getOffset",value:function(e){var t=(0,_reactDom.findDOMNode)(this.sliderRange);if(!t)return{offsetLeft:0,offsetTop:0,dotWidths:[],dotHeights:[]};var r=this.getDotSize(e,t.children),a=r.dotWidths,n=r.dotHeights,i=(0,_utils.getElementPosition)(t);return{offsetLeft:i.x,offsetTop:i.y,dotWidths:a,dotHeights:n}}},{key:"getSliderVerticalPaddings",value:function(e,t,r,a,n,i){var o=Math.max.apply(Math,_toConsumableArray(a).concat([r]))-t,s=0<o?o/2:0,l=s;return n&&0<n.length&&i&&0<i.length&&(l=e?Math.max.apply(Math,_toConsumableArray(n).concat([s])):Math.max.apply(Math,_toConsumableArray(i).concat([s]))),[s,l]}},{key:"getSliderLevelPaddings",value:function(S,e,V,k,t,P,x){var w=this,r="icons"in this.props,C=[],T=_slider_public_size.iconStyles.fontSizeNormal,D=_slider_public_size.iconStyles.marginNormal,B=t/2,I=r?D+T+B:B,W=this.getLevePadding(S,P,x,I),E=r?[T,T]:[0,0];return r&&1===V.length&&Array.isArray(e)&&0<e.length&&e.forEach(function(e,t){var r=1<t?1:t,a=e.style,n=I,i=T;if(a){var o=a.fontSize,s=a.margin,l=void 0===s?D:s;i=0<o&&o<12?12:o,n=parseInt(o)+parseInt(l)+B;var u=(E[r]=o)?D+o+B:B,d=w.getLevePadding(S,P,x,u);W[r]=d[r]}var c=w.props.getPartOfThemeHocProps("Icons"),h=c.viewClass,g=c.theme,f=w.props.getPartOfThemeProps("Icons"),p=f.themeConfig.normal,m=(p=void 0===p?{}:p).font,v=(m=void 0===m?{}:m).size,_=p.fontSize,b=_||v;b&&(i=b,n=(E[r]=b)+10,S||(W[r]=W[r]>b?W[r]:b+10),S&&(W[r]=b+10));var y=Object.assign({},e,{fontSize:i,iconDistancen:n,index:r}),M=(0,_objectUtils.deepMerge)(_defineProperty({},h,{normal:{color:"#666",fontSize:_}}),g);C.push(_react2.default.createElement(_styled.Icons,Object.assign({iconStyle:y,value:V},k,{themeProps:f}),_react2.default.createElement(_icon2.default,{iconClass:e.name,viewClass:h,theme:M,singleTheme:!0})))}),{iconsChildren:C,levelPaddings:W,iconSize:E}}},{key:"render",value:function(){var i=this,e=this.props,t=e.background,r=e.tips,o=void 0!==r&&r,a=e.icons,n=e.vertical,s=void 0!==n&&n,l=e.disabled,u=e.getTheme,d=(0,_styledConfig.getThemeProps)(this.props,this.sliderFatherWidth,this.iconsDistance),c=d.sliderTipsThemeProps,h=d.sliderContainerThemeProps,g=d.sliderPassedWayThemeProps.sliderPassedWayThemeProps,f=d.buttonThemeProps,p=f.sliderButtonThemeProps,m=f.width,v=f.height,_=d.sliderTrackThemeProps,b=_.sliderTrackThemeProps,y=_.width,M=_.height;this.sliderHeight=M;var S=this.state,V=S.value,k=S.index,P=S.moveValue,x=S.minValue,w=S.maxValue,C=S.marksKeys,T=S.marks,D=S.isInBall,B=S.dotWidths,I=S.dotHeights,W={minValue:x,maxValue:w,vertical:s},E=this.getSliderLevelPaddings(s,a,V,W,0<m-M?m:0,B,I),j=E.iconsChildren,O=E.levelPaddings,F=E.iconSize,L=y,H=M;function A(e){var t=V.length,r=2===t?Math.abs(V[0]-V[1]):V[0]-x;return"left"===e&&(r=2===t?Math.min.apply(Math,_toConsumableArray(V))-x:0),r/(w-x)*100}this.iconsDistance=O,this.style={background:t,btnWidth:parseInt(m),btnHeight:parseInt(v),rangeW:parseInt(L),rangeH:parseInt(H),SliderInnerWidth:0,SliderInnerLeft:0},this.style.SliderInnerWidth=A("width"),this.style.SliderInnerLeft=A("left");var z=[];if(0<C.length)for(var N=this.props.getPartOfThemeProps,q=0;q<C.length;q++){var U=C[q],R=U-x,X=this.getMoveValue(R,this.style.rangeH).btnMove,Y={marks:T[U],dotMoveX:X,dotIndex:U,minValue:x,maxValue:w,value:V,moveValue:P,vertical:s,rangeW:this.style.rangeW,rangeH:this.style.rangeH},K=N("SliderMarks",{selector:{index:q,count:C.length}});z.push(_react2.default.createElement(_styled.Dot,{"data-sign":"mask",key:U,themeProps:(0,_objectUtils.deepMerge)(K,{propsConfig:{marksData:Y}})}))}var G=this.mousedown,J=this.mouseup,Q=this.mouseenter,Z=this.mouseleave,$=o&&(this.draging||D),ee=Object.assign({},this.style,this.state,{disabled:l,vertical:s,btnDisabled:!0,middleVal:0}),te=V.map(function(e,t){var r=e-x;ee.moveX=i.getMoveValue(r,ee.btnWidth).btnMove,s&&(ee.moveY=i.getMoveValue(r,m).btnMove);var a=k===t;ee.btnDisabled=a;var n=!o||"string"!=typeof o&&"number"!=typeof o?e:o;return _react2.default.createElement(_styled.Button,Object.assign({themeProps:(0,_objectUtils.deepMerge)(p,{propsConfig:{vertical:s,moveX:ee.moveX,moveY:ee.moveY,btnDisabled:ee.btnDisabled,changeBackground:i.state.changeBackground}}),onMouseDown:G,onMouseUp:J,onMouseEnter:Q(t),onMouseLeave:Z},ee,{key:t}),$&&a&&!i.props.disabled?_react2.default.createElement(_styled.Tips,{themeProps:c},_react2.default.createElement(_styled.Tipinner,{themeProps:(0,_objectUtils.deepMerge)(c,{propsConfig:{tipsText:n}})})):"")}),re=this.getSliderVerticalPaddings(s,H,v,F,B,I);return _react2.default.createElement(_styled.SliderBigBox,{themeProps:h,onMouseDown:G,onMouseUp:J,ref:this.SliderBigBox},_react2.default.createElement(_styled.SliderBox,Object.assign({},ee,{iconSize:F,levelPaddings:O,sliderVerticalPaddings:re,onMouseDown:G,onMouseUp:J},(0,_themeHoc.addMouseEvent)(this)),_react2.default.createElement(_styled.SliderWrapper,Object.assign({themeProps:b,ref:function(e){i.sliderRange=e}},ee,{getTheme:u}),j,z,_react2.default.createElement(_styled.SliderInner,{themeProps:(0,_objectUtils.deepMerge)(g,{propsConfig:ee}),getTheme:u}),te)))}}],[{key:"getDerivedStateFromProps",value:function(e,t){var r=e.minValue,a=void 0===r?0:r,n=e.maxValue,i=void 0===n?30:n,o=e.marks,s=void 0===o?{}:o,l=e.defaultValue,u=void 0===l?0:l,d=e.disabled,c=void 0!==d&&d,h=e.value,g="marks"in e,f="minValue"in e,p="maxValue"in e;h="value"in e?h:t?t.value:u,i<a&&(i=a);var m=[],v=Object.assign({},s);if(g){for(var _ in s)m.push(Number(_));var b=(0,_Math.getMinAndMax)(m),y=b.max,M=b.min;f||(a=M),p||(i=y),m.unshift(a),m.push(i),(m=(0,_Math.limitToSet)(m,[a,i])).forEach(function(e){var t=s[e];v[e]=t||e.toString()})}var S=[a,i];if(Array.isArray(h)||(h=null==h?[a]:[h]),Array.isArray(h)){var V=h.length;h[0]=(0,_Math.limit)(h[0],S),2===V&&(h[1]=(0,_Math.limit)(h[1],S))}var k=h.slice(0,2);return t?{value:k,changeValue:t&&(0,_utils2.getChangeValue)(t.changeValue,a,i)}:{changeBackground:!1,moveX:0,moveY:0,value:k,changeValue:h,disabled:c,index:0,moveValue:0,marksKeys:m,minValue:parseFloat(a),maxValue:parseFloat(i),marks:v,isInBall:!1,dotWidths:[]}}}]),e}();Slider.displayName="SliderComponent",exports.default=Slider;