"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}();exports.getNewValueOrOldValue=getNewValueOrOldValue,require("../common/shirm");var _react=require("react"),React=_interopRequireWildcard(_react),_theme=require("../theme"),_theme2=_interopRequireDefault(_theme),_inputtag=require("../inputtag"),_inputtag2=_interopRequireDefault(_inputtag),_trigger=require("../trigger"),_trigger2=_interopRequireDefault(_trigger),_menu=require("../menu"),_menu2=_interopRequireDefault(_menu),_index=require("../consts/index"),_index2=_interopRequireDefault(_index),_QueryInput=require("../common/QueryInput"),_QueryInput2=_interopRequireDefault(_QueryInput),_objectUtils=require("@lugia/object-utils"),_translateData=require("../common/translateData"),_props5=require("../consts/props"),_selectFunction=require("../common/selectFunction"),_StringUtils=require("../common/StringUtils"),_themeHoc=require("@lugia/theme-hoc"),_themeHoc2=_interopRequireDefault(_themeHoc);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function getNewValueOrOldValue(e,t){return t?e:e[0]}var ScrollerStep=30;function getQuery(e,t){return e||0===e||"0"===e?e.toString():t||""}var Select=function(){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));_initialiseProps.call(t),t.menuVisible=!1;var a=(0,_translateData.getValueAndDisplayValue)(e,null),n=a.displayValue,l=a.value;return(0,_translateData.updateMapData)(e,n,t.updateMapData),t.displayValue=n,t.displayValue||t.updateDisplayValue(l),t.inputTag=React.createRef(),t}return _inherits(i,React.Component),_createClass(i,[{key:"updateDisplayValue",value:function(e){var t=this.props.displayField,a=void 0===t?_props5.DisplayField:t;this.displayValue=(0,_translateData.getDisplayValue)(e,{cancelItemData:this.cancelItemData,dataItem:this.dataItem,displayField:a})}},{key:"shouldComponentUpdate",value:function(e,t){var a=this.props,n={props:{displayValue:a.displayValue,value:a.value,data:a.data},state:{dataLength:this.state.length}},l=(0,_translateData.didUpdate)(e,t,n,function(e,t){return t.displayValue},this.updateMapData);return this.displayValue=t.displayValue,l&&!this.displayValue&&this.updateDisplayValue(t.value),l}},{key:"isLimit",value:function(){var e=this.state.value,t=this.getLimitCount();return e.length>=t}},{key:"render",value:function(){return this.fetchRenderItems()}},{key:"getInChecked",value:function(e){return-1!==this.state.value.indexOf(e)}},{key:"fetchRenderItems",value:function(){var t=this,e=this.props,a=this.state,n=e.disabled,l=e.validateStatus,i=e.placeholder,u=e.mutliple,r=e.canSearch,s=e.canInput,o=e.createPortal,p=e.prefix,c=e.suffix,d=e.data,h=e.canClear,g=e.pullIconClass,y=e.clearIconClass,f=e.isShowClearButton,m=this.displayValue,v=void 0===m?[]:m,_=a.value,C=void 0===_?[]:_,V=a.query,I=a.isCheckedAll,b=[d&&0!==d.length?React.createElement(_QueryInput2.default,{query:V,onQueryInputChange:this.onQueryInputChange,onQueryInputKeyDown:this.onQueryInputKeyDown,refreshValue:this.refreshValue,addClick:this.addClick,isCheckedAll:I,onCheckAll:this.onCheckAll,canSearch:r,mutliple:u,canInput:s}):null,this.getMenuItems(function(e){t.menuCmp=e})];return React.createElement(_theme2.default,{config:this.getInputtagTheme()},React.createElement(_trigger2.default,{themePass:!0,popup:b,key:"trigger",offsetY:4,ref:function(e){t.menuTriger=e},createPortal:o,action:n?[]:["click"],hideAction:["click"],onPopupVisibleChange:this.onMenuPopupVisibleChange},React.createElement(_inputtag2.default,{ref:this.inputTag,prefix:p,suffix:c,key:"inputtag",canClear:h,value:C,displayValue:v,validateStatus:l,onChange:this.onInputTagChange,onPopupVisibleChange:this.onInputTagPopupVisibleChange,disabled:n,createPortal:o,placeholder:i,mutliple:(0,_selectFunction.isMutliple)(e),onClear:this.onClear,pullIconClass:g,clearIconClass:y,isShowClearButton:f})))}},{key:"getMenuItems",value:function(e){var t=this.state,a=this.props,n=t.value,l=t.query,i=t.data,u=a.displayField,r=a.valueField,s=a.limitCount,o=a.searchType,p=a.divided,c=a.autoHeight,d=a.defaultHeight,h=this.updateMenuData(i,l,o);return React.createElement(_menu2.default,Object.assign({},this.getMenuTheme(),{displayField:u,valueField:r,data:h,divided:p,defaultHeight:d,mutliple:(0,_selectFunction.isMutliple)(a),selectedKeys:[].concat(_toConsumableArray(n)),ref:e,limitCount:s,onClick:this.menuItemClickHandler,step:ScrollerStep,autoHeight:c}))}},{key:"getItem",value:function(e,t){var a={updateHanlder:this.updateMapData,needUpdate:this.needUpdate,getMapData:this.getMapData},n=this.props,l={props:{displayField:n.displayField,children:n.children,data:n.data,valueField:n.valueField,value:n.value,defaultValue:n.defaultValue},state:{displayValue:this.displayValue}};return(0,_translateData.getItems)(e,t,l,a)}},{key:"getSingleItemDisplayValue",value:function(e){var t=e[this.props.displayField];return null==t?"":t}},{key:"getCurrentRow",value:function(e){this.setState({query:e})}},{key:"updateMenuData",value:function(e,t,a){var n=2<arguments.length&&void 0!==a?a:"include",l=this.props.displayField,i=void 0===l?_props5.DisplayField:l,u=void 0;if((""===t||!t)&&!(0===t||"0"===t))u=e;else{for(var r=this.getQueryArray(t),s=[],o=e.length,p=0;p<o;p++){var c=e[p],d=c[i];(0,_StringUtils.toMatchFromType)(d,r,n)&&s.push(c)}u=s.length===o?e:s.reverse()}return u}},{key:"getQueryArray",value:function(e){var t=this.props.splitQuery;return t?e.toString().split(t):[e.toString()]}},{key:"appendValue",value:function(){var e=this.props,t=this.state,a=this.displayValue,n=t.query,l=t.value;if(n&&n.trim()&&(0,_selectFunction.isCanInput)(e)&&!this.isLimit()){clearTimeout(this.queryHandle);var i=(0,_selectFunction.appendCustomValue)(e,n,l,a),u=i.newValue,r=i.newDisplayValue,s=[].concat(_toConsumableArray(u)),o=[].concat(_toConsumableArray(r));this.setValue(s,o,{}),this.onQueryInputChange({newValue:""}),this.onChangeHandle({value:s,displayValue:o})}}},{key:"setPopupVisible",value:function(){var e;this.menuTriger&&(e=this.menuTriger).setPopupVisible.apply(e,arguments)}},{key:"setValue",value:function(e,t,a,n){var l=3<arguments.length&&void 0!==n?n:function(){},i="value"in this.props,u=(0,_selectFunction.setNewValue)(e,t),r=u.realyVal,s=u.realDisp,o=this.getIsCheckedAll(r);i?this.setState(Object.assign({},a)):this.setState(Object.assign({value:r,displayValue:s},a,{isCheckedAll:o}),l)}},{key:"setSelectMenuPopupVisible",value:function(e){this.menuTriger&&this.menuTriger.getThemeTarget()&&this.menuTriger.getThemeTarget().setPopupVisible(e)}},{key:"onChangeHandle",value:function(e){var t=this.props,a=t.onChange,n=t.onSelect,l=t.mutliple,i=e.value,u=e.displayValue,r=e.event,s=void 0===r?null:r,o=this.getIsCheckedAll(i),p=this.state.value,c=void 0===p?[]:p,d=getNewValueOrOldValue(i,l),h=getNewValueOrOldValue(u,l),g=getNewValueOrOldValue(c,l),y=this.getItem(c,!1).items,f=this.getItem(i,!1).items;y=l?y:y[0];var m={newValue:d,oldValue:g,newItem:f=l?f:f[0],oldItem:y,newDisplayValue:h,event:s};this.setState({isCheckedAll:o}),a&&a(m),n&&n(m)}},{key:"getIsCheckedAll",value:function(e){return this.getLimitCount()===e.length}},{key:"componentDidMount",value:function(){var t=this;setTimeout(function(){var e=t.inputTag.current.getThemeTarget().container.offsetWidth;t.setState({menuWidth:e})},0)}}],[{key:"getDerivedStateFromProps",value:function(e,t){var a=e.data,n=void 0===a?[]:a,l=e.validateStatus,i=void 0===l?"success":l,u=e.query,r=n.length,s=(0,_translateData.getValueAndDisplayValue)(e,t),o=s.value,p=s.displayValue,c=o||[];return t?{value:c,displayValue:p,data:n,length:r,query:getQuery(u,t.query),validateStatus:i}:{value:c,displayValue:p,data:n,length:r,query:getQuery(u),validateStatus:i,isCheckedAll:!1}}}]),i}();Select.defaultProps={getTheme:function(){return{}},mutliple:!1,canInput:!1,createPortal:!0,displayField:_props5.DisplayField,valueField:_props5.ValueField,mode:"local",throttle:100,disabled:!1,validateStatus:"success",canSearch:!1,autoHeight:!1,splitQuery:",",searchType:"include",query:"",pullIconClass:"lugia-icon-direction_down",clearIconClass:"lugia-icon-reminder_close",isShowClearButton:!0},Select.displayName=_index2.default.Select;var _initialiseProps=function(){var v=this;this.updateMapData=function(e){var t=e.cancelItem,a=e.cancelItemData,n=e.dataItem;v.cancelItem=t,v.cancelItemData=a,v.dataItem=n},this.getMapData=function(){return{cancelItem:v.cancelItem,dataItem:v.dataItem,cancelItemData:v.cancelItemData}},this.dataHasItem=function(e){return e in v.dataItem},this.cancelHasItem=function(e){return e in v.cancelItemData},this.needUpdate=function(e){return!v.dataHasItem(e)&&!v.cancelHasItem(e)},this.addClick=function(){v.appendValue()},this.refreshValue=function(e){var t=v.props.onRefresh;v.onQueryInputChange({newValue:""});var a=[],n=[];v.setValue(a,n,{query:""}),v.onChangeHandle({value:a,displayValue:n,event:e}),t&&t()},this.getLimitCount=function(){var e=v.props.limitCount,t=v.state.length+v.cancelItem.length;return e&&t<e?t:e||t},this.onCheckAll=function(e){var t=v.state,a=t.data,n=t.isCheckedAll,l=t.length,i=t.value,u=v.displayValue,r=v.getLimitCount();if(n)v.setValue([],[],{}),v.onChangeHandle({value:[],displayValue:[],event:e});else{var s=[],o=[],p=v.props,c=p.valueField,d=p.displayField;if(0<=r)for(var h=r-i.length,g=0;g<l;g++){var y=a[g];if(!v.getInChecked(y[c])){if(s.length>=h)break;s.push(y[c]),o.push(y[d])}}else for(var f=0;f<l;f++){var m=a[f];s.push(m[c]),o.push(m[d])}s=[].concat(_toConsumableArray(i),_toConsumableArray(s)),o=[].concat(_toConsumableArray(u),_toConsumableArray(o)),v.setValue(s,o,{}),v.onChangeHandle({value:s,displayValue:o,event:e})}},this.getContainerWidth=function(){return v.state.menuWidth},this.menuItemClickHandler=function(e,t){var a=v.props,n=t.selectedKeys,l=v.getItem(n,!0).displayValue,i=void 0===l?[]:l;if((0,_selectFunction.isMutliple)(a))v.setValue(n,i,{}),v.onChangeHandle({value:n,displayValue:i,event:e});else{var u=n,r=v.getSingleItemDisplayValue(v.dataItem[u]);v.onChangeHandle({value:u,displayValue:i,event:e}),v.setSelectMenuPopupVisible(!1),"value"in a||v.setState({value:u,displayValue:[r]})}},this.onQueryInputChange=function(e){var a=v.props,t=v.state,n=e.newValue,l=n||"";if(l!==t.query){v.queryHandle&&clearTimeout(v.queryHandle),v.setState({query:l});var i=function(){var e=a.onQuery,t=a.mode;"local"===(void 0===t?"local":t)&&v.getCurrentRow(l),e&&e(l)},u=a.throttle,r=void 0===u?-1:u;0<r?v.queryHandle=setTimeout(i,r):i()}},this.onQueryInputKeyDown=function(e){13===e.keyCode&&v.appendValue()},this.onClear=function(e){var t=v.props.onClear;t&&t(e)},this.onInputTagChange=function(e){var t=e.value,a=e.displayValue;v.setValue(t,a,{}),v.onChangeHandle({value:t,displayValue:a})},this.onMenuPopupVisibleChange=function(e){if(e){var t=v.props.onTrigger;t&&t(e),v.onQueryInputChange({newValue:""})}v.menuVisible=e},this.onInputTagPopupVisibleChange=function(e){e&&v.setSelectMenuPopupVisible(!1)},this.mergeTheme=function(e,t){var a=v.props.getPartOfThemeHocProps(e),n=a.viewClass,l=a.theme;return{viewClass:n,theme:(0,_objectUtils.deepMerge)(_defineProperty({},n,Object.assign({},t)),l)}},this.getInputtagTheme=function(){var e=v.props.getPartOfThemeConfig;return _defineProperty({},_index2.default.InputTag,{InputTagWrap:e("Container"),TagWrap:e("TagWrap"),TagIcon:e("TagIcon"),SwitchIcon:e("SwitchIcon"),ClearIcon:e("ClearIcon"),Placeholder:e("Placeholder"),Menu:e("InputMenu")})},this.getMenuTheme=function(){var e={Container:{normal:{width:v.getContainerWidth()}}};return v.mergeTheme("Menu",e)}};exports.default=(0,_themeHoc2.default)(Select,_index2.default.Select,{hover:!0});