"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_table=require("./table"),_table2=_interopRequireDefault(_table),_themeProvider=require("../theme-provider"),_themeProvider2=_interopRequireDefault(_themeProvider),_EditInput=require("./EditInput"),_EditInput2=_interopRequireDefault(_EditInput),_editTableCss=require("./editTableCss"),_connection=require("./connection"),_connection2=_interopRequireDefault(_connection),_consts=require("../consts"),_consts2=_interopRequireDefault(_consts),_reactDom=require("react-dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var EditTable=function(){function o(e){_classCallCheck(this,o);var t=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));_initialiseProps.call(t);var n=e.columns,i=e.data,r=void 0===i?[]:i;return t.editTableListener=new _connection2.default,t.state={selectCell:[],editCell:{},editing:!1},t.editTableListener.emit("updateDataKeyMap",{columns:n,data:r}),t.moveCellsListener=t.editTableListener.on("moveCells",function(e){t.doMoveCells(e)}),t.quitEditListener=t.editTableListener.on("quitEdit",function(e){t.quitEdit(e)}),t.enterEditingListener=t.editTableListener.on("enterEditing",function(){t.doEnterEditing()}),t.setStateListener=t.editTableListener.on("setState",function(e){t.doSetState(e)}),t.exportOnCellListener=t.editTableListener.on("exportOnCell",function(e){t.exportOnCell(e)}),t}return _inherits(o,_react2.default.Component),_createClass(o,[{key:"shouldComponentUpdate",value:function(e,t){var n=this.props,i=n.data,r=n.columns,o=e.data,l=e.columns,a=this.editTableListener.isEqualArray;return(!a(i,o)||!a(r,l))&&this.editTableListener.emit("updateDataKeyMap",{columns:l,data:o}),!0}},{key:"componentDidMount",value:function(){var e=(0,_reactDom.findDOMNode)(this.Table.getThemeTarget())===document.activeElement;window.addEventListener("keydown",this.editTableListener.keyDownHandler({isInTarget:e})),window.addEventListener("keyup",this.editTableListener.keyUpHandler)}},{key:"render",value:function(){var t=this,e=this.props,n=e.data,i=void 0===n?[]:n,r=e.columns,o=void 0===r?[]:r,l=this.editTableListener,a=l.restColumnsIntoData,s=l.getThemeForTable,d=l.restColumnsWithRender,u=a(o).concat(i),c=d(o,this.renderFunc),p=this.props,f={tableSize:p.tableSize,tableStyle:p.tableStyle},m=this.props.getPartOfThemeProps("Container"),b=s(this.props.getPartOfThemeHocProps("Table"),{Td:{normal:{padding:{left:0,right:0}}}});return _react2.default.createElement(_editTableCss.Container,{themeProps:m},_react2.default.createElement(_table2.default,Object.assign({ref:function(e){return t.Table=e}},b,{data:u,columns:c},f,{showHeader:!1})))}},{key:"componentWillUnmount",value:function(){window.removeEventListener("keydown",this.editTableListener.keyDownHandler),window.removeEventListener("keyup",this.editTableListener.keyUpHandler),this.moveCellsListener.removeListener(),this.quitEditListener.removeListener(),this.enterEditingListener.removeListener(),this.setStateListener.removeListener(),this.exportOnCellListener.removeListener()}}]),o}(),_initialiseProps=function(){var g=this;this.renderFunc=function(e){var t=e.text,n=e.record,i=e.dataIndex,r=e.index,o=g.editTableListener,l=o.getSelectColumnMark,a=o.isSelected,s=o.isEditCell,d=l(i),u="object"===(void 0===t?"undefined":_typeof(t))||!t&&0!==t?"":n[t]||t,c=n.isHead,p=r,f=g.state,m=f.editing,b=f.selectCell,_=!m&&a({selectColumn:d,selectRow:p},void 0===b?[]:b),h=!!g.props.isEditHead||0!==p,C=g.state.editCell,v=h&&m&&s({selectColumn:d,selectRow:p},C),E=Object.assign({defaultText:u,isSelect:_,isHead:c,enterEdit:v,selectColumn:d,selectRow:p},e);return g.getRenderTarget(E)},this.getRenderTarget=function(e){var t=e.defaultText,n=e.isSelect,i=e.isHead,r=e.enterEdit,o=e.customEditElement,l=e.editType,a=e.selectData,s=e.align,d=o||_EditInput2.default,u=g.props.getPartOfThemeProps("EditTarget",{props:{isSelect:n,isHead:i,align:s}});if(r)return _react2.default.createElement(_editTableCss.EditDiv,{themeProps:u,className:"EditDiv"},_react2.default.createElement(d,{value:t,autoFocus:!0,type:l,listener:g.editTableListener,data:a}));var c=e.text,p=e.record,f=e.index,m=e.selectColumn,b=e.selectRow,_=e.customRender,h=g.props,C=h.selectSuffixElement,v=h.isEditHead,E=g.state.selectCell,T=g.editTableListener,y=(T=void 0===T?{}:T).onCellClick;return _react2.default.createElement(_editTableCss.EditDiv,{themeProps:u,isSelect:n,isHead:i,onClick:function(e){return y({e:e,selectColumn:m,selectRow:b,selectCell:E,isEditHead:v,isHead:i})}},_&&!i?_(c,p,f):t.toString(),n&&C?_react2.default.createElement(_editTableCss.InnerTriggerDiv,null,C):null)},this.quitEdit=function(e){var t=e.oldValue,n=e.newValue;if(t!==n){var i=g.state,r=i.editCell,o=i.editing,l=g.props,a=l.data,s=l.columns,d=g.editTableListener.setInputChangedValue({value:n,editCell:r,data:a,columns:s,editing:o});if(d){var u=d.data;g.exportChange({columns:s,data:u})}}g.clearEditState()},this.clearEditState=function(){g.setState({editing:!1,editCell:{},selectCell:[]})},this.exportChange=function(e){var t=g.props.onChange;t&&t(e)},this.exportOnCell=function(e){var t=g.props,n=t.onCell,i=t.columns,r=g.editTableListener.resetSelectRow(Object.assign({},e,{columns:i}));n&&n(Object.assign({},r))},this.doSetState=function(e){g.setState(Object.assign({},e))},this.doMoveCells=function(e){var t=g.state.selectCell,n=g.props,i=n.data,r=n.columns,o=g.editTableListener,l=o.getMovedCells(Object.assign({selectCell:t,data:i,columns:r},e));l&&(o.emit("exportOnCell",{currentItem:l,newValue:[l],oldValue:t}),g.setState({selectCell:[l],editCell:l}))},this.doEnterEditing=function(){var e=g.props.isEditHead,t=g.state.editCell.selectRow;(e||t&&0!==t)&&g.setState({editing:!0})}};exports.default=(0,_themeProvider2.default)(EditTable,_consts2.default.EditTable);