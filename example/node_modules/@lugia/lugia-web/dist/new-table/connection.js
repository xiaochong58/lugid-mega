"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),_listener=require("@lugia/listener"),_listener2=_interopRequireDefault(_listener),_objectUtils=require("@lugia/object-utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var EditTableEventListener=function(){function e(){_classCallCheck(this,e);var v=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return v.onKeyDown=function(e){if(!v.isKeyBoardDown){v.isKeyBoardDown=!0;var t=e.key;if(e.shiftKey)return v.emit("shiftDown"),void v.emit("enterMultipleSelect");if(v.isCanMoveCells()){var n=void 0;switch(t){case"ArrowLeft":n="left";break;case"ArrowUp":n="top";break;case"Enter":n="backToBottom";break;case"ArrowDown":n="bottom";break;case"ArrowRight":case"Tab":n="right"}v.emit("moveCells",{directions:n,key:t}),"Tab"!==t&&"Enter"!==t&&v.emit("quiteMoveTrack")}}},v.onKeyUp=function(e){v.isKeyBoardDown=!1,"Shift"===e.key&&(v.emit("shiftUp"),v.emit("quitMultipleSelect"))},v.isMultiple=function(){return v.multipleSelect},v.isCanMoveCells=function(){return v.canMoveCells},v.isShiftDown=function(){return v.isShift},v.getMoveTrack=function(){return v.moveTrack},v.getClickNumber=function(){return v.clickNumber},v.setClickNumber=function(e){v.clickNumber=e},v.setUpdateDataKeyMap=function(e){v.dataKeyMap=v.getKeyMaps(e)},v.getKeyMaps=function(e){var t=e.columns,n=e.data,r={dataMap:{},columnsMap:{}};return n&&n.forEach(function(e,t){r.dataMap[t]=Object.assign({},e)}),t&&t.forEach(function(e,t){var n=e.dataIndex;r.columnsMap[n]=t}),r},v.getSelectColumnMark=function(e){return v.dataKeyMap.columnsMap[e]},v.getSelectDataMark=function(e){return v.dataKeyMap.dataMap[e]},v.restColumnsIntoData=function(e){if(!e||0===e.length)return[];var r={};return e.forEach(function(e){var t=e.title,n=e.dataIndex;r[n]=t,r.isHead=!0}),[r]},v.isSelectSameItem=function(e,t){if(!e||!t)return!1;var n=e.selectColumn,r=e.selectRow,o=t.selectColumn,i=t.selectRow;return o===n&&i===r},v.doStopPropagation=function(e,t){(e=e||window.event).stopPropagation?(e.stopPropagation(),t&&e.preventDefault()):e.cancelBubble=!0},v.keyDownHandler=function(o){return function(e){var t=o.isInTarget;v.doStopPropagation(e,t);var n=e.key,r=v.isMultiple();if(1===n.length&&!r)return v.emit("quitMoveCells"),void v.emit("enterEditing");v.onKeyDown(e)}},v.keyUpHandler=function(e){v.doStopPropagation(e),v.onKeyUp(e)},v.getThemeForTable=function(e,t){var n=e.theme,r=e.viewClass;return{theme:(0,_objectUtils.deepMerge)(_defineProperty({},r,t),n),viewClass:r}},v.restColumnsWithRender=function(e,o){if(!e)return[];var n=[];return e.forEach(function(e){var t=e.render,r=Object.assign({},e);t&&(r.customRender=t),r.render=function(e,t,n){return o(Object.assign({text:e,record:t,index:n},r))},n.push(r)}),n},v.isSelected=function(t,e){return!(!e||0===e.length)&&e.some(function(e){return v.isSelectSameItem(e,t)})},v.isEditCell=function(e,t){return!!t&&v.isSelectSameItem(t,e)},v.resetSelectRow=function(e){var t=e.currentItem,n=e.newValue,r=e.oldValue,o=e.columns,i=Object.assign({},t),a=v.resetSelectRowFromArray(n),l=v.resetSelectRowFromArray(r);return{currentItem:v.getCellItem({newItem:i,columns:o}),newValue:a,oldValue:l}},v.getCellItem=function(e){var t=e.newItem,n=void 0===t?{}:t,r=e.columns,o=n.selectColumn,i=n.selectRow;if(!o&&0!==o||!i&&0!==i)return{};var a=v.getSelectDataMark(i-1),l=r[o].dataIndex;return{currentCell:_defineProperty({},l,a[l]),record:a,cellIndex:v.resetItemName(n)}},v.resetSelectRowFromArray=function(e){return e&&0!==e.length?[].concat(_toConsumableArray(e)).map(function(e){return v.resetItemName(e)}):[]},v.resetItemName=function(e){var t={},n=e.selectColumn,r=e.selectRow;return t.rowIndex=r-1,t.columnIndex=n,t},v.getClearSingleSelectCell=function(t,e){var n=[];return e.forEach(function(e){v.isSelectSameItem(e,t)||n.push(e)}),n},v.getMovedCells=function(e){var t=e.directions,n=e.key,r=e.selectCell;if(r&&!(r.length<=0)){var o=r[0],i=o.selectColumn,a=o.selectRow;if((i||0===i)&&(a||0===a)){switch(t){case"left":i-=1;break;case"right":i+=1;break;case"top":a-=1;break;case"bottom":a+=1;break;case"backToBottom":var l=v.getMoveTrack();l&&0<l.length&&(i=l[0].selectColumn),a+=1}var c=e.data,u=void 0===c?[]:c,s=e.columns,f=void 0===s?[]:s,m=f.length&&f.length-1,p=u.length||0;return i=Math.max(Math.min(m,i),0),a=Math.max(Math.min(p,a),0),n&&"Tab"===n&&r&&v.emit("enterMoveTrack",r[0]),{selectColumn:i,selectRow:a}}}},v.setInputChangedValue=function(e){var t=e.value;if(e.editing){var n=e.editCell,r=(n=void 0===n?{}:n).selectColumn,o=n.selectRow,i=e.data,a=e.columns,l=null;a.forEach(function(e){var t=e.dataIndex;v.getSelectColumnMark(t)===r&&(l=t)});var c=JSON.parse(JSON.stringify(i));return c[o-1][l]=t,{data:c}}},v.onCellClick=function(c){var e=c.e,u=v.getClickNumber();v.doStopPropagation(e),u+=1,v.setClickNumber(u),setTimeout(function(){var e=c.selectColumn,t=c.selectRow,n=c.selectCell,r=void 0===n?[]:n,o={selectColumn:e,selectRow:t};if(1===u){var i=v.isSelected(o,r),a=[o],l=o;i&&(v.emit("quitMoveCells"),a=v.getClearSingleSelectCell(o,r),l={}),v.setClickNumber(0),v.emit("quiteMoveTrack"),v.emit("enterMoveTrack",o),v.isMultiple()&&!i?a=r.concat(a):v.emit("enterMoveCells"),v.emit("setState",{selectCell:a,editCell:l}),c.isHead||v.emit("exportOnCell",{currentItem:l,newValue:a,oldValue:r})}else 2===u&&(v.setClickNumber(0),v.emit("quitMoveCells"),v.emit("quiteMoveTrack"),v.emit("setState",{editing:!0,editCell:o}))},200)},v.isEqualArray=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},v.editing=!1,v.multipleSelect=!1,v.canMoveCells=!1,v.isShift=!1,v.isKeyBoardDown=!1,v.moveTrack=[],v.clickNumber=0,v.dataKeyMap={columnsMap:{},dataMap:{}},v.keyDownListener=v.on("keyDown",v.onKeyDown),v.enterMultipleSelect=v.on("enterMultipleSelect",function(){v.multipleSelect=!0}),v.quitMultipleSelect=v.on("quitMultipleSelect",function(){v.multipleSelect=!1}),v.enterMoveCells=v.on("enterMoveCells",function(){v.canMoveCells=!0}),v.quitMoveCells=v.on("quitMoveCells",function(){v.canMoveCells&&(v.canMoveCells=!1)}),v.shiftDown=v.on("shiftDown",function(){v.isShift=!0}),v.shiftUp=v.on("shiftUp",function(){v.isShift=!1}),v.enterMoveTrack=v.on("enterMoveTrack",function(e){v.moveTrack=v.moveTrack.concat([e])}),v.quiteMoveTrack=v.on("quiteMoveTrack",function(){v.moveTrack=[]}),v.enterUpdateDataKeyMap=v.on("updateDataKeyMap",function(e){v.setUpdateDataKeyMap(e)}),v}return _inherits(e,_listener2.default),_createClass(e,[{key:"componentWillUnmount",value:function(){this.keyDownListener.removeListener(),this.enterMultipleSelect.removeListener(),this.quitMultipleSelect.removeListener(),this.enterMoveCells.removeListener(),this.quitMoveCells.removeListener(),this.shiftDown.removeListener(),this.shiftUp.removeListener(),this.enterMoveTrack.removeListener(),this.quiteMoveTrack.removeListener(),this.enterUpdateDataKeyMap.removeListener()}}]),e}();exports.default=EditTableEventListener;